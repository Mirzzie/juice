---
- name: Configure EC2 for Thesis Experiment
  hosts: juiceshop
  become: true
  gather_facts: true

  vars:
    juice_shop_dir: /opt/juice-shop
    monitoring_dir: /opt/monitoring
    exporter_dir: /opt/security-metrics-exporter
    grafana_port: 3001
    prometheus_port: 9090
    otel_grpc_port: 4317
    otel_http_port: 4318
    juice_shop_version: "v16.0.0"

  tasks:
    # --- 0. SYSTEM TUNING (CRITICAL FIX FOR DOCKER BUILDS) ---
    - name: Check if swap file exists
      stat:
        path: /swapfile
      register: swap_file_check

    - name: Create 4GB Swap file (Prevents OOM Kills during build)
      command: fallocate -l 4G /swapfile
      when: not swap_file_check.stat.exists

    - name: Set permissions on swap file
      file:
        path: /swapfile
        mode: '0600'
      when: not swap_file_check.stat.exists

    - name: Make swap file
      command: mkswap /swapfile
      when: not swap_file_check.stat.exists

    - name: Enable swap file
      command: swapon /swapfile
      when: not swap_file_check.stat.exists

    - name: Persist swap in fstab
      mount:
        name: none
        src: /swapfile
        fstype: swap
        opts: sw
        state: present

    # --- 1. SYSTEM PREP ---
    - name: Update APT and install Docker deps
      apt:
        name: [curl, wget, git, unzip, jq, python3-pip, python3-venv, apache2-utils, python3-docker]
        update_cache: yes
        state: present

    - name: Install Docker
      shell: curl -fsSL https://get.docker.com | sh
      args:
        creates: /usr/bin/docker

    - name: Add ubuntu to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    # CRITICAL: Reset connection so group membership takes effect immediately
    - name: Reset SSH connection for group changes
      meta: reset_connection

    # --- 2. MONITORING DIRECTORIES ---
    - name: Create directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: ubuntu
      loop:
        - "{{ monitoring_dir }}/otel-collector"
        - "{{ monitoring_dir }}/prometheus"
        - "{{ monitoring_dir }}/grafana/provisioning/datasources"
        - "{{ monitoring_dir }}/grafana/provisioning/dashboards"
        - "{{ exporter_dir }}"
        - "/opt/security-metrics/data"

    # --- 3. CUSTOM METRICS EXPORTER ---
    - name: Copy Enhanced Metrics Exporter
      copy:
        src: files/enhanced_metrics_exporter_otel.py
        dest: "{{ exporter_dir }}/exporter.py"
        mode: '0755'

    - name: Exporter Dockerfile
      copy:
        dest: "{{ exporter_dir }}/Dockerfile"
        content: |
          FROM python:3.9-slim
          WORKDIR /app
          COPY exporter.py .
          RUN pip install prometheus_client docker
          CMD ["python", "exporter.py"]

    # --- 4. OBSERVABILITY CONFIGS ---
    - name: Configure Grafana Datasource
      copy:
        dest: "{{ monitoring_dir }}/grafana/provisioning/datasources/datasource.yaml"
        content: |
          apiVersion: 1
          datasources:
            - name: Prometheus
              type: prometheus
              access: proxy
              url: http://prometheus:9090
              isDefault: true

    - name: Configure Grafana Provider
      copy:
        dest: "{{ monitoring_dir }}/grafana/provisioning/dashboards/dashboard.yaml"
        content: |
          apiVersion: 1
          providers:
            - name: 'Thesis Results'
              orgId: 1
              folder: ''
              type: file
              options:
                path: /etc/grafana/provisioning/dashboards

    - name: Copy Thesis Dashboard JSON
      copy:
        src: files/grafana-three-scenario-dashboard.json
        dest: "{{ monitoring_dir }}/grafana/provisioning/dashboards/thesis_dashboard.json"
        mode: '0644'

    - name: Configure Prometheus
      copy:
        dest: "{{ monitoring_dir }}/prometheus/prometheus.yml"
        content: |
          global:
            scrape_interval: 2s 
          scrape_configs:
            - job_name: 'thesis-exporter'
              static_configs:
                - targets: ['metrics-exporter:9999']
            - job_name: 'otel-collector'
              static_configs:
                - targets: ['otel-collector:8889']

    - name: Configure Otel Collector
      copy:
        dest: "{{ monitoring_dir }}/otel-collector/otel-collector-config.yaml"
        content: |
          receivers:
            otlp:
              protocols:
                grpc:
                  endpoint: 0.0.0.0:4317
                http:
                  endpoint: 0.0.0.0:4318
          processors:
            batch:
          exporters:
            prometheus:
              endpoint: "0.0.0.0:8889"
              namespace: "juice_shop"
          service:
            pipelines:
              metrics:
                receivers: [otlp]
                processors: [batch]
                exporters: [prometheus]

    # --- 5. JUICE SHOP & AIKIDO SETUP ---
    - name: Clean Juice Shop Dir
      file:
        path: "{{ juice_shop_dir }}"
        state: absent

    - name: Create Juice Shop Dir
      file:
        path: "{{ juice_shop_dir }}"
        state: directory
        owner: ubuntu

    - name: Juice Shop Dockerfile
      copy:
        dest: "{{ juice_shop_dir }}/Dockerfile"
        content: |
          FROM node:20-bookworm-slim AS builder
          RUN apt-get update && apt-get install -y git python3 make g++ curl
          WORKDIR /juice-shop
          RUN git clone --depth 1 --branch {{ juice_shop_version }} https://github.com/juice-shop/juice-shop.git . && rm -rf .git
          RUN npm install
          
          # Install Aikido and OpenTelemetry
          RUN npm install --save-exact @aikidosec/firewall @opentelemetry/api @opentelemetry/auto-instrumentations-node @opentelemetry/exporter-metrics-otlp-grpc @opentelemetry/resources @opentelemetry/sdk-node
          
          # Inject Aikido Import at top of app.ts
          RUN sed -i "1i import '@aikidosec/firewall' // Aikido RASP" app.ts && \
              sed -i "1i import '@aikidosec/firewall' // Aikido RASP" server.ts
              
          RUN npm run build:server
          RUN cd frontend && npm install --legacy-peer-deps && node ./node_modules/@angular/cli/bin/ng build --configuration production
          
          FROM node:20-bookworm-slim
          WORKDIR /juice-shop
          COPY --from=builder /juice-shop .
          
          # OpenTelemetry Initialization Script
          RUN echo "const { NodeSDK } = require('@opentelemetry/sdk-node'); \
          const { getNodeAutoInstrumentations } = require('@opentelemetry/auto-instrumentations-node'); \
          const { OTLPMetricExporter } = require('@opentelemetry/exporter-metrics-otlp-grpc'); \
          const { PeriodicExportingMetricReader } = require('@opentelemetry/sdk-metrics'); \
          const metricExporter = new OTLPMetricExporter({url: process.env.OTEL_EXPORTER_OTLP_ENDPOINT}); \
          const metricReader = new PeriodicExportingMetricReader({exporter: metricExporter, exportIntervalMillis: 2000}); \
          const sdk = new NodeSDK({metricReader, instrumentations: [getNodeAutoInstrumentations()]}); \
          sdk.start();" > otel-init.js
          
          EXPOSE 3000
          ENV NODE_ENV=production
          CMD ["node", "--require", "./otel-init.js", "build/app"]

    - name: Create Docker Compose
      copy:
        dest: "{{ juice_shop_dir }}/docker-compose.yml"
        content: |
          services:
            juice-shop:
              build: .
              container_name: juice-shop
              ports: ["3000:3000"]
              environment:
                - NODE_ENV=production
                - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
                - AIKIDO_TOKEN={{ aikido_token }}
                - AIKIDO_BLOCK=${AIKIDO_BLOCK:-false} 
                - AIKIDO_DISABLE=${AIKIDO_DISABLE:-false}
                - DD_API_KEY={{ datadog_api_key }}
              depends_on: [otel-collector]
              networks: [thesis-net]

            metrics-exporter:
              build: {{ exporter_dir }}
              container_name: metrics-exporter
              volumes:
                - /opt/security-metrics/data:/opt/security-metrics/data
                # Mount docker socket for Log Telemetry
                - /var/run/docker.sock:/var/run/docker.sock
              ports: ["9999:9999"]
              networks: [thesis-net]

            otel-collector:
              image: otel/opentelemetry-collector-contrib:latest
              command: ["--config=/etc/otel-collector-config.yaml"]
              volumes:
                - {{ monitoring_dir }}/otel-collector/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
              ports: ["4317:4317", "4318:4318", "8889:8889"]
              networks: [thesis-net]

            prometheus:
              image: prom/prometheus:latest
              volumes:
                - {{ monitoring_dir }}/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
              ports: ["9090:9090"]
              networks: [thesis-net]

            grafana:
              image: grafana/grafana:latest
              volumes:
                - {{ monitoring_dir }}/grafana/provisioning:/etc/grafana/provisioning
              ports: ["{{ grafana_port }}:3000"]
              environment:
                - GF_SECURITY_ADMIN_PASSWORD=admin
              networks: [thesis-net]

          networks:
            thesis-net:
              driver: bridge

    # --- 6. CONTROL SCRIPTS ---
    - name: Create Scenario Switch Script
      copy:
        dest: "/home/ubuntu/run_scenario.sh"
        mode: '0755'
        owner: ubuntu
        content: |
          #!/bin/bash
          # EXIT ON ERROR so we know if it fails
          set -e
          
          MODE=$1
          cd /opt/juice-shop
          
          echo "ðŸ”¬ INITIALIZING SCENARIO: $MODE"
          
          # DEFAULT: Baseline (Scenario 1)
          export AIKIDO_DISABLE="true"
          export AIKIDO_BLOCK="false"
          SCENARIO_ID=1

          if [ "$MODE" == "detection" ]; then
             export AIKIDO_DISABLE="false"
             export AIKIDO_BLOCK="false"
             SCENARIO_ID=2
          elif [ "$MODE" == "blocking" ]; then
             export AIKIDO_DISABLE="false"
             export AIKIDO_BLOCK="true"
             SCENARIO_ID=3
          fi

          echo "{\"scenario_id\": $SCENARIO_ID, \"mode\": \"$MODE\"}" > /opt/security-metrics/data/scenario_info.json
          
          # Force build to ensure image exists
          echo "ðŸ—ï¸ Building containers..."
          docker compose up -d --build
          
          echo "âœ… Scenario $MODE Active. Waiting 10s for warm-up..."
          sleep 10

    # --- 7. PROJECT STARTUP ---
    - name: Launch Baseline Scenario (Build & Start Containers)
      # Redirect output to log file so we can see why it fails
      shell: "/home/ubuntu/run_scenario.sh baseline > /home/ubuntu/deployment.log 2>&1"
      async: 1200
      poll: 10