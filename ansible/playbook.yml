---
- name: Configure EC2 for Juice Shop with RASP vs IAST Benchmarking
  hosts: juiceshop
  become: true
  gather_facts: true

  vars:
    juice_shop_dir: /opt/juice-shop
    node_version: "22"
    benchmark_tools_dir: /opt/benchmark-tools

  vars_files:
    - secrets.yml

  tasks:
    # =======================================================================
    # SYSTEM PREPARATION
    # =======================================================================
    - name: Update APT cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required system packages
      apt:
        name:
          - curl
          - wget
          - git
          - unzip
          - software-properties-common
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
          - jq
          - bc
          - python3
          - python3-pip
          - sqlmap
        state: present

    # =======================================================================
    # DOCKER INSTALLATION
    # =======================================================================
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    # =======================================================================
    # DATADOG AGENT INSTALLATION
    # =======================================================================
    - name: Check if DataDog agent is already installed
      stat:
        path: /etc/datadog-agent
      register: datadog_installed

    - name: Download DataDog installation script
      get_url:
        url: "https://install.datadoghq.com/scripts/install_script_agent7.sh"
        dest: /tmp/install_datadog.sh
        mode: '0755'
      when: not datadog_installed.stat.exists

    - name: Install DataDog Agent
      shell: >
        DD_API_KEY={{ datadog_api_key }} DD_SITE={{ datadog_site }} bash /tmp/install_datadog.sh
      args:
        creates: /etc/datadog-agent/datadog.yaml
      when: not datadog_installed.stat.exists
      register: datadog_install
      retries: 3
      delay: 15
      until: datadog_install.rc == 0

    - name: Configure DataDog Agent for APM and IAST
      blockinfile:
        path: /etc/datadog-agent/datadog.yaml
        block: |
          apm_config:
            enabled: true
            apm_non_local_traffic: true
            receiver_port: 8126
            receiver_timeout: 10
            max_traces_per_second: 100

          appsec_config:
            enabled: true

          runtime_security_config:
            enabled: true

          process_config:
            enabled: "true"
            scrub_args: true

          logs_enabled: true
          logs_config:
            container_collect_all: true
        marker: "# {mark} ANSIBLE MANAGED BLOCK - DEVSECOPS CONFIG"
        create: no
        backup: yes
      notify: Restart DataDog Agent

    - name: Ensure DataDog Agent is running
      systemd:
        name: datadog-agent
        state: started
        enabled: yes

    # =======================================================================
    # ATTACK TOOLS INSTALLATION (FIXED)
    # =======================================================================
    - name: Create benchmark tools directory
      file:
        path: "{{ benchmark_tools_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    # FIXED: OWASP ZAP - Using Ansible modules instead of shell
    - name: Check if OWASP ZAP is already installed
      stat:
        path: /usr/local/bin/zaproxy
      register: zap_installed

    - name: Download OWASP ZAP
      get_url:
        url: https://github.com/zaproxy/zaproxy/releases/download/v2.14.0/ZAP_2.14.0_Linux.tar.gz
        dest: /tmp/ZAP_2.14.0_Linux.tar.gz
        mode: '0644'
        timeout: 300
      when: not zap_installed.stat.exists
      register: zap_download
      retries: 3
      delay: 10
      until: zap_download is succeeded

    - name: Extract OWASP ZAP
      unarchive:
        src: /tmp/ZAP_2.14.0_Linux.tar.gz
        dest: /opt/
        remote_src: yes
      when: not zap_installed.stat.exists

    - name: Create ZAP symlink
      file:
        src: /opt/ZAP_2.14.0/zap.sh
        dest: /usr/local/bin/zaproxy
        state: link
      when: not zap_installed.stat.exists

    - name: Clean up ZAP download
      file:
        path: /tmp/ZAP_2.14.0_Linux.tar.gz
        state: absent
      when: not zap_installed.stat.exists

    # FIXED: Nuclei - Using Ansible modules instead of shell
    - name: Check if Nuclei is already installed
      stat:
        path: /usr/local/bin/nuclei
      register: nuclei_installed

    - name: Download Nuclei
      get_url:
        url: https://github.com/projectdiscovery/nuclei/releases/download/v3.1.0/nuclei_3.1.0_linux_amd64.zip
        dest: /tmp/nuclei_3.1.0_linux_amd64.zip
        mode: '0644'
        timeout: 300
      when: not nuclei_installed.stat.exists
      register: nuclei_download
      retries: 3
      delay: 10
      until: nuclei_download is succeeded

    - name: Extract Nuclei
      unarchive:
        src: /tmp/nuclei_3.1.0_linux_amd64.zip
        dest: /tmp/
        remote_src: yes
      when: not nuclei_installed.stat.exists

    - name: Move Nuclei binary
      copy:
        src: /tmp/nuclei
        dest: /usr/local/bin/nuclei
        mode: '0755'
        remote_src: yes
      when: not nuclei_installed.stat.exists

    - name: Clean up Nuclei download
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/nuclei_3.1.0_linux_amd64.zip
        - /tmp/nuclei
      when: not nuclei_installed.stat.exists

    - name: Update Nuclei templates
      command: nuclei -update-templates
      become: true
      become_user: ubuntu
      when: not nuclei_installed.stat.exists
      changed_when: true

    # FIXED: Python packages - Using apt instead of pip (PEP 668 compliance)
    - name: Install Python attack libraries (system packages)
      apt:
        name:
          - python3-requests
          - python3-bs4
          - python3-colorama
          - python3-pandas
        state: present
      become: true

    - name: Install additional Python tools via apt
      apt:
        name:
          - python3-urllib3
          - python3-chardet
        state: present
      become: true
      ignore_errors: true

    # =======================================================================
    # APPLICATION SETUP
    # =======================================================================
    - name: Create application directory
      file:
        path: "{{ juice_shop_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Clone Juice Shop repository
      git:
        repo: https://github.com/juice-shop/juice-shop.git
        dest: "{{ juice_shop_dir }}"
        depth: 1
        update: yes
      become: true
      become_user: ubuntu

    - name: Ensure repo ownership
      file:
        path: "{{ juice_shop_dir }}"
        owner: ubuntu
        group: ubuntu
        recurse: yes

    - name: Create tracer.ts
      copy:
        dest: "{{ juice_shop_dir }}/tracer.ts"
        content: |
          // tracer.ts - DataDog APM Tracer
          import tracer from 'dd-trace';
          tracer.init();
          export default tracer;
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    # =======================================================================
    # DOCKERFILE
    # =======================================================================
    - name: Create Dockerfile
      copy:
        dest: "{{ juice_shop_dir }}/Dockerfile"
        content: |
          FROM node:22-bookworm-slim AS builder

          RUN apt-get update && apt-get install -y git python3 make g++ && rm -rf /var/lib/apt/lists/*
          WORKDIR /juice-shop

          RUN git clone --depth 1 https://github.com/juice-shop/juice-shop.git . && rm -rf .git
          RUN npm install
          RUN npm install --save-exact @aikidosec/firewall dd-trace

          COPY tracer.ts ./tracer.ts

          RUN sed -i "1i import './tracer' // DataDog APM" app.ts && \
              sed -i "2i import '@aikidosec/firewall' // Aikido RASP" app.ts

          RUN sed -i "1i import './tracer' // DataDog APM" server.ts && \
              sed -i "2i import '@aikidosec/firewall' // Aikido RASP" server.ts

          RUN echo "=== Modified app.ts ===" && head -10 app.ts
          RUN echo "=== Modified server.ts ===" && head -10 server.ts

          RUN npx tsc || npm run build:server || echo "TypeScript compilation attempted"
          
          RUN ls -la build/ && \
              echo "=== build/app.js ===" && \
              head -30 build/app.js && \
              echo "=== Checking instrumentation ===" && \
              grep -E "tracer|aikido" build/app.js | head -5

          RUN cd frontend && npm install --legacy-peer-deps && \
              node ./node_modules/@angular/cli/bin/ng build --configuration production || echo "Frontend build completed"

          FROM node:22-bookworm-slim
          
          RUN apt-get update && apt-get install -y curl procps && rm -rf /var/lib/apt/lists/*
          RUN groupadd -r juiceshop && useradd -r -g juiceshop juiceshop
          
          WORKDIR /juice-shop

          COPY --from=builder --chown=juiceshop:juiceshop /juice-shop /juice-shop

          RUN mkdir -p /juice-shop/logs /juice-shop/ftp /juice-shop/data && \
              chown -R juiceshop:juiceshop /juice-shop

          USER juiceshop
          EXPOSE 3000

          HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
            CMD curl -f http://localhost:3000/rest/admin/application-version || exit 1

          ENV NODE_ENV=production \
              PORT=3000 \
              NODE_OPTIONS="--max-old-space-size=2048"
          
          CMD ["npm", "start"]
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    # =======================================================================
    # DOCKER COMPOSE
    # =======================================================================
    - name: Create docker-compose.yml template
      copy:
        dest: "{{ juice_shop_dir }}/docker-compose.yml"
        content: |
          services:
            juice-shop:
              build: .
              image: juice-shop-secure:latest
              container_name: juice-shop
              restart: unless-stopped
              ports:
                - "3000:3000"
              environment:
                NODE_ENV: production
                DD_ENV: dev
                DD_SERVICE: juice-shop
                DD_VERSION: latest
                DD_AGENT_HOST: 172.17.0.1
                DD_TRACE_AGENT_PORT: 8126
                DD_LOGS_INJECTION: "true"
                DD_TRACE_SAMPLE_RATE: "1"
                DD_PROFILING_ENABLED: "true"
                DD_RUNTIME_METRICS_ENABLED: "true"
                DD_DATA_STREAMS_ENABLED: "true"
                DD_APPSEC_ENABLED: "true"
                DD_IAST_ENABLED: "true"
                AIKIDO_TOKEN: ${AIKIDO_TOKEN}
                AIKIDO_BLOCK: "false"
                AIKIDO_DEBUG: "true"
              env_file:
                - .env
              extra_hosts:
                - "host.docker.internal:host-gateway"
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:3000"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 60s
              logging:
                driver: "json-file"
                options:
                  max-size: "10m"
                  max-file: "3"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Create .env file
      copy:
        dest: "{{ juice_shop_dir }}/.env"
        content: |
          AIKIDO_TOKEN={{ aikido_token }}
          AIKIDO_BLOCK=false
          AIKIDO_DEBUG=true
          DD_ENV=dev
          DD_VERSION=latest
        owner: ubuntu
        group: ubuntu
        mode: '0600'
      no_log: true

    # =======================================================================
    # ATTACK SCRIPTS
    # =======================================================================
    - name: Create SQL Injection attack script
      copy:
        dest: "{{ benchmark_tools_dir }}/sqli_attacks.sh"
        content: |
          #!/bin/bash
          TARGET=$1
          OUTPUT_FILE=$2
          
          echo "ðŸŽ¯ Running SQL Injection attacks against $TARGET"
          
          declare -a PAYLOADS=(
            "' OR '1'='1"
            "' OR 1=1--"
            "admin' --"
            "1' UNION SELECT NULL--"
            "' AND 1=0 UNION ALL SELECT 'admin', '81dc9bdb52d04dc20036dbd8313ed055"
            "' OR 'a'='a"
            "1' AND '1'='1"
            "admin'/*"
          )
          
          ATTACK_COUNT=0
          DETECTED_COUNT=0
          BLOCKED_COUNT=0
          
          for payload in "${PAYLOADS[@]}"; do
            ATTACK_COUNT=$((ATTACK_COUNT + 1))
            ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('''$payload'''))")
            
            RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X POST "$TARGET/rest/user/login" \
              -H "Content-Type: application/json" \
              -d "{\"email\":\"admin@juice-sh.op$payload\",\"password\":\"test\"}" 2>&1)
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -1)
            BODY=$(echo "$RESPONSE" | head -n -1)
            
            if [[ "$HTTP_CODE" == "403" ]] || [[ "$BODY" == *"blocked"* ]]; then
              BLOCKED_COUNT=$((BLOCKED_COUNT + 1))
              echo "  âœ… Blocked: SQL injection"
            elif [[ "$HTTP_CODE" == "401" ]] || [[ "$HTTP_CODE" == "400" ]]; then
              DETECTED_COUNT=$((DETECTED_COUNT + 1))
              echo "  âš ï¸  Detected: SQL injection"
            else
              echo "  âŒ Passed: SQL injection not prevented"
            fi
            
            sleep 0.5
          done
          
          echo "$ATTACK_COUNT,$DETECTED_COUNT,$BLOCKED_COUNT" > "$OUTPUT_FILE"
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Create XSS attack script
      copy:
        dest: "{{ benchmark_tools_dir }}/xss_attacks.sh"
        content: |
          #!/bin/bash
          TARGET=$1
          OUTPUT_FILE=$2
          
          echo "ðŸŽ¯ Running XSS attacks against $TARGET"
          
          declare -a PAYLOADS=(
            "<script>alert('XSS')</script>"
            "<img src=x onerror=alert('XSS')>"
            "<svg/onload=alert('XSS')>"
            "javascript:alert('XSS')"
            "<iframe src='javascript:alert(1)'>"
            "<body onload=alert('XSS')>"
            "<input onfocus=alert('XSS') autofocus>"
            "<marquee onstart=alert('XSS')>"
          )
          
          ATTACK_COUNT=0
          DETECTED_COUNT=0
          BLOCKED_COUNT=0
          
          for payload in "${PAYLOADS[@]}"; do
            ATTACK_COUNT=$((ATTACK_COUNT + 1))
            ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('''$payload'''))")
            
            RESPONSE=$(curl -s -w "\n%{http_code}" \
              "$TARGET/rest/products/search?q=$ENCODED" 2>&1)
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -1)
            BODY=$(echo "$RESPONSE" | head -n -1)
            
            if [[ "$HTTP_CODE" == "403" ]] || [[ "$BODY" == *"blocked"* ]]; then
              BLOCKED_COUNT=$((BLOCKED_COUNT + 1))
              echo "  âœ… Blocked: XSS"
            elif [[ "$BODY" != *"$payload"* ]] && [[ "$HTTP_CODE" == "200" ]]; then
              DETECTED_COUNT=$((DETECTED_COUNT + 1))
              echo "  âš ï¸  Detected: XSS sanitized"
            else
              echo "  âŒ Passed: XSS not prevented"
            fi
            
            sleep 0.5
          done
          
          echo "$ATTACK_COUNT,$DETECTED_COUNT,$BLOCKED_COUNT" > "$OUTPUT_FILE"
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Create Path Traversal attack script
      copy:
        dest: "{{ benchmark_tools_dir }}/path_traversal.sh"
        content: |
          #!/bin/bash
          TARGET=$1
          OUTPUT_FILE=$2
          
          echo "ðŸŽ¯ Running Path Traversal attacks against $TARGET"
          
          declare -a PAYLOADS=(
            "../../../etc/passwd"
            "....//....//....//etc/passwd"
            "..%252f..%252f..%252fetc%252fpasswd"
            "../../../../../../../../etc/passwd"
            "..\\..\\..\\etc\\passwd"
            "%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd"
          )
          
          ATTACK_COUNT=0
          DETECTED_COUNT=0
          BLOCKED_COUNT=0
          
          for payload in "${PAYLOADS[@]}"; do
            ATTACK_COUNT=$((ATTACK_COUNT + 1))
            
            RESPONSE=$(curl -s -w "\n%{http_code}" \
              "$TARGET/ftp/$payload" 2>&1)
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -1)
            BODY=$(echo "$RESPONSE" | head -n -1)
            
            if [[ "$HTTP_CODE" == "403" ]] || [[ "$BODY" == *"blocked"* ]]; then
              BLOCKED_COUNT=$((BLOCKED_COUNT + 1))
              echo "  âœ… Blocked: Path traversal"
            elif [[ "$HTTP_CODE" == "404" ]]; then
              DETECTED_COUNT=$((DETECTED_COUNT + 1))
              echo "  âš ï¸  Detected: Path blocked"
            elif [[ "$BODY" == *"root:"* ]]; then
              echo "  âŒ Passed: /etc/passwd accessed"
            fi
            
            sleep 0.5
          done
          
          echo "$ATTACK_COUNT,$DETECTED_COUNT,$BLOCKED_COUNT" > "$OUTPUT_FILE"
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Create metrics collection script
      copy:
        dest: "{{ benchmark_tools_dir }}/collect_metrics.sh"
        content: |
          #!/bin/bash
          CONFIG=$1
          RESULTS_DIR=$2
          TARGET="http://localhost:3000"
          SAMPLES=100
          
          echo "ðŸ“Š Collecting performance metrics for $CONFIG..."
          
          TOTAL_TIME=0
          SUCCESS_COUNT=0
          
          for i in $(seq 1 $SAMPLES); do
            START=$(date +%s%N)
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$TARGET/rest/products/search?q=apple" 2>/dev/null)
            END=$(date +%s%N)
            
            if [ "$HTTP_CODE" = "200" ]; then
              LATENCY=$(( (END - START) / 1000000 ))
              TOTAL_TIME=$((TOTAL_TIME + LATENCY))
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            fi
            
            sleep 0.1
          done
          
          AVG_LATENCY=$((TOTAL_TIME / SUCCESS_COUNT))
          SUCCESS_RATE=$(echo "scale=2; $SUCCESS_COUNT * 100 / $SAMPLES" | bc)
          
          cat > "$RESULTS_DIR/performance_metrics.csv" << EOF
          METRIC,VALUE
          AVG_LATENCY_MS,$AVG_LATENCY
          SUCCESS_RATE_PERCENT,$SUCCESS_RATE
          SAMPLES,$SAMPLES
          EOF
          
          echo "âœ… Metrics collected - Latency: ${AVG_LATENCY}ms, Success: ${SUCCESS_RATE}%"
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Create master attack orchestrator
      copy:
        dest: "{{ benchmark_tools_dir }}/run_all_attacks.sh"
        content: |
          #!/bin/bash
          set -e
          
          TARGET=$1
          CONFIG_NAME=$2
          RESULTS_DIR=$3
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸš€ Running Attack Suite"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Target: $TARGET"
          echo "Configuration: $CONFIG_NAME"
          echo "Results: $RESULTS_DIR"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          mkdir -p "$RESULTS_DIR"
          
          START_TIME=$(date +%s)
          
          /opt/benchmark-tools/sqli_attacks.sh "$TARGET" "$RESULTS_DIR/sqli_results.csv"
          /opt/benchmark-tools/xss_attacks.sh "$TARGET" "$RESULTS_DIR/xss_results.csv"
          /opt/benchmark-tools/path_traversal.sh "$TARGET" "$RESULTS_DIR/path_results.csv"
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "ATTACK_TYPE,TOTAL,DETECTED,BLOCKED" > "$RESULTS_DIR/summary.csv"
          
          echo -n "SQL_INJECTION," >> "$RESULTS_DIR/summary.csv"
          cat "$RESULTS_DIR/sqli_results.csv" >> "$RESULTS_DIR/summary.csv"
          
          echo -n "XSS," >> "$RESULTS_DIR/summary.csv"
          cat "$RESULTS_DIR/xss_results.csv" >> "$RESULTS_DIR/summary.csv"
          
          echo -n "PATH_TRAVERSAL," >> "$RESULTS_DIR/summary.csv"
          cat "$RESULTS_DIR/path_results.csv" >> "$RESULTS_DIR/summary.csv"
          
          echo "DURATION_SECONDS,$DURATION" >> "$RESULTS_DIR/summary.csv"
          
          echo ""
          echo "âœ… Attack suite completed in ${DURATION}s"
          echo "ðŸ“Š Results: $RESULTS_DIR/summary.csv"
        owner: ubuntu
        group: ubuntu
        mode: '0755'

  handlers:
    - name: Restart DataDog Agent
      systemd:
        name: datadog-agent
        state: restarted