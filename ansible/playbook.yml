---
- name: Configure EC2 for Juice Shop with DevSecOps Tools + Two-Scenario Comparison (Container Reuse)
  hosts: juiceshop
  become: true
  gather_facts: true

  vars:
    juice_shop_dir: /opt/juice-shop
    metrics_dir: /opt/security-metrics
    node_version: "22"
    prometheus_version: "2.48.0"

  vars_files:
    - secrets.yml

  tasks:
    # =======================================================================
    # SYSTEM PREPARATION
    # =======================================================================
    - name: Update APT cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required system packages
      apt:
        name:
          - curl
          - wget
          - git
          - unzip
          - software-properties-common
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
          - jq
          - python3
          - python3-pip
          - python3-venv
        state: present

    # =======================================================================
    # DOCKER INSTALLATION
    # =======================================================================
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    # =======================================================================
    # DATADOG AGENT INSTALLATION
    # =======================================================================
    - name: Check if DataDog agent is already installed
      stat:
        path: /etc/datadog-agent
      register: datadog_installed

    - name: Download DataDog installation script
      get_url:
        url: "https://install.datadoghq.com/scripts/install_script_agent7.sh"
        dest: /tmp/install_datadog.sh
        mode: '0755'
      when: not datadog_installed.stat.exists

    - name: Install DataDog Agent
      shell: >
        DD_API_KEY={{ datadog_api_key }} DD_SITE={{ datadog_site }} bash /tmp/install_datadog.sh
      args:
        creates: /etc/datadog-agent/datadog.yaml
      when: not datadog_installed.stat.exists
      register: datadog_install
      retries: 3
      delay: 15
      until: datadog_install.rc == 0

    - name: Configure DataDog Agent for APM and IAST
      blockinfile:
        path: /etc/datadog-agent/datadog.yaml
        block: |
          apm_config:
            enabled: true
            apm_non_local_traffic: true
            receiver_port: 8126
            receiver_timeout: 10
            max_traces_per_second: 100

          appsec_config:
            enabled: true

          runtime_security_config:
            enabled: true

          process_config:
            enabled: "true"
            scrub_args: true

          logs_enabled: true
          logs_config:
            container_collect_all: true
        marker: "# {mark} ANSIBLE MANAGED BLOCK - DEVSECOPS CONFIG"
        create: no
        backup: yes
      notify: Restart DataDog Agent

    - name: Ensure DataDog Agent is running
      systemd:
        name: datadog-agent
        state: started
        enabled: yes

    # =======================================================================
    # PROMETHEUS INSTALLATION
    # =======================================================================
    - name: Create Prometheus user
      user:
        name: prometheus
        system: yes
        shell: /bin/false
        create_home: no

    - name: Create Prometheus directories
      file:
        path: "{{ item }}"
        state: directory
        owner: prometheus
        group: prometheus
        mode: '0755'
      loop:
        - /etc/prometheus
        - /var/lib/prometheus

    - name: Download and extract Prometheus
      unarchive:
        src: "https://github.com/prometheus/prometheus/releases/download/v{{ prometheus_version }}/prometheus-{{ prometheus_version }}.linux-amd64.tar.gz"
        dest: /tmp
        remote_src: yes
        creates: /tmp/prometheus-{{ prometheus_version }}.linux-amd64

    - name: Copy Prometheus binaries
      copy:
        src: "/tmp/prometheus-{{ prometheus_version }}.linux-amd64/{{ item }}"
        dest: /usr/local/bin/
        mode: '0755'
        owner: prometheus
        group: prometheus
        remote_src: yes
      loop:
        - prometheus
        - promtool

    - name: Create Prometheus configuration
      copy:
        dest: /etc/prometheus/prometheus.yml
        content: |
          global:
            scrape_interval: 15s
            evaluation_interval: 15s

          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']

            - job_name: 'security-metrics-exporter'
              static_configs:
                - targets: ['localhost:9999']
              scrape_interval: 30s
        owner: prometheus
        group: prometheus
        mode: '0644'
      notify: Restart Prometheus

    - name: Create Prometheus systemd service
      copy:
        dest: /etc/systemd/system/prometheus.service
        content: |
          [Unit]
          Description=Prometheus
          Wants=network-online.target
          After=network-online.target

          [Service]
          User=prometheus
          Group=prometheus
          Type=simple
          ExecStart=/usr/local/bin/prometheus \
            --config.file=/etc/prometheus/prometheus.yml \
            --storage.tsdb.path=/var/lib/prometheus/ \
            --web.console.templates=/etc/prometheus/consoles \
            --web.console.libraries=/etc/prometheus/console_libraries

          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      notify: Restart Prometheus

    - name: Enable and start Prometheus
      systemd:
        name: prometheus
        enabled: yes
        state: started
        daemon_reload: yes

    # =======================================================================
    # GRAFANA INSTALLATION
    # =======================================================================
    - name: Add Grafana GPG key
      apt_key:
        url: https://apt.grafana.com/gpg.key
        state: present

    - name: Add Grafana repository
      apt_repository:
        repo: "deb https://apt.grafana.com stable main"
        state: present

    - name: Install Grafana
      apt:
        name: grafana
        state: present
        update_cache: yes

    - name: Configure Grafana to run on port 3001
      lineinfile:
        path: /etc/grafana/grafana.ini
        regexp: '^;?http_port ='
        line: 'http_port = 3001'
        state: present
      notify: Restart Grafana

    - name: Create Grafana provisioning directories
      file:
        path: "/etc/grafana/provisioning/{{ item }}"
        state: directory
        owner: grafana
        group: grafana
        mode: '0755'
      loop:
        - datasources
        - dashboards

    - name: Configure Prometheus datasource for Grafana
      copy:
        dest: /etc/grafana/provisioning/datasources/prometheus.yml
        content: |
          apiVersion: 1
          datasources:
            - name: Prometheus
              type: prometheus
              access: proxy
              url: http://localhost:9090
              isDefault: true
              editable: false
        owner: grafana
        group: grafana
        mode: '0644'
      notify: Restart Grafana

    - name: Create dashboard provisioning config
      copy:
        dest: /etc/grafana/provisioning/dashboards/default.yml
        content: |
          apiVersion: 1
          providers:
            - name: 'Default'
              orgId: 1
              folder: ''
              type: file
              disableDeletion: false
              updateIntervalSeconds: 10
              allowUiUpdates: true
              options:
                path: /var/lib/grafana/dashboards
        owner: grafana
        group: grafana
        mode: '0644'
      notify: Restart Grafana

    - name: Create Grafana dashboards directory
      file:
        path: /var/lib/grafana/dashboards
        state: directory
        owner: grafana
        group: grafana
        mode: '0755'

    - name: Copy Enhanced Thesis Comparison Dashboard
      copy:
        src: files/grafana-thesis-dashboard.json
        dest: /var/lib/grafana/dashboards/thesis-comparison.json
        owner: grafana
        group: grafana
        mode: '0644'
      notify: Restart Grafana
      ignore_errors: yes

    - name: Enable and start Grafana
      systemd:
        name: grafana-server
        enabled: yes
        state: started

    # =======================================================================
    # METRICS EXPORTER SETUP
    # =======================================================================
    - name: Create metrics directory structure
      file:
        path: "{{ item }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'
      loop:
        - "{{ metrics_dir }}"
        - "{{ metrics_dir }}/zap-results"
        - "{{ metrics_dir }}/data"

    - name: Create Python virtual environment for metrics exporter
      command: python3 -m venv {{ metrics_dir }}/venv
      args:
        creates: "{{ metrics_dir }}/venv"
      become_user: ubuntu

    - name: Install Python dependencies for metrics exporter
      pip:
        name:
          - prometheus_client
          - requests
          - flask
        virtualenv: "{{ metrics_dir }}/venv"
      become_user: ubuntu

    - name: Copy Enhanced Metrics Exporter Script
      copy:
        src: files/enhanced_metrics_exporter.py
        dest: "{{ metrics_dir }}/metrics_exporter.py"
        owner: ubuntu
        group: ubuntu
        mode: '0755'
      ignore_errors: yes

    - name: Create metrics exporter systemd service
      copy:
        dest: /etc/systemd/system/security-metrics-exporter.service
        content: |
          [Unit]
          Description=Security Metrics Exporter for Prometheus (SAST/DAST/IAST/RASP)
          After=network.target prometheus.service

          [Service]
          Type=simple
          User=ubuntu
          WorkingDirectory={{ metrics_dir }}
          Environment="DD_API_KEY={{ datadog_api_key }}"
          Environment="DD_APP_KEY={{ datadog_app_key }}"
          Environment="DD_SITE={{ datadog_site }}"
          Environment="AIKIDO_TOKEN={{ aikido_token }}"
          ExecStart={{ metrics_dir }}/venv/bin/python {{ metrics_dir }}/metrics_exporter.py
          Restart=always
          RestartSec=10
          StandardOutput=journal
          StandardError=journal

          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      notify: Restart Metrics Exporter

    - name: Enable and start metrics exporter
      systemd:
        name: security-metrics-exporter
        enabled: yes
        state: started
        daemon_reload: yes
      ignore_errors: yes

    - name: Initialize manual metrics file
      copy:
        dest: "{{ metrics_dir }}/data/manual_metrics.json"
        content: |
          {
            "scan_phase": 0,
            "scenario": "unknown",
            "scenario_id": 0,
            "response_times": {
              "datadog_iast": 0,
              "aikido_rasp": 0
            }
          }
        owner: ubuntu
        group: ubuntu
        mode: '0644'
        force: no

    # =======================================================================
    # APPLICATION SETUP
    # =======================================================================
    - name: Create application directory
      file:
        path: "{{ juice_shop_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Clone Juice Shop repository
      git:
        repo: https://github.com/juice-shop/juice-shop.git
        dest: "{{ juice_shop_dir }}"
        depth: 1
        update: yes
        force: yes
      become: true
      become_user: ubuntu

    - name: Ensure repo ownership is ubuntu
      file:
        path: "{{ juice_shop_dir }}"
        owner: ubuntu
        group: ubuntu
        recurse: yes

    - name: Create tracer.ts
      copy:
        dest: "{{ juice_shop_dir }}/tracer.ts"
        content: |
          // tracer.ts
          import tracer from 'dd-trace';
          tracer.init();
          export default tracer;
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Create Dockerfile (Stable Version)
      copy:
        dest: "{{ juice_shop_dir }}/Dockerfile"
        content: |
          # Multi-stage Dockerfile for Juice Shop with Security Tools
          FROM node:22-bookworm-slim AS builder

          RUN apt-get update && apt-get install -y git python3 make g++ && rm -rf /var/lib/apt/lists/*
          WORKDIR /juice-shop

          # Clone Juice Shop
          RUN git clone --depth 1 https://github.com/juice-shop/juice-shop.git . && rm -rf .git

          # Install ALL dependencies
          RUN npm install

          # Install security tools
          RUN npm install --save-exact @aikidosec/firewall dd-trace

          # Copy tracer
          COPY tracer.ts ./tracer.ts

          # Modify TypeScript source files BEFORE compilation
          RUN sed -i "1i import './tracer' // DataDog APM" app.ts && \
              sed -i "2i import '@aikidosec/firewall' // Aikido RASP" app.ts
          
          RUN sed -i "1i import './tracer' // DataDog APM" server.ts && \
              sed -i "2i import '@aikidosec/firewall' // Aikido RASP" server.ts

          # Verify modifications
          RUN echo "=== Modified app.ts (first 10 lines) ===" && head -10 app.ts
          RUN echo "=== Modified server.ts (first 10 lines) ===" && head -10 server.ts

          # Compile TypeScript to JavaScript
          RUN npx tsc || npm run build:server || echo "TypeScript compilation attempted"
          
          # Verify build
          RUN ls -la build/ && \
              echo "=== build/app.js (first 30 lines) ===" && \
              head -30 build/app.js && \
              echo "=== Checking for tracer/aikido in build/app.js ===" && \
              grep -E "tracer|aikido" build/app.js | head -5

          # Build frontend
          RUN cd frontend && npm install --legacy-peer-deps && \
              node ./node_modules/@angular/cli/bin/ng build --configuration production || echo "Frontend build completed"

          # Production stage
          FROM node:22-bookworm-slim
          
          RUN apt-get update && apt-get install -y curl procps && rm -rf /var/lib/apt/lists/*
          RUN groupadd -r juiceshop && useradd -r -g juiceshop juiceshop
          
          WORKDIR /juice-shop

          # Copy entire application
          COPY --from=builder --chown=juiceshop:juiceshop /juice-shop /juice-shop

          # Ensure directories exist
          RUN mkdir -p /juice-shop/logs /juice-shop/ftp /juice-shop/data && \
              chown -R juiceshop:juiceshop /juice-shop

          USER juiceshop
          EXPOSE 3000

          HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
            CMD curl -f http://localhost:3000/rest/admin/application-version || exit 1

          ENV NODE_ENV=production \
              PORT=3000 \
              NODE_OPTIONS="--max-old-space-size=2048"
          
          CMD ["npm", "start"]
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Create docker-compose.yml (Base Configuration)
      copy:
        dest: "{{ juice_shop_dir }}/docker-compose.yml"
        content: |
          services:
            juice-shop:
              build: .
              image: juice-shop-secure:latest
              container_name: juice-shop
              restart: unless-stopped
              ports:
                - "3000:3000"
              environment:
                NODE_ENV: production
                
                # DataDog APM - Always Active
                DD_ENV: dev
                DD_SERVICE: ${DD_SERVICE:-juice-shop}
                DD_VERSION: ${DD_VERSION:-latest}
                DD_AGENT_HOST: 172.17.0.1
                DD_TRACE_AGENT_PORT: 8126
                DD_LOGS_INJECTION: "true"
                DD_TRACE_SAMPLE_RATE: "1"
                DD_PROFILING_ENABLED: "true"
                DD_RUNTIME_METRICS_ENABLED: "true"
                DD_DATA_STREAMS_ENABLED: "true"
                DD_TRACE_REMOVE_INTEGRATION_SERVICE_NAMES_ENABLED: "true"
                
                # DataDog IAST - Always Active
                DD_APPSEC_ENABLED: "true"
                DD_IAST_ENABLED: "true"
                
                # Aikido RASP - Controlled by .env
                AIKIDO_TOKEN: ${AIKIDO_TOKEN}
                AIKIDO_BLOCK: ${AIKIDO_BLOCK:-false}
                AIKIDO_DEBUG: ${AIKIDO_DEBUG:-false}
                AIKIDO_FEATURE_COLLECT_API_SCHEMA: ${AIKIDO_FEATURE_COLLECT_API_SCHEMA:-false}
                
              env_file:
                - .env
              extra_hosts:
                - "host.docker.internal:host-gateway"
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:3000"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 60s
              logging:
                driver: "json-file"
                options:
                  max-size: "10m"
                  max-file: "3"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Create .env file (Default Configuration)
      copy:
        dest: "{{ juice_shop_dir }}/.env"
        content: |
          # Aikido Zen RASP Configuration
          AIKIDO_TOKEN={{ aikido_token }}
          AIKIDO_BLOCK=true
          AIKIDO_DEBUG=true
          AIKIDO_FEATURE_COLLECT_API_SCHEMA=false
          
          # DataDog Configuration
          DD_ENV=dev
          DD_SERVICE=juice-shop
          DD_VERSION=latest
        owner: ubuntu
        group: ubuntu
        mode: '0600'
      no_log: true

    # =======================================================================
    # SCENARIO SWITCHING SCRIPTS (THE KEY TO CONTAINER REUSE)
    # =======================================================================
    - name: Create scenario switch script
      copy:
        dest: "{{ juice_shop_dir }}/switch-scenario.sh"
        content: |
          #!/bin/bash
          # Usage: ./switch-scenario.sh [iast-only|iast-rasp]
          
          set -e
          cd "{{ juice_shop_dir }}"
          
          SCENARIO="${1:-iast-rasp}"
          
          echo "ğŸ”„ Switching to scenario: $SCENARIO"
          echo "======================================"
          
          case "$SCENARIO" in
            iast-only)
              echo "ğŸ“‹ SCENARIO 1: IAST Only (Detection, No Blocking)"
              cat > .env <<'EOF'
          # Aikido Zen RASP - DISABLED FOR SCENARIO 1
          AIKIDO_TOKEN={{ aikido_token }}
          AIKIDO_BLOCK=false
          AIKIDO_DEBUG=false
          AIKIDO_FEATURE_COLLECT_API_SCHEMA=false
          
          # DataDog Configuration
          DD_ENV=dev
          DD_SERVICE=juice-shop-iast-only
          DD_VERSION=scenario1
          EOF
              ;;
            
            iast-rasp)
              echo "ğŸ“‹ SCENARIO 2: IAST + RASP (Detection + Blocking)"
              cat > .env <<'EOF'
          # Aikido Zen RASP - ENABLED FOR SCENARIO 2
          AIKIDO_TOKEN={{ aikido_token }}
          AIKIDO_BLOCK=true
          AIKIDO_DEBUG=true
          
          # DataDog Configuration
          DD_ENV=dev
          DD_SERVICE=juice-shop-iast-rasp
          DD_VERSION=scenario2
          EOF
              ;;
            
            *)
              echo "âŒ Invalid scenario: $SCENARIO"
              echo "Usage: $0 [iast-only|iast-rasp]"
              exit 1
              ;;
          esac
          
          echo "âœ… Environment file updated for $SCENARIO"
          echo ""
          echo "ğŸ”„ Restarting container with new configuration..."
          
          # Stop container (keep image)
          docker compose stop
          
          # Remove container (not image!)
          docker compose rm -f
          
          # Start with new env
          docker compose up -d
          
          echo "â³ Waiting for container to be ready (30s)..."
          sleep 30
          
          # Verify
          if docker ps | grep -q juice-shop; then
            echo "âœ… Container running with $SCENARIO configuration"
            
            # Show active configuration
            echo ""
            echo "ğŸ” Active Configuration:"
            docker exec juice-shop env | grep -E "DD_SERVICE|AIKIDO_BLOCK|AIKIDO_DEBUG" | sort
            
            # Test health
            if curl -f -s http://localhost:3000 > /dev/null; then
              echo ""
              echo "âœ… Application responsive"
              
              # Show RASP status
              AIKIDO_BLOCK=$(docker exec juice-shop env | grep "AIKIDO_BLOCK" | cut -d'=' -f2)
              if [ "$AIKIDO_BLOCK" = "true" ]; then
                echo "ğŸ›¡ï¸  RASP is ACTIVE (blocking mode)"
              else
                echo "âš ï¸  RASP is DISABLED (detection only)"
              fi
            fi
          else
            echo "âŒ Container failed to start"
            docker compose logs --tail=50
            exit 1
          fi
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Create build and deploy script
      copy:
        dest: "{{ juice_shop_dir }}/build-and-deploy.sh"
        content: |
          #!/bin/bash
          set -e
          cd "{{ juice_shop_dir }}"
          
          echo "ğŸš€ Building and Deploying Juice Shop (ONE-TIME BUILD)"
          echo "======================================================="
          
          # Clean everything
          echo "ğŸ§¹ CLEANUP: Removing old containers and images..."
          docker compose down -v 2>/dev/null || true
          docker rm -f juice-shop 2>/dev/null || true
          docker rmi juice-shop-secure:latest 2>/dev/null || true
          docker system prune -f
          
          echo ""
          echo "ğŸ“¦ BUILDING IMAGE (this takes 5-10 minutes)..."
          echo "This includes TypeScript compilation and security tool installation"
          
          # Build with progress
          docker compose build --no-cache --progress=plain
          
          if [ $? -ne 0 ]; then
            echo "âŒ Build failed!"
            exit 1
          fi
          
          echo ""
          echo "âœ… Image built successfully: juice-shop-secure:latest"
          docker images | grep juice-shop-secure
          
          echo ""
          echo "â–¶ï¸  Starting container with default configuration..."
          docker compose up -d
          
          echo "â³ Waiting for application (45s)..."
          sleep 45
          
          # Verify
          if docker ps | grep -q juice-shop; then
            echo ""
            echo "âœ… Deployment successful!"
            echo ""
            echo "ğŸ“Š Container Status:"
            docker ps | grep juice-shop
            
            echo ""
            echo "ğŸ” Verifying instrumentation:"
            docker exec juice-shop head -20 build/app.js | grep -E "tracer|aikido" || echo "âš ï¸  Check build/app.js manually"
            
            echo ""
            echo "ğŸ”§ Environment Variables:"
            docker exec juice-shop env | grep -E "DD_|AIKIDO_" | sort
            
            echo ""
            echo "ğŸ“Š Application Logs:"
            docker logs juice-shop 2>&1 | tail -30
            
            echo ""
            echo "ğŸ§ª Testing application:"
            if curl -f -s http://localhost:3000 > /dev/null; then
              echo "âœ… Application is accessible at http://localhost:3000"
            else
              echo "âš ï¸  Application not responding (may need more time)"
            fi
            
            echo ""
            echo "=========================================="
            echo "ğŸ¯ READY FOR TWO-SCENARIO TESTING"
            echo "=========================================="
            echo ""
            echo "Switch scenarios using:"
            echo "  ./switch-scenario.sh iast-only   # Scenario 1: IAST Only"
            echo "  ./switch-scenario.sh iast-rasp   # Scenario 2: IAST + RASP"
            echo ""
            echo "Verify setup:"
            echo "  ./verify-instrumentation.sh"
            echo ""
            echo "View logs:"
            echo "  docker logs juice-shop -f"
            
          else
            echo "âŒ Container failed to start"
            docker compose logs
            exit 1
          fi
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Create verification script
      copy:
        dest: "{{ juice_shop_dir }}/verify-instrumentation.sh"
        content: |
          #!/bin/bash
          echo "ğŸ” Security Instrumentation Verification"
          echo "========================================"
          
          echo ""
          echo "â„¹ï¸  Juice Shop compiles TypeScript then runs: node build/app"
          
          echo ""
          echo "ğŸ“‹ Container Status:"
          docker ps | grep juice-shop || echo "âŒ Container not running"
          
          echo ""
          echo "ğŸ”§ Current Scenario Configuration:"
          echo "-----------------------------------"
          docker exec juice-shop env | grep -E "DD_SERVICE|DD_VERSION|AIKIDO_BLOCK|AIKIDO_DEBUG|DD_IAST|DD_APPSEC" | sort
          
          AIKIDO_BLOCK=$(docker exec juice-shop env 2>/dev/null | grep "AIKIDO_BLOCK" | cut -d'=' -f2)
          DD_SERVICE=$(docker exec juice-shop env 2>/dev/null | grep "DD_SERVICE" | cut -d'=' -f2)
          
          echo ""
          if [ "$AIKIDO_BLOCK" = "true" ]; then
            echo "ğŸ›¡ï¸  Current Mode: IAST + RASP (Detection + Blocking)"
            echo "Service: $DD_SERVICE"
          else
            echo "âš ï¸  Current Mode: IAST Only (Detection, No Blocking)"
            echo "Service: $DD_SERVICE"
          fi
          
          echo ""
          echo "ğŸ“ Modified app.ts (TypeScript source - first 12 lines):"
          docker exec juice-shop head -12 app.ts 2>/dev/null || echo "âš ï¸  Could not read app.ts"
          
          echo ""
          echo "ğŸ”§ Compiled build/app.js (what actually runs - first 40 lines):"
          docker exec juice-shop head -40 build/app.js 2>/dev/null || echo "âš ï¸  Could not read build/app.js"
          
          echo ""
          echo "ğŸ” Check for instrumentation in compiled code:"
          docker exec juice-shop grep -n -E "tracer|aikido|firewall" build/app.js 2>/dev/null | head -10 || echo "âš ï¸  Instrumentation not found"
          
          echo ""
          echo "ğŸ“„ Tracer.ts content:"
          docker exec juice-shop cat tracer.ts 2>/dev/null || echo "âš ï¸  Could not read tracer.ts"
          
          echo ""
          echo "ğŸ“Š Application Startup Logs:"
          echo "----------------------------"
          docker logs juice-shop 2>&1 | head -80 | grep -i -E "aikido|datadog|tracer|firewall|dd-trace|starting agent" || echo "âš ï¸  Check logs manually: docker logs juice-shop"
          
          echo ""
          echo "ğŸ” AIKIDO Startup Messages:"
          docker logs juice-shop 2>&1 | grep -i "AIKIDO:" | head -20 || echo "No Aikido messages (check if blocking is enabled)"
          
          echo ""
          echo "ğŸ“¡ DataDog Agent Status on Host:"
          sudo datadog-agent status 2>&1 | grep -A 10 "APM Agent" || echo "âš ï¸  Run with sudo to see agent status"
          
          echo ""
          echo "=========================================="
          echo "ğŸš€ Test Commands"
          echo "=========================================="
          echo ""
          echo "Generate test traffic:"
          echo "  for i in {1..50}; do curl -s http://localhost:3000 >/dev/null; curl -s 'http://localhost:3000/rest/products/search?q=test' >/dev/null; sleep 0.5; done"
          echo ""
          echo "Check for traces:"
          echo "  docker logs juice-shop --tail=100 | grep -i -E 'trace|span|aikido'"
          echo ""
          echo "Switch scenarios:"
          echo "  ./switch-scenario.sh iast-only"
          echo "  ./switch-scenario.sh iast-rasp"
        mode: '0755'

    - name: Create cleanup script
      copy:
        dest: "{{ juice_shop_dir }}/cleanup.sh"
        content: |
          #!/bin/bash
          echo "ğŸ§¹ Cleanup: Removing all containers and images"
          echo "=============================================="
          
          cd "{{ juice_shop_dir }}"
          
          echo "Stopping containers..."
          docker compose down -v 2>/dev/null || true
          
          echo "Removing containers..."
          docker rm -f juice-shop 2>/dev/null || true
          
          echo "Removing images..."
          docker rmi juice-shop-secure:latest 2>/dev/null || true
          docker rmi juice-shop-secure:iast-only 2>/dev/null || true
          docker rmi juice-shop-secure:iast-rasp 2>/dev/null || true
          
          echo "Pruning system..."
          docker system prune -f
          
          echo ""
          echo "âœ… Cleanup complete"
          echo "Run ./build-and-deploy.sh to rebuild"
        mode: '0755'

    # =======================================================================
    # POST-INSTALLATION VERIFICATION
    # =======================================================================
    - name: Wait for services to stabilize
      pause:
        seconds: 10

    - name: Verify all services are running
      shell: |
        echo "=== Service Status Check ==="
        systemctl is-active prometheus && echo "âœ… Prometheus: Active" || echo "âŒ Prometheus: Inactive"
        systemctl is-active grafana-server && echo "âœ… Grafana: Active" || echo "âŒ Grafana: Inactive"
        systemctl is-active datadog-agent && echo "âœ… DataDog Agent: Active" || echo "âŒ DataDog Agent: Inactive"
        if systemctl is-active security-metrics-exporter >/dev/null 2>&1; then
          echo "âœ… Metrics Exporter: Active"
        else
          echo "âš ï¸  Metrics Exporter: Not active (will start after first build)"
        fi
      register: service_check
      changed_when: false

    - name: Display service status
      debug:
        msg: "{{ service_check.stdout_lines }}"

    - name: Display setup completion summary
      debug:
        msg:
          - "=========================================="
          - "âœ… CONTAINER REUSE INFRASTRUCTURE READY"
          - "=========================================="
          - ""
          - "ğŸ¯ Innovation: Build Once, Test Twice Strategy"
          - "   - Single Docker image with BOTH tools"
          - "   - Instant scenario switching (30s vs 20min)"
          - "   - Same container, different env variables"
          - ""
          - "ğŸ“¦ Next Steps:"
          - "   1. SSH to instance: ssh ubuntu@{{ ansible_host }}"
          - "   2. cd {{ juice_shop_dir }}"
          - "   3. ./build-and-deploy.sh  # ONE-TIME BUILD (5-10 min)"
          - ""
          - "ğŸ”„ Then Switch Scenarios Instantly:"
          - "   - ./switch-scenario.sh iast-only   # Scenario 1 (30s)"
          - "   - ./switch-scenario.sh iast-rasp   # Scenario 2 (30s)"
          - ""
          - "ğŸ” Verify Setup:"
          - "   - ./verify-instrumentation.sh"
          - "   - docker logs juice-shop"
          - ""
          - "ğŸ“Š Monitoring:"
          - "   - Prometheus: http://{{ ansible_host }}:9090"
          - "   - Grafana: http://{{ ansible_host }}:3001 (admin/admin)"
          - "   - Metrics: http://{{ ansible_host }}:9999/metrics"
          - ""
          - "ğŸ›¡ï¸ Security Tools:"
          - "   - DataDog IAST: Always active (detection)"
          - "   - Aikido RASP: Controlled via scenarios (blocking)"
          - ""
          - "ğŸš€ Ready for GitHub Actions Pipeline!"
          - "   - Pipeline will call build-and-deploy.sh once"
          - "   - Then switch-scenario.sh for each test"
          - "   - Total time: ~15-20 min (vs 40+ min before)"
          - "=========================================="

  handlers:
    - name: Restart DataDog Agent
      systemd:
        name: datadog-agent
        state: restarted

    - name: Restart Prometheus
      systemd:
        name: prometheus
        state: restarted

    - name: Restart Grafana
      systemd:
        name: grafana-server
        state: restarted

    - name: Restart Metrics Exporter
      systemd:
        name: security-metrics-exporter
        state: restarted