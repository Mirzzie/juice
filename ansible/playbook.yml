---
- name: Configure EC2 for Juice Shop with DevSecOps Tools (Docker-Based)
  hosts: juiceshop
  become: true
  gather_facts: true

  vars:
    juice_shop_dir: /opt/juice-shop
    node_version: "22"
    docker_compose_version: "2.23.0"

  vars_files:
    - secrets.yml

  tasks:
    # =======================================================================
    # SYSTEM PREPARATION
    # =======================================================================
    - name: Update APT cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required system packages
      apt:
        name:
          - curl
          - wget
          - git
          - unzip
          - software-properties-common
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
          - jq
        state: present

    # =======================================================================
    # DOCKER INSTALLATION
    # =======================================================================
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    # =======================================================================
    # DATADOG AGENT INSTALLATION
    # =======================================================================
    - name: Check if DataDog agent is already installed
      stat:
        path: /etc/datadog-agent
      register: datadog_installed

    - name: Download DataDog installation script
      get_url:
        url: "https://install.datadoghq.com/scripts/install_script_agent7.sh"
        dest: /tmp/install_datadog.sh
        mode: '0755'
      when: not datadog_installed.stat.exists

    - name: Install DataDog Agent
      shell: >
        DD_API_KEY={{ datadog_api_key }} DD_SITE={{ datadog_site }} bash /tmp/install_datadog.sh
      args:
        creates: /etc/datadog-agent/datadog.yaml
      when: not datadog_installed.stat.exists
      register: datadog_install
      retries: 3
      delay: 15
      until: datadog_install.rc == 0

    - name: Configure DataDog Agent for APM and IAST
      blockinfile:
        path: /etc/datadog-agent/datadog.yaml
        block: |
          apm_config:
            enabled: true
            apm_non_local_traffic: true
            receiver_port: 8126
            receiver_timeout: 10
            max_traces_per_second: 100

          appsec_config:
            enabled: true

          runtime_security_config:
            enabled: true

          process_config:
            enabled: "true"
            scrub_args: true

          logs_enabled: true
          logs_config:
            container_collect_all: true
        marker: "# {mark} ANSIBLE MANAGED BLOCK - DEVSECOPS CONFIG"
        create: no
        backup: yes
      notify: Restart DataDog Agent

    - name: Ensure DataDog Agent is running
      systemd:
        name: datadog-agent
        state: started
        enabled: yes

    # =======================================================================
    # APPLICATION SETUP
    # =======================================================================
    - name: Create application directory
      file:
        path: "{{ juice_shop_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    # ✅ Minimal tracer.ts (DataDog standard)
    - name: Create tracer.ts (DataDog tracer - MINIMAL VERSION)
      copy:
        dest: "{{ juice_shop_dir }}/tracer.ts"
        content: |
          // tracer.ts
          import tracer from 'dd-trace';
          tracer.init();
          export default tracer;
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    # =======================================================================
    # DOCKERFILE - MATCH LOCAL WORKING SETUP (COMPILE THEN RUN)
    # =======================================================================
    - name: Create Dockerfile
      copy:
        dest: "{{ juice_shop_dir }}/Dockerfile"
        content: |
          # Multi-stage Dockerfile for Juice Shop with Security Tools
          FROM node:22-bookworm-slim AS builder

          RUN apt-get update && apt-get install -y git python3 make g++ && rm -rf /var/lib/apt/lists/*
          WORKDIR /juice-shop

          # Clone Juice Shop
          RUN git clone --depth 1 https://github.com/juice-shop/juice-shop.git . && rm -rf .git

          # Install ALL dependencies (needed for TypeScript compilation)
          RUN npm install

          # Install security tools
          RUN npm install --save-exact @aikidosec/firewall dd-trace

          # Copy tracer
          COPY tracer.ts ./tracer.ts

          # ✅ CRITICAL: Modify TypeScript source files BEFORE compilation
          # 1. Modify app.ts (main entry point)
          RUN sed -i "1i import './tracer' // DataDog APM" app.ts && \
              sed -i "2i import '@aikidosec/firewall' // Aikido RASP" app.ts
          
          # 2. Also modify server.ts (in case it's loaded independently)
          RUN sed -i "1i import './tracer' // DataDog APM" server.ts && \
              sed -i "2i import '@aikidosec/firewall' // Aikido RASP" server.ts

          # Verify modifications
          RUN echo "=== Modified app.ts (first 10 lines) ===" && head -10 app.ts
          RUN echo "=== Modified server.ts (first 10 lines) ===" && head -10 server.ts

          # ✅ COMPILE TypeScript to JavaScript (creates build/ directory)
          # This mimics what happens before running locally
          RUN npx tsc || npm run build:server || echo "TypeScript compilation attempted"
          
          # Verify build directory was created
          RUN ls -la build/ && \
              echo "=== build/app.js (first 30 lines) ===" && \
              head -30 build/app.js && \
              echo "=== Checking for tracer/aikido in build/app.js ===" && \
              grep -E "tracer|aikido" build/app.js | head -5

          # Build frontend (Angular)
          RUN cd frontend && npm install --legacy-peer-deps && \
              node ./node_modules/@angular/cli/bin/ng build --configuration production || echo "Frontend build completed"

          # --- Production stage ---
          FROM node:22-bookworm-slim
          
          RUN apt-get update && apt-get install -y curl procps && rm -rf /var/lib/apt/lists/*
          RUN groupadd -r juiceshop && useradd -r -g juiceshop juiceshop
          
          WORKDIR /juice-shop

          # Copy entire application including compiled build/ directory
          COPY --from=builder --chown=juiceshop:juiceshop /juice-shop /juice-shop

          # Ensure directories exist with correct permissions
          RUN mkdir -p /juice-shop/logs /juice-shop/ftp /juice-shop/data && \
              chown -R juiceshop:juiceshop /juice-shop

          USER juiceshop
          EXPOSE 3000

          HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
            CMD curl -f http://localhost:3000/rest/admin/application-version || exit 1

          ENV NODE_ENV=production \
              PORT=3000 \
              NODE_OPTIONS="--max-old-space-size=2048"
          
          # ✅ This matches your local command: npm start (which runs: node build/app)
          # The compiled build/app.js will have the instrumentation
          CMD ["npm", "start"]
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    # =======================================================================
    # DOCKER COMPOSE WITH ALL ENVIRONMENT VARIABLES
    # =======================================================================
    - name: Create docker-compose.yml
      copy:
        dest: "{{ juice_shop_dir }}/docker-compose.yml"
        content: |
          services:
            juice-shop:
              build: .
              image: juice-shop-secure:latest
              container_name: juice-shop
              restart: unless-stopped
              ports:
                - "3000:3000"
              environment:
                # Node environment
                NODE_ENV: production
                
                # DataDog APM Configuration
                DD_ENV: dev
                DD_SERVICE: juice-shop
                DD_VERSION: latest
                DD_AGENT_HOST: 172.17.0.1
                DD_TRACE_AGENT_PORT: 8126
                
                # DataDog Tracing & Profiling
                DD_LOGS_INJECTION: "true"
                DD_TRACE_SAMPLE_RATE: "1"
                DD_PROFILING_ENABLED: "true"
                DD_RUNTIME_METRICS_ENABLED: "true"
                DD_DATA_STREAMS_ENABLED: "true"
                DD_TRACE_REMOVE_INTEGRATION_SERVICE_NAMES_ENABLED: "true"
                
                # DataDog Security (AppSec & IAST)
                DD_APPSEC_ENABLED: "true"
                DD_IAST_ENABLED: "true"
                
                # Aikido Configuration
                AIKIDO_TOKEN: ${AIKIDO_TOKEN}
                AIKIDO_BLOCK: "false"
                AIKIDO_DEBUG: "true"
                
              env_file:
                - .env
              extra_hosts:
                - "host.docker.internal:host-gateway"
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:3000"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 60s
              logging:
                driver: "json-file"
                options:
                  max-size: "10m"
                  max-file: "3"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Create .env file with secrets
      copy:
        dest: "{{ juice_shop_dir }}/.env"
        content: |
          # Aikido Zen RASP Configuration
          AIKIDO_TOKEN={{ aikido_token }}
          AIKIDO_BLOCK=false
          AIKIDO_DEBUG=true
          
          # DataDog Configuration
          DD_ENV=dev
          DD_VERSION=latest
        owner: ubuntu
        group: ubuntu
        mode: '0600'
      no_log: true

    # =======================================================================
    # DEPLOYMENT SCRIPTS
    # =======================================================================
    - name: Create deploy.sh
      copy:
        dest: "{{ juice_shop_dir }}/deploy.sh"
        content: |
          #!/bin/bash
          set -e
          cd "{{ juice_shop_dir }}"
          
          echo "🚀 Deploying Juice Shop with Security Instrumentation..."
          
          # Stop existing containers
          docker compose down || true
          
          # Remove old images
          docker rmi juice-shop-secure:latest 2>/dev/null || true
          
          # Build with progress output
          echo "📦 Building Docker image (this includes TypeScript compilation)..."
          docker compose build --no-cache --progress=plain
          
          # Start containers
          echo "▶️  Starting containers..."
          docker compose up -d
          
          # Wait for container to be healthy
          echo "⏳ Waiting for application to start..."
          sleep 45
          
          # Verify deployment
          if docker ps | grep -q juice-shop; then
            echo "✅ Container is running"
            
            # Check instrumentation in COMPILED code
            echo ""
            echo "🔍 Verifying Security Instrumentation (Compiled JS):"
            echo "======================================"
            docker exec juice-shop head -20 build/server.js | grep -E "tracer|aikido" || echo "⚠️  Check build/server.js manually"
            
            # Check logs
            echo ""
            echo "📊 Application Logs:"
            docker logs juice-shop 2>&1 | tail -30
            
            # Test application
            if curl -f -s http://localhost:3000 > /dev/null; then
              echo ""
              echo "✅ Application is accessible at http://localhost:3000"
              echo "✅ Deployment successful!"
              echo ""
              echo "🔍 Generate traffic to see traces in DataDog:"
              echo "   for i in {1..20}; do curl -s http://localhost:3000 >/dev/null; done"
            else
              echo "⚠️  Application not responding yet (may need more time)"
            fi
          else
            echo "❌ Deployment failed - container not running"
            docker compose logs
            exit 1
          fi
        mode: '0755'

    - name: Create verification script
      copy:
        dest: "{{ juice_shop_dir }}/verify-instrumentation.sh"
        content: |
          #!/bin/bash
          echo "🔍 Security Instrumentation Verification"
          echo "========================================"
          
          echo ""
          echo "ℹ️  Juice Shop compiles TypeScript then runs: node build/app"
          
          echo ""
          echo "📋 Container Status:"
          docker ps | grep juice-shop || echo "❌ Container not running"
          
          echo ""
          echo "📝 Modified app.ts (TypeScript source - first 12 lines):"
          docker exec juice-shop head -12 app.ts 2>/dev/null || echo "⚠️  Could not read app.ts"
          
          echo ""
          echo "🔧 Compiled build/app.js (what actually runs - first 40 lines):"
          docker exec juice-shop head -40 build/app.js 2>/dev/null || echo "⚠️  Could not read build/app.js"
          
          echo ""
          echo "🔍 Check for instrumentation in compiled code:"
          docker exec juice-shop grep -n -E "tracer|aikido|firewall" build/app.js 2>/dev/null | head -10 || echo "⚠️  Instrumentation not found in build/app.js"
          
          echo ""
          echo "📄 Tracer.ts content:"
          docker exec juice-shop cat tracer.ts 2>/dev/null || echo "⚠️  Could not read tracer.ts"
          
          echo ""
          echo "📄 Compiled build/tracer.js:"
          docker exec juice-shop cat build/tracer.js 2>/dev/null || echo "⚠️  Could not read build/tracer.js"
          
          echo ""
          echo "🔧 Environment Variables (tokens redacted for security):"
          docker exec juice-shop env | grep -E "DD_|AIKIDO_" | sed 's/\(TOKEN\|KEY\)=.*/\1=***REDACTED***/g' | sort
          
          echo ""
          echo "📊 Application Startup Logs (tokens redacted, first 100 lines):"
          docker logs juice-shop 2>&1 | head -100 | sed -E 's/(token|key)=[a-zA-Z0-9_-]{10,}/\1=***REDACTED***/gi'
          
          echo ""
          echo "🔍 AIKIDO Startup Messages (should see 'Starting agent'):"
          docker logs juice-shop 2>&1 | grep "AIKIDO:" | sed -E 's/(token|key)=[a-zA-Z0-9_-]{10,}/\1=***REDACTED***/gi' | head -20
          
          echo ""
          echo "📡 DataDog Agent Status on Host:"
          sudo datadog-agent status | grep -A 10 "APM Agent" 2>/dev/null || echo "⚠️  Run with sudo to see agent status"
          
          echo ""
          echo "🚀 Generate traffic to trigger instrumentation:"
          echo "   for i in {1..50}; do curl -s http://localhost:3000 >/dev/null; curl -s 'http://localhost:3000/rest/products/search?q=test' >/dev/null; sleep 0.5; done"
          
          echo ""
          echo "📊 After generating traffic, check for trace activity:"
          echo "   docker logs juice-shop --tail=100 | sed -E 's/(token|key)=[a-zA-Z0-9_-]{10,}/\1=***REDACTED***/gi' | grep -i -E 'trace|span|aikido'"
        mode: '0755'

  handlers:
    - name: Restart DataDog Agent
      systemd:
        name: datadog-agent
        state: restarted