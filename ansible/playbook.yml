---
- name: Setup IAST vs RASP Environment
  hosts: juiceshop
  become: true

  vars:
    app_dir: /opt/app

  vars_files:
    - secrets.yml

  tasks:
    - name: Install Docker
      shell: |
        curl -fsSL https://get.docker.com -o /tmp/get-docker.sh
        sh /tmp/get-docker.sh
        usermod -aG docker ubuntu
      args:
        creates: /usr/bin/docker

    - name: Install DataDog
      shell: |
        DD_API_KEY={{ datadog_api_key }} DD_SITE={{ datadog_site }} bash -c "$(curl -L https://install.datadoghq.com/scripts/install_script_agent7.sh)"
      args:
        creates: /etc/datadog-agent/datadog.yaml

    - name: Configure DataDog
      lineinfile:
        path: /etc/datadog-agent/datadog.yaml
        line: "{{ item }}"
      loop:
        - "apm_config:"
        - "  enabled: true"

    - name: Create app files
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: ubuntu

    - name: Create Dockerfile
      copy:
        dest: "{{ app_dir }}/Dockerfile"
        content: |
          FROM node:22-slim AS builder
          RUN apt-get update && apt-get install -y git python3 make g++
          WORKDIR /app
          RUN git clone --depth 1 https://github.com/juice-shop/juice-shop.git .
          RUN npm install --legacy-peer-deps && npm install @aikidosec/firewall dd-trace
          
          FROM node:22-slim
          WORKDIR /app
          COPY --from=builder /app /app
          EXPOSE 3000
          CMD ["npm", "start"]

    - name: Create compose file
      copy:
        dest: "{{ app_dir }}/docker-compose.yml"
        content: |
          services:
            app:
              build: .
              ports: ["3000:3000"]
              environment:
                DD_AGENT_HOST: 172.17.0.1
                DD_APPSEC_ENABLED: "${DD_APPSEC:-false}"
                DD_IAST_ENABLED: "${DD_IAST:-false}"
                AIKIDO_TOKEN: "{{ aikido_token }}"
                AIKIDO_BLOCK: "${AIKIDO_BLOCK:-false}"

    - name: Create results dir
      file:
        path: /var/lib/results
        state: directory
        owner: ubuntu

    - name: Start monitoring stack
      block:
        - name: Ensure monitoring directory exists
          file:
            path: /opt/monitoring
            state: directory
            owner: ubuntu

        - name: Create Prometheus config
          copy:
            dest: /opt/monitoring/prometheus.yml
            content: |
              global:
                scrape_interval: 5s
              scrape_configs:
                - job_name: 'pushgateway'
                  static_configs:
                    - targets: ['172.17.0.1:9091']

        - name: Start Pushgateway container
          shell: docker run -d --name pushgateway --restart unless-stopped -p 9091:9091 prom/pushgateway
          ignore_errors: true

        - name: Start Prometheus container
          shell: docker run -d --name prometheus --restart unless-stopped -p 9090:9090 -v /opt/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro prom/prometheus
          ignore_errors: true

        - name: Start Grafana container
          shell: docker run -d --name grafana --restart unless-stopped -p 3001:3000 -e GF_SECURITY_ADMIN_PASSWORD=admin -e GF_INSTALL_PLUGINS=grafana-piechart-panel grafana/grafana
          ignore_errors: true

        - name: Wait for Grafana to be available
          wait_for:
            host: localhost
            port: 3001
            delay: 15
            timeout: 60

        - name: Configure Grafana datasource
          uri:
            url: http://admin:admin@localhost:3001/api/datasources
            method: POST
            headers:
              Content-Type: "application/json"
            body: '{"name":"Prometheus","type":"prometheus","url":"http://172.17.0.1:9090","access":"proxy","isDefault":true}'
            status_code: 200,409
          ignore_errors: true

        - name: Configure Grafana dashboard
          uri:
            url: http://admin:admin@localhost:3001/api/dashboards/db
            method: POST
            headers:
              Content-Type: "application/json"
            body: '{"dashboard":{"title":"IAST vs RASP","panels":[{"id":1,"title":"Blocking Rate %","type":"gauge","targets":[{"expr":"100 * iast_blocked / (iast_zap_alerts + 1)","legendFormat":"IAST"},{"expr":"100 * rasp_blocked / (rasp_zap_alerts + 1)","legendFormat":"RASP"}],"gridPos":{"h":8,"w":12,"x":0,"y":0}},{"id":2,"title":"Attacks Blocked","type":"stat","targets":[{"expr":"iast_blocked","legendFormat":"IAST"},{"expr":"rasp_blocked","legendFormat":"RASP"}],"gridPos":{"h":8,"w":12,"x":12,"y":0}}]},"overwrite":true}'
          ignore_errors: true