---
- name: Configure EC2 for Thesis Experiment
  hosts: juiceshop
  become: true
  gather_facts: true

  vars:
    juice_shop_dir: /opt/juice-shop
    monitoring_dir: /opt/monitoring
    exporter_dir: /opt/security-metrics-exporter
    grafana_port: 3001
    prometheus_port: 9090
    otel_grpc_port: 4317
    otel_http_port: 4318
    # We use the version that works with your Node 22 build strategy
    juice_shop_version: "v16.0.0"

  tasks:
    # --- 0. SYSTEM TUNING (REQUIRED FOR NODE 22 BUILDS) ---
    - name: Check if swap file exists
      stat:
        path: /swapfile
      register: swap_file_check

    - name: Create 4GB Swap file (Prevents OOM during npm install)
      command: fallocate -l 4G /swapfile
      when: not swap_file_check.stat.exists

    - name: Set permissions on swap file
      file:
        path: /swapfile
        mode: '0600'
      when: not swap_file_check.stat.exists

    - name: Make swap file
      command: mkswap /swapfile
      when: not swap_file_check.stat.exists

    - name: Enable swap file
      command: swapon /swapfile
      when: not swap_file_check.stat.exists

    - name: Persist swap in fstab
      mount:
        name: none
        src: /swapfile
        fstype: swap
        opts: sw
        state: present

    # --- 1. SYSTEM PREP ---
    - name: Update APT and install Docker deps
      apt:
        name: [curl, wget, git, unzip, jq, python3-pip, python3-venv, apache2-utils, python3-docker]
        update_cache: yes
        state: present

    - name: Install Docker
      shell: curl -fsSL https://get.docker.com | sh
      args:
        creates: /usr/bin/docker

    - name: Add ubuntu to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    - name: Reset SSH connection
      meta: reset_connection

    # --- 2. MONITORING DIRECTORIES ---
    - name: Create directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: ubuntu
      loop:
        - "{{ monitoring_dir }}/otel-collector"
        - "{{ monitoring_dir }}/prometheus"
        - "{{ monitoring_dir }}/grafana/provisioning/datasources"
        - "{{ monitoring_dir }}/grafana/provisioning/dashboards"
        - "{{ exporter_dir }}"
        - "/opt/security-metrics/data"

    # --- 3. CUSTOM METRICS EXPORTER (NEW) ---
    - name: Create Exporter Script
      copy:
        dest: "{{ exporter_dir }}/exporter.py"
        mode: '0755'
        content: |
          #!/usr/bin/env python3
          import time
          import json
          import os
          import docker
          from prometheus_client import start_http_server, Gauge, Counter
          
          SCENARIO_FILE = '/opt/security-metrics/data/scenario_info.json'
          JUICE_CONTAINER_NAME = 'juice-shop'
          
          SCENARIO_GAUGE = Gauge('thesis_scenario_id', 'Current Thesis Scenario')
          IAST_DETECTIONS = Counter('thesis_iast_detections_total', 'Real-time Datadog IAST Detections')
          RASP_DETECTIONS = Counter('thesis_rasp_detections_total', 'Real-time Aikido RASP Detections')
          RASP_BLOCKS = Counter('thesis_rasp_blocks_total', 'Real-time Aikido RASP Blocks')
          
          def watch_docker_logs():
              client = docker.from_env()
              print(f"üîå Connecting to Docker container: {JUICE_CONTAINER_NAME}")
              while True:
                  try:
                      container = client.containers.get(JUICE_CONTAINER_NAME)
                      for line in container.logs(stream=True, tail=0, follow=True):
                          process_log_line(line.decode('utf-8', errors='ignore'))
                  except Exception as e:
                      print(f"‚ö†Ô∏è  Docker error: {e}. Retrying in 5s...")
                      time.sleep(5)
          
          def process_log_line(line):
              if "dd-trace" in line and "Vulnerability detected" in line:
                  IAST_DETECTIONS.inc()
                  print(f"üö® IAST: {line.strip()[:100]}")
              if "Aikido" in line or "@aikidosec" in line:
                  if "SecurityException" in line or "Blocked" in line or "Attack detected" in line:
                      RASP_DETECTIONS.inc()
                      if "Blocked" in line or "SecurityException" in line:
                          RASP_BLOCKS.inc()
                          print(f"üõ°Ô∏è RASP BLOCK: {line.strip()[:100]}")
                      else:
                          print(f"üëÅÔ∏è RASP DETECT: {line.strip()[:100]}")
          
          def update_scenario():
              try:
                  if os.path.exists(SCENARIO_FILE):
                      with open(SCENARIO_FILE, 'r') as f:
                          data = json.load(f)
                          SCENARIO_GAUGE.set(data.get('scenario_id', 0))
              except: pass
          
          if __name__ == '__main__':
              start_http_server(9999)
              print("üöÄ Exporter running on :9999")
              import threading
              threading.Thread(target=lambda: [update_scenario() or time.sleep(2) for _ in iter(int, 1)], daemon=True).start()
              watch_docker_logs()

    - name: Exporter Dockerfile
      copy:
        dest: "{{ exporter_dir }}/Dockerfile"
        content: |
          FROM python:3.9-slim
          WORKDIR /app
          COPY exporter.py .
          RUN pip install prometheus_client docker
          CMD ["python", "exporter.py"]

    # --- 4. OBSERVABILITY CONFIGS ---
    - name: Configure Grafana Datasource
      copy:
        dest: "{{ monitoring_dir }}/grafana/provisioning/datasources/datasource.yaml"
        content: |
          apiVersion: 1
          datasources:
            - name: Prometheus
              type: prometheus
              access: proxy
              url: http://prometheus:9090
              isDefault: true

    - name: Configure Grafana Provider
      copy:
        dest: "{{ monitoring_dir }}/grafana/provisioning/dashboards/dashboard.yaml"
        content: |
          apiVersion: 1
          providers:
            - name: 'Thesis Results'
              orgId: 1
              folder: ''
              type: file
              options:
                path: /etc/grafana/provisioning/dashboards

    - name: Create Thesis Dashboard JSON
      copy:
        dest: "{{ monitoring_dir }}/grafana/provisioning/dashboards/thesis_dashboard.json"
        mode: '0644'
        content: |
          {
            "dashboard": {
              "id": null,
              "title": "FINAL THESIS: IAST vs RASP Evaluation",
              "tags": ["thesis", "rasp", "security"],
              "timezone": "browser",
              "refresh": "5s",
              "panels": [
                {
                  "id": 1,
                  "title": "üéØ THESIS CONTEXT",
                  "type": "text",
                  "gridPos": {"h": 5, "w": 24, "x": 0, "y": 0},
                  "options": {
                    "mode": "markdown",
                    "content": "# üéì Thesis: IAST vs RASP Comparative Analysis\n\n**Hypothesis:** RASP provides superior security by **actively blocking** attacks that IAST only detects.\n\n### üß™ Scenarios:\n1. **üîµ Baseline:** IAST Detects, Attack **SUCCEEDS (200)**.\n2. **üü† Detection:** RASP Detects, Attack **SUCCEEDS (200)**.\n3. **üü¢ Blocking:** RASP Blocks, Attack **FAILS (403)**."
                  }
                },
                {
                  "id": 2,
                  "title": "ACTIVE SCENARIO",
                  "type": "stat",
                  "gridPos": {"h": 4, "w": 12, "x": 0, "y": 5},
                  "targets": [{"expr": "thesis_scenario_id"}],
                  "options": {"colorMode": "background"},
                  "fieldConfig": {
                    "defaults": {
                      "mappings": [
                        {"type": "value", "value": 1, "text": "1. BASELINE (IAST ONLY)", "color": "blue"},
                        {"type": "value", "value": 2, "text": "2. RASP DETECTION", "color": "orange"},
                        {"type": "value", "value": 3, "text": "3. RASP BLOCKING", "color": "green"}
                      ]
                    }
                  }
                },
                {
                  "id": 3,
                  "title": "üõ°Ô∏è BLOCK RATE",
                  "type": "stat",
                  "gridPos": {"h": 4, "w": 12, "x": 12, "y": 5},
                  "targets": [{"expr": "sum(rate(juice_shop_http_server_request_duration_seconds_count{http_response_status_code=\"403\"}[1m])) / sum(rate(juice_shop_http_server_request_duration_seconds_count[1m])) * 100"}],
                  "fieldConfig": {"defaults": {"unit": "percent", "thresholds": {"steps": [{"color": "red","value": 0},{"color": "green","value": 1}]}}}
                },
                {
                  "id": 4,
                  "title": "‚öîÔ∏è TOOL COMPARISON: Real-Time Log Telemetry",
                  "type": "timeseries",
                  "gridPos": {"h": 10, "w": 24, "x": 0, "y": 9},
                  "targets": [
                    {"expr": "increase(thesis_iast_detections_total[1m])", "legendFormat": "üê∂ Datadog IAST Detections"},
                    {"expr": "increase(thesis_rasp_detections_total[1m])", "legendFormat": "ü•ã Aikido RASP Detections"},
                    {"expr": "increase(thesis_rasp_blocks_total[1m])", "legendFormat": "üõ°Ô∏è Aikido RASP BLOCKS"}
                  ],
                  "fieldConfig": {"defaults": {"custom": {"drawStyle": "bars", "fillOpacity": 40}}}
                },
                {
                  "id": 5,
                  "title": "üõ°Ô∏è HTTP RESPONSE STATUS",
                  "type": "timeseries",
                  "gridPos": {"h": 8, "w": 12, "x": 0, "y": 19},
                  "targets": [
                    {"expr": "sum(rate(juice_shop_http_server_request_duration_seconds_count{http_response_status_code=\"200\"}[1m]))", "legendFormat": "‚úÖ Allowed (200)"},
                    {"expr": "sum(rate(juice_shop_http_server_request_duration_seconds_count{http_response_status_code=\"403\"}[1m]))", "legendFormat": "üö´ Blocked (403)"}
                  ]
                }
              ]
            }
          }

    - name: Configure Prometheus
      copy:
        dest: "{{ monitoring_dir }}/prometheus/prometheus.yml"
        content: |
          global:
            scrape_interval: 2s 
          scrape_configs:
            - job_name: 'thesis-exporter'
              static_configs:
                - targets: ['metrics-exporter:9999']
            - job_name: 'otel-collector'
              static_configs:
                - targets: ['otel-collector:8889']

    - name: Configure Otel Collector
      copy:
        dest: "{{ monitoring_dir }}/otel-collector/otel-collector-config.yaml"
        content: |
          receivers:
            otlp:
              protocols:
                grpc:
                  endpoint: 0.0.0.0:4317
                http:
                  endpoint: 0.0.0.0:4318
          processors:
            batch:
          exporters:
            prometheus:
              endpoint: "0.0.0.0:8889"
              namespace: "juice_shop"
          service:
            pipelines:
              metrics:
                receivers: [otlp]
                processors: [batch]
                exporters: [prometheus]

    # --- 5. JUICE SHOP & AIKIDO SETUP (HYBRID APPROACH) ---
    - name: Clean Juice Shop Dir
      file:
        path: "{{ juice_shop_dir }}"
        state: absent

    - name: Create Juice Shop Dir
      file:
        path: "{{ juice_shop_dir }}"
        state: directory
        owner: ubuntu

    # HYBRID DOCKERFILE: Using Node 22 (your working preference) + Runtime Injection
    - name: Juice Shop Dockerfile
      copy:
        dest: "{{ juice_shop_dir }}/Dockerfile"
        content: |
          FROM node:22-bookworm-slim AS builder
          RUN apt-get update && apt-get install -y git python3 make g++ curl
          WORKDIR /juice-shop
          # Clone Juice Shop v16
          RUN git clone --depth 1 --branch {{ juice_shop_version }} https://github.com/juice-shop/juice-shop.git . && rm -rf .git
          
          # Install deps
          RUN npm install
          
          # Build the server first (pure Juice Shop build)
          RUN npm run build:server
          RUN cd frontend && npm install --legacy-peer-deps && node ./node_modules/@angular/cli/bin/ng build --configuration production
          
          # Install Security Tools AFTER build (No compilation conflicts)
          RUN npm install --save-exact @aikidosec/firewall @opentelemetry/api @opentelemetry/auto-instrumentations-node @opentelemetry/exporter-metrics-otlp-grpc @opentelemetry/resources @opentelemetry/sdk-node --legacy-peer-deps
          
          FROM node:22-bookworm-slim
          WORKDIR /juice-shop
          COPY --from=builder /juice-shop .
          
          # Runtime Injection (No modification of app.ts source code)
          RUN echo "try { require('@aikidosec/firewall'); console.log('‚úÖ Aikido RASP Loaded'); } catch(e) { console.error('‚ùå Aikido Load Failed', e); } \
          const { NodeSDK } = require('@opentelemetry/sdk-node'); \
          const { getNodeAutoInstrumentations } = require('@opentelemetry/auto-instrumentations-node'); \
          const { OTLPMetricExporter } = require('@opentelemetry/exporter-metrics-otlp-grpc'); \
          const { PeriodicExportingMetricReader } = require('@opentelemetry/sdk-metrics'); \
          const metricExporter = new OTLPMetricExporter({url: process.env.OTEL_EXPORTER_OTLP_ENDPOINT}); \
          const metricReader = new PeriodicExportingMetricReader({exporter: metricExporter, exportIntervalMillis: 2000}); \
          const sdk = new NodeSDK({metricReader, instrumentations: [getNodeAutoInstrumentations()]}); \
          sdk.start();" > otel-init.js
          
          EXPOSE 3000
          ENV NODE_ENV=production
          CMD ["node", "--require", "./otel-init.js", "build/app"]

    - name: Create Docker Compose
      copy:
        dest: "{{ juice_shop_dir }}/docker-compose.yml"
        content: |
          services:
            juice-shop:
              build: .
              container_name: juice-shop
              ports: ["3000:3000"]
              environment:
                - NODE_ENV=production
                - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
                - DD_API_KEY={{ datadog_api_key }}
                - AIKIDO_TOKEN={{ aikido_token }}
                - AIKIDO_BLOCK=${AIKIDO_BLOCK} 
                - AIKIDO_DISABLE=${AIKIDO_DISABLE}
              depends_on: [otel-collector]
              networks: [thesis-net]

            metrics-exporter:
              build: {{ exporter_dir }}
              container_name: metrics-exporter
              volumes:
                - /opt/security-metrics/data:/opt/security-metrics/data
                - /var/run/docker.sock:/var/run/docker.sock
              ports: ["9999:9999"]
              networks: [thesis-net]

            otel-collector:
              image: otel/opentelemetry-collector-contrib:latest
              command: ["--config=/etc/otel-collector-config.yaml"]
              volumes:
                - {{ monitoring_dir }}/otel-collector/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
              ports: ["4317:4317", "4318:4318", "8889:8889"]
              networks: [thesis-net]

            prometheus:
              image: prom/prometheus:latest
              volumes:
                - {{ monitoring_dir }}/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
              ports: ["9090:9090"]
              networks: [thesis-net]

            grafana:
              image: grafana/grafana:latest
              volumes:
                - {{ monitoring_dir }}/grafana/provisioning:/etc/grafana/provisioning
              ports: ["{{ grafana_port }}:3000"]
              environment:
                - GF_SECURITY_ADMIN_PASSWORD=admin
              networks: [thesis-net]

          networks:
            thesis-net:
              driver: bridge

    # --- 6. CONTROL SCRIPTS ---
    - name: Create Scenario Switch Script
      copy:
        dest: "/home/ubuntu/run_scenario.sh"
        mode: '0755'
        owner: ubuntu
        content: |
          #!/bin/bash
          set -e
          MODE=$1
          cd /opt/juice-shop
          
          # Setup variables
          A_DISABLE="true"
          A_BLOCK="false"
          S_ID=1

          if [ "$MODE" == "detection" ]; then
             A_DISABLE="false"
             A_BLOCK="false"
             S_ID=2
          elif [ "$MODE" == "blocking" ]; then
             A_DISABLE="false"
             A_BLOCK="true"
             S_ID=3
          fi

          echo "{\"scenario_id\": $S_ID, \"mode\": \"$MODE\"}" > /opt/security-metrics/data/scenario_info.json
          
          # Create .env for Docker
          echo "AIKIDO_DISABLE=$A_DISABLE" > .env
          echo "AIKIDO_BLOCK=$A_BLOCK" >> .env
          echo "SCENARIO_ID=$S_ID" >> .env
          
          echo "‚úÖ Config updated for $MODE."

    # --- 7. PROJECT STARTUP (ASYNC BUILD FROM SOURCE) ---
    - name: Initialize Config
      shell: "/home/ubuntu/run_scenario.sh baseline"

    - name: üèóÔ∏è Build Containers (Source Build)
      shell: "docker compose build"
      args:
        chdir: "{{ juice_shop_dir }}"
      async: 2400  # 40 Minutes allowed for source build
      poll: 30

    - name: üöÄ Start Containers
      shell: "docker compose up -d"
      args:
        chdir: "{{ juice_shop_dir }}"

    - name: ‚è≥ Wait for Port 3000
      wait_for:
        port: 3000
        delay: 10
        timeout: 600
        msg: "Juice Shop failed to start on port 3000"