name: Juice Shop Fresh Start

on:
  push:
    branches:
      - dev-test
    paths:
      - 'docker-compose.yml'
      - 'Dockerfile'
      - '.github/workflows/juice-fresh-start.yml'
  pull_request:
    branches:
      - dev-test

env:
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain

jobs:
  fresh-deployment:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Clean Docker environment
        run: |
          docker system prune -af --volumes
          docker network prune -f

      - name: Configure DataDog credentials
        run: |
          echo "DD_API_KEY=${{ secrets.DD_API_KEY }}" >> $GITHUB_ENV
          echo "DD_APP_KEY=${{ secrets.DD_APP_KEY }}" >> $GITHUB_ENV
          echo "DD_SITE=${{ secrets.DD_SITE }}" >> $GITHUB_ENV

      - name: Configure Aikido credentials
        run: |
          echo "AIKIDO_TOKEN=${{ secrets.AIKIDO_TOKEN }}" >> $GITHUB_ENV

      - name: Build Docker images
        run: |
          docker compose -f docker-compose.yml build --no-cache

      - name: Start services
        run: |
          docker compose -f docker-compose.yml up -d
          sleep 45

      - name: Verify service health
        run: |
          echo "Checking Juice Shop health..."
          for i in {1..30}; do
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "✅ Juice Shop is healthy"
              break
            fi
            echo "Waiting for Juice Shop... (attempt $i/30)"
            sleep 10
          done
          
          echo "Checking Prometheus health..."
          for i in {1..12}; do
            if curl -f http://localhost:9090/-/healthy > /dev/null 2>&1; then
              echo "✅ Prometheus is healthy"
              break
            fi
            echo "Waiting for Prometheus... (attempt $i/12)"
            sleep 5
          done
          
          echo "Checking Grafana health..."
          for i in {1..12}; do
            if curl -f http://localhost:3001/api/health > /dev/null 2>&1; then
              echo "✅ Grafana is healthy"
              break
            fi
            echo "Waiting for Grafana... (attempt $i/12)"
            sleep 5
          done

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          
          # Test Juice Shop
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000)
          if [ "$RESPONSE" = "200" ]; then
            echo "✅ Juice Shop responding"
          else
            echo "❌ Juice Shop not responding (HTTP $RESPONSE)"
            exit 1
          fi
          
          # Test Prometheus
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9090/-/healthy)
          if [ "$RESPONSE" = "200" ]; then
            echo "✅ Prometheus responding"
          else
            echo "❌ Prometheus not responding (HTTP $RESPONSE)"
            exit 1
          fi
          
          # Test Grafana
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/api/health)
          if [ "$RESPONSE" = "200" ]; then
            echo "✅ Grafana responding"
          else
            echo "❌ Grafana not responding (HTTP $RESPONSE)"
            exit 1
          fi

      - name: Display container logs
        if: failure()
        run: |
          echo "=== Docker Compose Services ==="
          docker compose -f docker-compose.yml ps
          echo ""
          echo "=== Juice Shop Logs ==="
          docker compose -f docker-compose.yml logs juice-shop
          echo ""
          echo "=== Prometheus Logs ==="
          docker compose -f docker-compose.yml logs prometheus
          echo ""
          echo "=== Grafana Logs ==="
          docker compose -f docker-compose.yml logs grafana

      - name: Generate deployment report
        run: |
          echo "## Fresh Deployment Report" > deployment-report.md
          echo "**Date:** $(date)" >> deployment-report.md
          echo "**Branch:** ${GITHUB_REF_NAME}" >> deployment-report.md
          echo "**Commit:** ${GITHUB_SHA}" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### Services Status" >> deployment-report.md
          docker compose -f docker-compose.yml ps >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### Docker Images" >> deployment-report.md
          docker images | grep -E 'juice|prometheus|grafana' >> deployment-report.md || true

      - name: Upload deployment report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deployment-report-${{ github.run_number }}
          path: deployment-report.md

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.yml down -v
          docker system prune -af
