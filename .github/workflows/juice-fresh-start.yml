name: DevSecOps Pipeline - Fresh Start (Full Deployment + Testing)

on:
  push:
    branches:
      - dev-test
  pull_request:
    branches:
      - dev-test
  workflow_dispatch:
    inputs:
      run_full_deployment:
        description: "Run full infrastructure + Juice Shop deployment"
        required: false
        type: boolean
        default: true
      run_scenarios:
        description: "Run testing scenarios after deployment"
        required: false
        type: choice
        options:
          - all
          - iast-only
          - iast-rasp-detect
          - iast-rasp-block
          - none
        default: all

env:
  EC2_INSTANCE_IP: ${{ secrets.EC2_INSTANCE_IP }}
  SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
  EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
  ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

jobs:
  # =========================================================================
  # JOB 1: SAST - Semgrep
  # =========================================================================
  sast-semgrep:
    name: üîç SAST - Semgrep
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Semgrep Scan
        run: |
          semgrep scan --config=auto --json --output=semgrep-results.json || true
          semgrep scan --config=auto --sarif --output=semgrep-results.sarif || true
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload to Semgrep Dashboard
        if: always()
        run: semgrep ci
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        continue-on-error: true

      - name: Upload Semgrep Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: |
            semgrep-results.json
            semgrep-results.sarif

  # =========================================================================
  # JOB 2: Prerequisites Check
  # =========================================================================
  check-prerequisites:
    name: ‚úÖ Verify Prerequisites
    runs-on: ubuntu-latest
    needs: sast-semgrep
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
    steps:
      - name: Check Required Secrets
        id: check
        run: |
          MISSING_SECRETS=()
          if [ -z "${{ secrets.EC2_INSTANCE_IP }}" ]; then
            MISSING_SECRETS+=("EC2_INSTANCE_IP")
          fi
          if [ -z "${{ secrets.EC2_SSH_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS+=("EC2_SSH_PRIVATE_KEY")
          fi
          if [ -z "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" ]; then
            MISSING_SECRETS+=("ANSIBLE_VAULT_PASSWORD")
          fi
          if [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
            echo "::error::Missing secrets: ${MISSING_SECRETS[*]}"
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "‚úÖ All secrets configured"
          echo "can_proceed=true" >> $GITHUB_OUTPUT

  # =========================================================================
  # JOB 3: Configure Infrastructure with OpenTelemetry
  # =========================================================================
  configure-infrastructure:
    name: ‚öôÔ∏è Configure Infrastructure (Fresh Instance)
    runs-on: ubuntu-latest
    needs: check-prerequisites
    if: |
      needs.check-prerequisites.outputs.can_proceed == 'true' &&
      (github.event.inputs.run_full_deployment == 'true' || github.event.inputs.run_full_deployment == '')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: pip install ansible boto3 botocore

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Wait for SSH
        run: |
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
               -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} \
               "echo 'SSH ready'" 2>/dev/null; then
              echo "‚úÖ SSH ready"
              exit 0
            fi
            echo "Attempt $i/30..."
            sleep 10
          done
          exit 1

      - name: Create Ansible Inventory
        run: |
          mkdir -p ansible
          cat > ansible/inventory.ini <<EOF
          [juiceshop]
          ${{ env.EC2_INSTANCE_IP }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF

      - name: Create Vault Password
        run: |
          cd ansible
          echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault_pass
          chmod 600 .vault_pass

      - name: Run Ansible Playbook (Full Infrastructure Setup)
        run: |
          cd ansible
          ansible-playbook -i inventory.ini playbook.yml --vault-password-file .vault_pass -v

      - name: Clean Up Vault
        if: always()
        run: rm -f ansible/.vault_pass

  # =========================================================================
  # JOB 4: Initial Juice Shop Deployment
  # =========================================================================
  initial-deployment:
    name: üöÄ Initial Juice Shop Deployment
    runs-on: ubuntu-latest
    needs: [check-prerequisites, configure-infrastructure]
    if: |
      always() &&
      needs.check-prerequisites.outputs.can_proceed == 'true' &&
      needs.configure-infrastructure.result == 'success' &&
      (github.event.inputs.run_full_deployment == 'true' || github.event.inputs.run_full_deployment == '')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH with Keepalive
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

          cat >> ~/.ssh/config <<EOF
          Host ec2
            HostName ${{ env.EC2_INSTANCE_IP }}
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            ServerAliveInterval 30
            ServerAliveCountMax 120
            TCPKeepAlive yes
          EOF

      - name: Build Juice Shop Container (One-Time Build)
        run: |
          ssh ec2 << 'BUILD'
            set -e
            cd /opt/juice-shop
            
            echo "üèóÔ∏è  INITIAL JUICE SHOP BUILD - STARTING"
            echo "========================================"
            
            # Clean any previous containers
            docker compose down -v 2>/dev/null || true
            docker rm -f juice-shop 2>/dev/null || true
            
            # Build the image (this takes ~10 minutes)
            echo "‚è≥ Building Docker image (this will take several minutes)..."
            docker compose build --no-cache 2>&1 | tee /tmp/initial-build.log &
            BUILD_PID=$!
            
            # Monitor build progress
            TAIL_PID=""
            (tail -f /tmp/initial-build.log 2>/dev/null | grep -E "Step|Successfully|ERROR" &)
            TAIL_PID=$!
            
            # Wait for build to complete (30 minute timeout)
            TIMEOUT=1800
            ELAPSED=0
            while kill -0 $BUILD_PID 2>/dev/null; do
              sleep 30
              ELAPSED=$((ELAPSED + 30))
              echo "‚è±Ô∏è  Build in progress... ${ELAPSED}s / ${TIMEOUT}s"
              
              if [ $ELAPSED -ge $TIMEOUT ]; then
                kill $BUILD_PID 2>/dev/null || true
                kill $TAIL_PID 2>/dev/null || true
                echo "‚ùå Build timeout after ${TIMEOUT}s"
                exit 1
              fi
            done
            
            wait $BUILD_PID
            BUILD_EXIT=$?
            kill $TAIL_PID 2>/dev/null || true
            
            if [ $BUILD_EXIT -ne 0 ]; then
              echo "‚ùå Build failed!"
              tail -100 /tmp/initial-build.log
              exit 1
            fi
            
            echo "‚úÖ Docker image built successfully!"
            docker images | grep juice-shop-secure || echo "‚ö†Ô∏è  Image not found in listing"
            
            # Deploy in default configuration (IAST enabled, RASP disabled)
            echo ""
            echo "üöÄ Deploying application in default state..."
            echo "   - DataDog IAST: ENABLED"
            echo "   - Aikido RASP: DISABLED"
            
            # Update docker-compose.yml for default state
            cat > docker-compose.yml <<EOF
          services:
            juice-shop:
              build: .
              image: juice-shop-secure:latest
              container_name: juice-shop
              restart: unless-stopped
              ports:
                - "3000:3000"
              environment:
                NODE_ENV: production
                
                # DataDog Configuration - ENABLED
                DD_ENV: dev
                DD_SERVICE: juice-shop
                DD_VERSION: latest
                DD_AGENT_HOST: 172.17.0.1
                DD_TRACE_AGENT_PORT: 8126
                DD_LOGS_INJECTION: "true"
                DD_TRACE_SAMPLE_RATE: "1"
                DD_APPSEC_ENABLED: "true"
                DD_IAST_ENABLED: "true"
                
                # Aikido Configuration - DISABLED (default state)
                AIKIDO_BLOCK: "false"
                AIKIDO_DEBUG: "false"
                
              env_file:
                - .env
              extra_hosts:
                - "host.docker.internal:host-gateway"
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:3000"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 60s
          EOF
            
            # Start application
            docker compose up -d
            
            echo "‚è≥ Waiting 90s for application startup..."
            sleep 90
            
            # Verify deployment
            if docker ps | grep -q juice-shop; then
              echo "‚úÖ Juice Shop deployed successfully!"
              echo ""
              echo "üìä Container Status:"
              docker ps --filter "name=juice-shop" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              echo ""
              echo "üîç Recent Logs:"
              docker logs juice-shop 2>&1 | tail -30
              echo ""
              
              # Health check
              if curl -f http://localhost:3000 >/dev/null 2>&1; then
                echo "‚úÖ Health check passed - Application is responding"
              else
                echo "‚ö†Ô∏è  Warning: Health check failed, but container is running"
              fi
              
              # Create tracking file
              cat > /opt/security-metrics/data/deployment_info.json <<TRACK
          {
            "deployment_status": "success",
            "deployment_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "image": "juice-shop-secure:latest",
            "default_state": "iast-only",
            "ready_for_testing": true
          }
          TRACK
              
              echo ""
              echo "=========================================="
              echo "‚úÖ INITIAL DEPLOYMENT COMPLETE"
              echo "=========================================="
              echo "üéØ Ready for scenario testing!"
              
            else
              echo "‚ùå Deployment failed - container not running"
              docker compose logs --tail=100
              exit 1
            fi
          BUILD

      - name: Verify Deployment Health
        run: |
          echo "üè• Running comprehensive health checks..."

          # Test application endpoint
          if curl -f http://${{ env.EC2_INSTANCE_IP }}:3000 >/dev/null 2>&1; then
            echo "‚úÖ Application HTTP endpoint: OK"
          else
            echo "‚ùå Application HTTP endpoint: FAILED"
            exit 1
          fi

          # Test Prometheus endpoint
          if curl -f http://${{ env.EC2_INSTANCE_IP }}:9090/-/healthy >/dev/null 2>&1; then
            echo "‚úÖ Prometheus: OK"
          else
            echo "‚ö†Ô∏è  Prometheus: CHECK MANUALLY"
          fi

          # Test Grafana endpoint
          if curl -f http://${{ env.EC2_INSTANCE_IP }}:3001/api/health >/dev/null 2>&1; then
            echo "‚úÖ Grafana: OK"
          else
            echo "‚ö†Ô∏è  Grafana: CHECK MANUALLY"
          fi

          echo ""
          echo "‚úÖ All critical health checks passed!"
          echo "üéØ System ready for three-scenario testing"

  # =========================================================================
  # JOB 5: SCENARIO 1 - IAST Only
  # =========================================================================
  scenario1-iast-only:
    name: üî¨ Scenario 1 - IAST Only (No RASP)
    runs-on: ubuntu-latest
    needs: [check-prerequisites, initial-deployment]
    if: |
      always() &&
      needs.check-prerequisites.outputs.can_proceed == 'true' &&
      needs.initial-deployment.result == 'success' &&
      (github.event.inputs.run_scenarios == 'all' || github.event.inputs.run_scenarios == 'iast-only' || github.event.inputs.run_scenarios == '')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH with Keepalive
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

          cat >> ~/.ssh/config <<EOF
          Host ec2
            HostName ${{ env.EC2_INSTANCE_IP }}
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            ServerAliveInterval 30
            ServerAliveCountMax 120
            TCPKeepAlive yes
          EOF

      - name: Configure Application - IAST Only
        run: |
          ssh ec2 << 'SCENARIO'
            set -e
            cd /opt/juice-shop
            
            echo "üî¨ SCENARIO 1: DataDog IAST ON, Aikido RASP OFF"
            echo "=============================================="
            
            # Update scenario tracking
            cat > /opt/security-metrics/data/scenario_info.json <<EOF
          {
            "current_scenario": "iast-only",
            "scenario_id": 1,
            "scenario_name": "IAST Only - Detection Only",
            "rasp_enabled": false,
            "rasp_blocking": false,
            "iast_enabled": true,
            "start_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
            
            # Update docker-compose.yml
            cat > docker-compose.yml <<EOF
          services:
            juice-shop:
              image: juice-shop-secure:latest
              container_name: juice-shop
              restart: unless-stopped
              ports:
                - "3000:3000"
              environment:
                NODE_ENV: production
                DD_ENV: dev
                DD_SERVICE: juice-shop
                DD_VERSION: latest
                DD_AGENT_HOST: 172.17.0.1
                DD_TRACE_AGENT_PORT: 8126
                DD_LOGS_INJECTION: "true"
                DD_TRACE_SAMPLE_RATE: "1"
                DD_APPSEC_ENABLED: "true"
                DD_IAST_ENABLED: "true"
                AIKIDO_BLOCK: "false"
                AIKIDO_DEBUG: "false"
              env_file:
                - .env
              extra_hosts:
                - "host.docker.internal:host-gateway"
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:3000"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 60s
          EOF
            
            docker compose down
            docker compose up -d
            
            sleep 45
            
            if docker ps | grep -q juice-shop; then
              echo "‚úÖ Scenario 1 configured - IAST ONLY mode"
              docker logs juice-shop 2>&1 | tail -15
            else
              echo "‚ùå Configuration failed"
              exit 1
            fi
          SCENARIO

      - name: Run DAST Testing - Scenario 1
        run: |
          echo "üß™ Running DAST tests for Scenario 1 (IAST Only)"

          docker run --rm -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 \
            -J scenario1-baseline.json -r scenario1-baseline.html || true

          docker run --rm -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 \
            -J scenario1-full.json -r scenario1-full.html -m 5 -T 180 || true

          echo "üéØ Launching attacks (expecting 0% BLOCKS - detection only)..."
          for i in {1..15}; do
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=<script>alert($i)</script>" || true
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=' OR '1'='1" || true
            sleep 2
          done

          echo "‚úÖ Scenario 1 complete - Check Grafana for IAST detections (0 blocks expected)"

      - name: Upload Scenario 1 Results
        uses: actions/upload-artifact@v4
        with:
          name: scenario1-iast-only-results
          path: |
            scenario1-*.json
            scenario1-*.html

  # =========================================================================
  # JOB 6: SCENARIO 2A - IAST + RASP (Detection Only)
  # =========================================================================
  scenario2a-iast-rasp-detect:
    name: üîç Scenario 2A - IAST + RASP (Detection)
    runs-on: ubuntu-latest
    needs: [check-prerequisites, scenario1-iast-only]
    if: |
      always() &&
      needs.check-prerequisites.outputs.can_proceed == 'true' &&
      needs.scenario1-iast-only.result == 'success' &&
      (github.event.inputs.run_scenarios == 'all' || github.event.inputs.run_scenarios == 'iast-rasp-detect' || github.event.inputs.run_scenarios == '')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH with Keepalive
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

          cat >> ~/.ssh/config <<EOF
          Host ec2
            HostName ${{ env.EC2_INSTANCE_IP }}
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            ServerAliveInterval 30
            ServerAliveCountMax 120
            TCPKeepAlive yes
          EOF

      - name: Configure Application - IAST + RASP Detection
        run: |
          ssh ec2 << 'SCENARIO'
            set -e
            cd /opt/juice-shop
            
            echo "üîç SCENARIO 2A: IAST + RASP (Detection Only)"
            echo "============================================"
            
            cat > /opt/security-metrics/data/scenario_info.json <<EOF
          {
            "current_scenario": "iast-rasp-detect",
            "scenario_id": 2,
            "scenario_name": "IAST + RASP - Detection Only",
            "rasp_enabled": true,
            "rasp_blocking": false,
            "iast_enabled": true,
            "start_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
            
            cat > docker-compose.yml <<EOF
          services:
            juice-shop:
              image: juice-shop-secure:latest
              container_name: juice-shop
              restart: unless-stopped
              ports:
                - "3000:3000"
              environment:
                NODE_ENV: production
                DD_ENV: dev
                DD_SERVICE: juice-shop
                DD_VERSION: latest
                DD_AGENT_HOST: 172.17.0.1
                DD_TRACE_AGENT_PORT: 8126
                DD_LOGS_INJECTION: "true"
                DD_TRACE_SAMPLE_RATE: "1"
                DD_APPSEC_ENABLED: "true"
                DD_IAST_ENABLED: "true"
                AIKIDO_BLOCK: "false"
                AIKIDO_DEBUG: "true"
              env_file:
                - .env
              extra_hosts:
                - "host.docker.internal:host-gateway"
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:3000"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 60s
          EOF
            
            docker compose down
            docker compose up -d
            
            sleep 45
            
            if docker ps | grep -q juice-shop; then
              echo "‚úÖ Scenario 2A configured - RASP DETECTION mode"
              docker logs juice-shop 2>&1 | grep -i "aikido" | tail -10
            else
              echo "‚ùå Configuration failed"
              exit 1
            fi
          SCENARIO

      - name: Run DAST Testing - Scenario 2A
        run: |
          echo "üß™ Running DAST tests for Scenario 2A (RASP Detection)"

          docker run --rm -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 \
            -J scenario2a-baseline.json -r scenario2a-baseline.html || true

          docker run --rm -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 \
            -J scenario2a-full.json -r scenario2a-full.html -m 5 -T 180 || true

          echo "üéØ Launching attacks (expecting 0% BLOCKS - detection mode)..."
          for i in {1..15}; do
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=<script>alert($i)</script>" || true
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=' OR '1'='1" || true
            sleep 2
          done

          echo "‚úÖ Scenario 2A complete - Check Grafana for IAST + RASP detections (0 blocks)"

      - name: Upload Scenario 2A Results
        uses: actions/upload-artifact@v4
        with:
          name: scenario2a-iast-rasp-detect-results
          path: |
            scenario2a-*.json
            scenario2a-*.html

  # =========================================================================
  # JOB 7: SCENARIO 2B - IAST + RASP (Blocking Mode)
  # =========================================================================
  scenario2b-iast-rasp-block:
    name: üõ°Ô∏è Scenario 2B - IAST + RASP (Blocking)
    runs-on: ubuntu-latest
    needs: [check-prerequisites, scenario2a-iast-rasp-detect]
    if: |
      always() &&
      needs.check-prerequisites.outputs.can_proceed == 'true' &&
      needs.scenario2a-iast-rasp-detect.result == 'success' &&
      (github.event.inputs.run_scenarios == 'all' || github.event.inputs.run_scenarios == 'iast-rasp-block' || github.event.inputs.run_scenarios == '')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH with Keepalive
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

          cat >> ~/.ssh/config <<EOF
          Host ec2
            HostName ${{ env.EC2_INSTANCE_IP }}
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            ServerAliveInterval 30
            ServerAliveCountMax 120
            TCPKeepAlive yes
          EOF

      - name: Configure Application - IAST + RASP Blocking
        run: |
          ssh ec2 << 'SCENARIO'
            set -e
            cd /opt/juice-shop
            
            echo "üõ°Ô∏è  SCENARIO 2B: IAST + RASP (Blocking Mode)"
            echo "============================================"
            
            cat > /opt/security-metrics/data/scenario_info.json <<EOF
          {
            "current_scenario": "iast-rasp-block",
            "scenario_id": 3,
            "scenario_name": "IAST + RASP - Active Blocking",
            "rasp_enabled": true,
            "rasp_blocking": true,
            "iast_enabled": true,
            "start_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
            
            cat > docker-compose.yml <<EOF
          services:
            juice-shop:
              image: juice-shop-secure:latest
              container_name: juice-shop
              restart: unless-stopped
              ports:
                - "3000:3000"
              environment:
                NODE_ENV: production
                DD_ENV: dev
                DD_SERVICE: juice-shop
                DD_VERSION: latest
                DD_AGENT_HOST: 172.17.0.1
                DD_TRACE_AGENT_PORT: 8126
                DD_LOGS_INJECTION: "true"
                DD_TRACE_SAMPLE_RATE: "1"
                DD_APPSEC_ENABLED: "true"
                DD_IAST_ENABLED: "true"
                AIKIDO_BLOCK: "true"
                AIKIDO_DEBUG: "true"
              env_file:
                - .env
              extra_hosts:
                - "host.docker.internal:host-gateway"
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:3000"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 60s
          EOF
            
            docker compose down
            docker compose up -d
            
            sleep 45
            
            if docker ps | grep -q juice-shop; then
              echo "‚úÖ Scenario 2B configured - RASP BLOCKING mode"
              docker logs juice-shop 2>&1 | grep -i "aikido\|block" | tail -10
            else
              echo "‚ùå Configuration failed"
              exit 1
            fi
          SCENARIO

      - name: Run DAST Testing - Scenario 2B (Blocking Mode)
        run: |
          echo "üß™ Running DAST tests for Scenario 2B (RASP Blocking)"

          docker run --rm -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 \
            -J scenario2b-baseline.json -r scenario2b-baseline.html || true

          docker run --rm -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 \
            -J scenario2b-full.json -r scenario2b-full.html -m 5 -T 180 || true

          echo "üéØ Launching attacks (expecting HIGH BLOCK RATE ~80%)..."
          BLOCKED_COUNT=0
          TOTAL_ATTEMPTS=30

          for i in $(seq 1 $TOTAL_ATTEMPTS); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=<script>alert(1)</script>")
            if [ "$HTTP_CODE" == "403" ] || [ "$HTTP_CODE" == "418" ]; then
              BLOCKED_COUNT=$((BLOCKED_COUNT + 1))
              echo "‚úÖ Attack $i: BLOCKED (HTTP $HTTP_CODE)"
            else
              echo "‚ö†Ô∏è  Attack $i: Passed (HTTP $HTTP_CODE)"
            fi
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=' OR '1'='1")
            if [ "$HTTP_CODE" == "403" ] || [ "$HTTP_CODE" == "418" ]; then
              BLOCKED_COUNT=$((BLOCKED_COUNT + 1))
              echo "‚úÖ Attack $i: BLOCKED (HTTP $HTTP_CODE)"
            else
              echo "‚ö†Ô∏è  Attack $i: Passed (HTTP $HTTP_CODE)"
            fi
            
            sleep 2
          done

          BLOCK_RATE=$((BLOCKED_COUNT * 100 / (TOTAL_ATTEMPTS * 2)))
          echo ""
          echo "üìä BLOCKING STATISTICS:"
          echo "   Total Attack Attempts: $((TOTAL_ATTEMPTS * 2))"
          echo "   Blocked: $BLOCKED_COUNT"
          echo "   Block Rate: ${BLOCK_RATE}%"
          echo ""

          if [ $BLOCK_RATE -ge 60 ]; then
            echo "‚úÖ Scenario 2B complete - RASP blocking working effectively (${BLOCK_RATE}%)"
          else
            echo "‚ö†Ô∏è  Warning: Block rate below expected (${BLOCK_RATE}% < 60%)"
          fi

      - name: Upload Scenario 2B Results
        uses: actions/upload-artifact@v4
        with:
          name: scenario2b-iast-rasp-block-results
          path: |
            scenario2b-*.json
            scenario2b-*.html

  # =========================================================================
  # JOB 8: Generate Comprehensive Comparison Report
  # =========================================================================
  generate-comparison:
    name: üìä Generate Three-Scenario Comparison
    runs-on: ubuntu-latest
    needs:
      [
        scenario1-iast-only,
        scenario2a-iast-rasp-detect,
        scenario2b-iast-rasp-block,
      ]
    if: always()
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Generate Comprehensive Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # üîí Fresh Start Deployment + Three-Scenario Testing Complete

          **Pipeline Run:** #${{ github.run_number }}  
          **Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ## Deployment Summary

          ‚úÖ **Infrastructure:** Fully deployed from scratch  
          ‚úÖ **Juice Shop Build:** One-time build completed (~10 minutes)  
          ‚úÖ **Initial State:** IAST enabled, RASP disabled  
          ‚úÖ **Testing:** All three scenarios executed  

          ## Test Scenarios Executed

          | Scenario | Configuration | RASP Mode | Expected Blocks | Status |
          |----------|--------------|-----------|----------------|--------|
          | **Scenario 1** | IAST Only | N/A | 0% | ${{ needs.scenario1-iast-only.result }} |
          | **Scenario 2A** | IAST + RASP | Detection Only | 0% | ${{ needs.scenario2a-iast-rasp-detect.result }} |
          | **Scenario 2B** | IAST + RASP | Blocking Mode | ~80% | ${{ needs.scenario2b-iast-rasp-block.result }} |

          ## Key Findings Summary

          ### Scenario 1: IAST Only (Baseline)
          - ‚úÖ **Detection:** IAST active
          - ‚ùå **Blocking:** None (0%)
          - üìä **Result:** Vulnerabilities detected but NOT prevented
          - üéØ **Purpose:** Establish detection-only baseline

          ### Scenario 2A: IAST + RASP (Detection Only)
          - ‚úÖ **Detection:** IAST + RASP active
          - ‚ùå **Blocking:** Disabled (0%)
          - üìä **Result:** Enhanced detection from both tools
          - üéØ **Purpose:** Compare detection capabilities without blocking

          ### Scenario 2B: IAST + RASP (Blocking Mode)
          - ‚úÖ **Detection:** IAST + RASP active
          - ‚úÖ **Blocking:** Enabled (~80% expected)
          - üìä **Result:** Attacks detected AND actively prevented
          - üéØ **Purpose:** Demonstrate RASP protection capability

          ## Data Analysis Locations

          1. üìä **Grafana Dashboard:** http://${{ secrets.EC2_INSTANCE_IP }}:3001
             - View "IAST vs RASP Three-Scenario Comparison"
             - Real-time metrics and historical trends

          2. üìà **Prometheus:** http://${{ secrets.EC2_INSTANCE_IP }}:9090
             - Query raw OpenTelemetry metrics
             - Custom metric exploration

          3. üîç **DataDog IAST Dashboard**
             - IAST vulnerability detections across all scenarios

          4. üõ°Ô∏è **Aikido Dashboard**
             - RASP detection and blocking events

          ## System Status

          - üöÄ **Juice Shop:** Running on port 3000
          - üìä **Prometheus:** Running on port 9090
          - üìà **Grafana:** Running on port 3001
          - üîß **OpenTelemetry Collector:** Active
          - üì° **DataDog Agent:** Active
          - üõ°Ô∏è **Security Metrics Exporter:** Active

          ---

          **üéì Thesis Validation:** Fresh deployment complete. All three scenarios executed successfully.
          Use daily testing workflow for routine tests without full rebuild.
          EOF
