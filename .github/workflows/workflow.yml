name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: ["main", "dev-test"]
  workflow_dispatch: {}

env:
  EC2_INSTANCE_IP: ${{ secrets.EC2_INSTANCE_IP }}
  EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
  SSH_USER: ${{secrets.SSH_USER}}

jobs:
  sast:
    name: SAST - Semgrep Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep and Upload to Dashboard
        run: |
          semgrep scan \
            --config=auto \
            --publish-token="${{ secrets.SEMGREP_APP_TOKEN }}" \
            --publish-deployment="github-actions" \
            --json --output=semgrep-results.json || true

      - uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.json

  deploy:
    name: Deploy and Config
    runs-on: ubuntu-latest
    needs: sast
    steps:
      - uses: actions/checkout@v3
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$EC2_INSTANCE_IP" >> ~/.ssh/known_hosts
      - name: Install Ansible
        run: sudo apt-get install -y ansible sshpass
      - name: Create Inventory
        run: |
          echo "[juiceshop]" > inventory.ini
          echo "$EC2_INSTANCE_IP ansible_user=$SSH_USER ansible_ssh_private_key_file=~/.ssh/id_rsa" >> inventory.ini
      - name: Run Ansible Playbook
        run: |
          ansible-playbook -i inventory.ini ansible/playbook.yml \
          -e "datadog_api_key=${{ secrets.DATADOG_API_KEY }}" \
          -e "datadog_app_key=${{ secrets.DATADOG_APP_KEY }}" \
          -e "datadog_site=${{ secrets.DATADOG_SITE }}" \
          -e "aikido_token=${{ secrets.ZEN_FIREWALL_TOKEN }}"

  dast:
    name: DAST - OWASP ZAP Baseline Scan
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - uses: actions/checkout@v3

      - name: Wait for Application Startup
        run: |
          echo "Waiting for Juice Shop to be ready..."
          for i in {1..30}; do
            if curl -s --head --fail "http://${{ secrets.EC2_INSTANCE_IP }}:3000" > /dev/null; then
              echo "Application is ready!"
              break
            fi
            echo "Attempt $i/30 - waiting 10s..."
            sleep 10
          done

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: "http://${{ secrets.EC2_INSTANCE_IP }}:3000"
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-a -j --auto"
          allow_issue_writing: false
        continue-on-error: true

      - name: Upload ZAP HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-baseline-report
          path: report_html.html
        if: always()

      - name: Upload ZAP JSON Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-baseline-json
          path: report_json.json
        if: always()

      - name: Upload ZAP Markdown Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-baseline-markdown
          path: report_md.md
        if: always()
