name: DevSecOps Pipeline - Juice Shop

on:
  push:
    branches: ["main", "dev-test"]
  workflow_dispatch:

env:
  RUN_FULL_SECURITY_SCAN: "true"
  ENABLE_METRICS: "true"
  EC2_INSTANCE_IP: ${{ secrets.EC2_INSTANCE_IP }}
  ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
  EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

jobs:
  sast:
    name: SAST - Semgrep
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep
        continue-on-error: true
        run: |
          semgrep scan --config=auto --json --output=semgrep-results.json || true
          semgrep scan --config=auto --sarif --output=semgrep-results.sarif || true
          semgrep ci || true

      - name: Upload Semgrep artifacts
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: |
            semgrep-results.json
            semgrep-results.sarif

  prereq:
    name: Pre-Requisite Check
    runs-on: ubuntu-latest
    needs: sast
    steps:
      - name: Verify Required Secrets
        run: |
          MISSING=""
          [ -z "${EC2_INSTANCE_IP}" ] && MISSING="${MISSING} EC2_INSTANCE_IP"
          [ -z "${EC2_SSH_PRIVATE_KEY}" ] && MISSING="${MISSING} EC2_SSH_PRIVATE_KEY"
          [ -z "${ANSIBLE_VAULT_PASSWORD}" ] && MISSING="${MISSING} ANSIBLE_VAULT_PASSWORD"

          if [ ! -z "$MISSING" ]; then
            echo "ERROR: Missing required values: $MISSING"
            exit 1
          fi
          echo "All required variables present."

  configure:
    name: Configure EC2 With Ansible
    runs-on: ubuntu-latest
    needs: prereq
    steps:
      - uses: actions/checkout@v3

      - name: SSH Key Setup + KeepAlive Fix
        run: |
          mkdir -p ~/.ssh
          echo "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$EC2_INSTANCE_IP" >> ~/.ssh/known_hosts

          # Add global SSH keepalive settings (fixes Broken Pipe)
          cat <<EOF >> ~/.ssh/config
          Host ec2
            HostName ${EC2_INSTANCE_IP}
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            ServerAliveInterval 20
            ServerAliveCountMax 10
            TCPKeepAlive yes
            StrictHostKeyChecking no
          EOF

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible python3-boto3 python3-botocore sshpass dos2unix

      - name: Create Ansible Inventory
        run: |
          mkdir -p ansible
          cat > ansible/inventory.ini <<EOF
          [juiceshop]
          ${EC2_INSTANCE_IP} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o ServerAliveInterval=20 -o ServerAliveCountMax=10 -o TCPKeepAlive=yes'
          EOF

      - name: Vault Password
        run: |
          echo "${ANSIBLE_VAULT_PASSWORD}" > ansible/.vault_pass
          chmod 600 ansible/.vault_pass

      - name: Run Ansible
        run: |
          ansible-playbook -i ansible/inventory.ini ansible/playbook.yml --vault-password-file ansible/.vault_pass -v

  deploy:
    name: Build & Deploy Juice Shop
    runs-on: ubuntu-latest
    needs: configure
    if: always() && (needs.configure.result == 'success' || needs.configure.result == 'skipped')
    steps:
      - uses: actions/checkout@v3

      - name: SSH Setup + KeepAlive Fix
        run: |
          mkdir -p ~/.ssh
          echo "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$EC2_INSTANCE_IP" >> ~/.ssh/known_hosts

          # KeepAlive fix for ALL SSH commands (applies to long Docker builds)
          cat <<EOF >> ~/.ssh/config
          Host ec2
            HostName ${EC2_INSTANCE_IP}
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            ServerAliveInterval 20
            ServerAliveCountMax 10
            TCPKeepAlive yes
            StrictHostKeyChecking no
          EOF

      - name: Deploy Containers on EC2 (SSH KeepAlive)
        run: |
          ssh ec2 "sudo systemctl start docker || true"
          ssh ec2 "cd /opt/juice-shop && docker compose down || true"
          ssh ec2 "docker system prune -f || true"

          # This is where GitHub Actions normally breaks â†’ now prevented
          ssh ec2 "cd /opt/juice-shop && docker compose build --no-cache"

          ssh ec2 "cd /opt/juice-shop && docker compose up -d"

      - name: Wait for container health
        run: |
          ssh ec2 '
            for i in {1..30}; do
              status=$(docker inspect --format "{{.State.Health.Status}}" juice-shop 2>/dev/null || echo "none")
              if [ "$status" = "healthy" ]; then exit 0; fi
              sleep 10
            done
            exit 1
          '

      - name: Wait for port 3000
        run: |
          ssh ec2 '
            for i in {1..30}; do
              nc -z localhost 3000 && exit 0
              sleep 5
            done
            exit 1
          '

  dast:
    name: DAST - OWASP ZAP
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - uses: actions/checkout@v3

      - name: Pull ZAP Docker
        run: docker pull ghcr.io/zaproxy/zaproxy:stable

      - name: Wait for app readiness
        run: |
          for i in {1..30}; do
            curl -sf "http://${EC2_INSTANCE_IP}:3000" && exit 0 || true
            sleep 10
          done
          exit 1

      - name: Run ZAP Baseline
        run: |
          docker run --network=host ghcr.io/zaproxy/zaproxy:stable \
          zap-baseline.py -t "http://${EC2_INSTANCE_IP}:3000" -r report_html.html -J report_json.json -m 5 -T 60 -a -j || true

      - name: Run ZAP Full Scan
        run: |
          docker run --network=host ghcr.io/zaproxy/zaproxy:stable \
          zap-full-scan.py -t "http://${EC2_INSTANCE_IP}:3000" -r report_full_html.html -m 5 -T 120 -a -j || true

      - name: Upload ZAP reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            report_html.html
            report_json.json
            report_full_html.html

  iast:
    name: IAST - Traffic Generator
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - uses: actions/checkout@v3

      - name: Generate traffic
        run: |
          for i in $(seq 1 50); do
            curl -s "http://${EC2_INSTANCE_IP}:3000" >/dev/null 2>&1 || true
            curl -s "http://${EC2_INSTANCE_IP}:3000/rest/products/search?q=juice" >/dev/null 2>&1 || true
            curl -s "http://${EC2_INSTANCE_IP}:3000/rest/products/search?q=<script>alert(1)</script>" >/dev/null 2>&1 || true
            curl -s "http://${EC2_INSTANCE_IP}:3000/api/Challenges" >/dev/null 2>&1 || true
            curl -s "http://${EC2_INSTANCE_IP}:3000/rest/admin/application-version" >/dev/null 2>&1 || true

            curl -X POST -s "http://${EC2_INSTANCE_IP}:3000/rest/user/login" \
              -d '{"email":"admin@juice-sh.op","password":"admin123"}' \
              -H "Content-Type: application/json" >/dev/null 2>&1 || true

            sleep 1
          done

  report:
    name: Final Security Report
    runs-on: ubuntu-latest
    needs: [sast, deploy, dast, iast]
    if: always()
    steps:
      - uses: actions/checkout@v3

      - name: Generate Report
        run: |
          {
            echo "# DevSecOps Security Scan Report"
            echo ""
            echo "Workflow Run: $GITHUB_RUN_ID"
            echo "Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "Branch: $GITHUB_REF_NAME"
            echo "Commit: $GITHUB_SHA"
            echo "Instance: $EC2_INSTANCE_IP"
            echo ""
            echo "## Security Scan Results"
            echo "| Layer | Type | Status | Notes |"
            echo "|---|---|---|---|"
            echo "| Semgrep  | SAST | Completed | See Semgrep artifacts |"
            echo "| Aikido Zen RASP | RASP | Active | Configured inside app |"
            echo "| DataDog IAST | IAST | Triggered | Traffic generated |"
            echo "| OWASP ZAP | DAST | Completed | Reports attached |"
            echo ""
          } > security-report.md

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md
