name: Thesis Experiment Data Generator

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * *" # Runs daily at 4 AM

env:
  EC2_INSTANCE_IP: ${{ secrets.EC2_INSTANCE_IP }}
  EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

jobs:
  run-thesis-experiment:
    name: Execute IAST vs RASP Experiment
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$EC2_INSTANCE_IP" >> ~/.ssh/known_hosts

      - name: Install Load Testing Tools
        run: sudo apt-get install -y apache2-utils

      # ==========================================
      # SCENARIO 1: BASELINE (IAST Only / No RASP)
      # ==========================================
      - name: üî¨ Activate Scenario 1 (Baseline)
        run: ssh ubuntu@$EC2_INSTANCE_IP "/home/ubuntu/run_scenario.sh baseline"

      - name: üö¶ Generate Benign Traffic (Baseline)
        run: |
          echo "Generating Normal Traffic..."
          ab -n 200 -c 5 "http://${EC2_INSTANCE_IP}:3000/rest/products/search?q=apple"

      - name: ‚öîÔ∏è Execute Attacks (Baseline - Should Pass)
        run: |
          echo "Injecting SQLi (Expected: 200 OK)"
          # We loop 50 times to create a visible bar in Grafana
          for i in {1..50}; do
             curl -s -o /dev/null "http://${EC2_INSTANCE_IP}:3000/rest/products/search?q=' OR 1=1--"
          done

      # ==========================================
      # SCENARIO 2: RASP DETECTION (Logging)
      # ==========================================
      - name: üî¨ Activate Scenario 2 (Detection)
        run: ssh ubuntu@$EC2_INSTANCE_IP "/home/ubuntu/run_scenario.sh detection"

      - name: üö¶ Generate Benign Traffic (Detection)
        run: |
          ab -n 200 -c 5 "http://${EC2_INSTANCE_IP}:3000/rest/products/search?q=banana"

      - name: ‚öîÔ∏è Execute Attacks (Detection - Should Pass but Log)
        run: |
          echo "Injecting XSS (Expected: 200 OK)"
          for i in {1..50}; do
             curl -s -o /dev/null "http://${EC2_INSTANCE_IP}:3000/rest/products/search?q=<script>alert(1)</script>"
          done

      # ==========================================
      # SCENARIO 3: RASP BLOCKING (Prevention)
      # ==========================================
      - name: üî¨ Activate Scenario 3 (Blocking)
        run: ssh ubuntu@$EC2_INSTANCE_IP "/home/ubuntu/run_scenario.sh blocking"

      - name: üö¶ Generate Benign Traffic (Blocking - Performance Check)
        run: |
          echo "Generating Load to measure Latency Overhead..."
          # Higher load for latency accuracy
          ab -n 500 -c 10 "http://${EC2_INSTANCE_IP}:3000/rest/products/search?q=orange"

      - name: ‚öîÔ∏è Execute Attacks (Blocking - Should FAIL)
        run: |
          echo "Injecting SQLi (Expected: 403 Forbidden)"
          blocked_count=0
          for i in {1..50}; do
             HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://${EC2_INSTANCE_IP}:3000/rest/products/search?q=' OR 1=1--")
             if [ "$HTTP_CODE" == "403" ]; then
                ((blocked_count++))
             fi
          done
          echo "Attacks Blocked: $blocked_count / 50"
          if [ "$blocked_count" -lt 5 ]; then exit 1; fi

      - name: ‚úÖ Experiment Finished
        run: |
          echo "Go to Grafana: http://${EC2_INSTANCE_IP}:3001"

# name: DevSecOps CI/CD Pipeline

# on:
#     push:
#         branches: ["main", "dev-test"]
#     workflow_dispatch:

# env:
#     EC2_INSTANCE_IP: ${{ secrets.EC2_INSTANCE_IP }}
#     ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
#     EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

# jobs:
#     # 1. SAST
#     sast:
#         name: SAST - Semgrep
#         runs-on: ubuntu-latest
#         steps:
#             - uses: actions/checkout@v3
#             - name: Run Semgrep
#               run: |
#                   pip install semgrep
#                   semgrep scan --config=auto --json --output=semgrep-results.json || true
#             - uses: actions/upload-artifact@v4
#               with:
#                   name: semgrep-results
#                   path: semgrep-results.json

#     # 2. DEPLOY (Using Ansible)
#     deploy:
#         name: Deploy & Config
#         runs-on: ubuntu-latest
#         needs: sast
#         steps:
#             - uses: actions/checkout@v3
#             - name: Setup SSH
#               run: |
#                   mkdir -p ~/.ssh
#                   echo "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
#                   chmod 600 ~/.ssh/id_rsa
#                   ssh-keyscan -H "$EC2_INSTANCE_IP" >> ~/.ssh/known_hosts
#             - name: Install Ansible
#               run: sudo apt-get install -y ansible sshpass

#             - name: Create Inventory
#               run: |
#                   echo "[juiceshop]" > inventory.ini
#                   echo "$EC2_INSTANCE_IP ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa" >> inventory.ini

#             - name: Run Ansible Playbook
#               run: |
#                   ansible-playbook -i inventory.ini ansible/playbook.yml \
#                   -e "datadog_api_key=${{ secrets.DATADOG_API_KEY }}" \
#                   -e "datadog_app_key=${{ secrets.DATADOG_APP_KEY }}" \
#                   -e "datadog_site='us5.datadoghq.com'" \
#                   -e "aikido_token=${{ secrets.ZEN_FIREWALL_TOKEN }}"

#             # 3. DAST (Basic Check)
#     dast:
#         name: DAST - Baseline Check
#         runs-on: ubuntu-latest
#         needs: deploy
#         steps:
#             - name: Run ZAP Baseline
#               run: |
#                   docker run --network=host ghcr.io/zaproxy/zaproxy:stable \
#                   zap-baseline.py -t "http://${EC2_INSTANCE_IP}:3000" -m 5 -a -j || true
