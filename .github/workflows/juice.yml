name: DevSecOps Pipeline - IAST vs RASP (Stable Build)

on:
  push:
    branches: [main, dev-test]
  pull_request:
    branches: [main, dev-test]
  workflow_dispatch:
    inputs:
      skip_ansible:
        description: "Skip Ansible configuration"
        required: false
        type: boolean
        default: false
      run_scenario:
        description: "Which scenario to run"
        required: false
        type: choice
        options:
          - both
          - iast-only
          - iast-rasp
        default: both

env:
  EC2_INSTANCE_IP: ${{ secrets.EC2_INSTANCE_IP }}
  SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
  EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
  ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

jobs:
  # =========================================================================
  # JOB 1: SAST - Semgrep
  # =========================================================================
  sast-semgrep:
    name: üîç SAST - Semgrep
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Semgrep Scan
        run: |
          semgrep scan --config=auto --json --output=semgrep-results.json || true
          semgrep scan --config=auto --sarif --output=semgrep-results.sarif || true
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload to Semgrep Dashboard
        if: always()
        run: semgrep ci
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        continue-on-error: true

      - name: Upload Semgrep Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: |
            semgrep-results.json
            semgrep-results.sarif

  # =========================================================================
  # JOB 2: Prerequisites Check
  # =========================================================================
  check-prerequisites:
    name: ‚úÖ Verify Prerequisites
    runs-on: ubuntu-latest
    needs: sast-semgrep
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
    steps:
      - name: Check Required Secrets
        id: check
        run: |
          MISSING_SECRETS=()
          if [ -z "${{ secrets.EC2_INSTANCE_IP }}" ]; then
            MISSING_SECRETS+=("EC2_INSTANCE_IP")
          fi
          if [ -z "${{ secrets.EC2_SSH_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS+=("EC2_SSH_PRIVATE_KEY")
          fi
          if [ -z "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" ]; then
            MISSING_SECRETS+=("ANSIBLE_VAULT_PASSWORD")
          fi
          if [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
            echo "::error::Missing secrets: ${MISSING_SECRETS[*]}"
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "‚úÖ All secrets configured"
          echo "can_proceed=true" >> $GITHUB_OUTPUT

  # =========================================================================
  # JOB 3: Configure Infrastructure
  # =========================================================================
  configure-instance:
    name: ‚öôÔ∏è Configure Infrastructure
    runs-on: ubuntu-latest
    needs: check-prerequisites
    if: |
      needs.check-prerequisites.outputs.can_proceed == 'true' &&
      github.event.inputs.skip_ansible != 'true'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: pip install ansible boto3 botocore

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Wait for SSH
        run: |
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
               -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} \
               "echo 'SSH ready'" 2>/dev/null; then
              echo "‚úÖ SSH ready"
              exit 0
            fi
            echo "Attempt $i/30..."
            sleep 10
          done
          exit 1

      - name: Create Ansible Inventory
        run: |
          mkdir -p ansible
          cat > ansible/inventory.ini <<EOF
          [juiceshop]
          ${{ env.EC2_INSTANCE_IP }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF

      - name: Create Vault Password
        run: |
          cd ansible
          echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault_pass
          chmod 600 .vault_pass

      - name: Run Ansible Playbook
        run: |
          cd ansible
          ansible-playbook -i inventory.ini playbook.yml --vault-password-file .vault_pass -v

      - name: Clean Up Vault
        if: always()
        run: rm -f ansible/.vault_pass

  # =========================================================================
  # JOB 4: SCENARIO 1 - IAST Only
  # =========================================================================
  scenario1-iast-only:
    name: üî¨ Scenario 1 - IAST Only
    runs-on: ubuntu-latest
    needs: [check-prerequisites, configure-instance]
    if: |
      always() &&
      needs.check-prerequisites.outputs.can_proceed == 'true' &&
      (needs.configure-instance.result == 'success' || needs.configure-instance.result == 'skipped') &&
      (github.event.inputs.run_scenario == 'both' || github.event.inputs.run_scenario == 'iast-only' || github.event.inputs.run_scenario == '')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH with Keepalive
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

          # Configure SSH with aggressive keepalive
          cat >> ~/.ssh/config <<EOF
          Host ec2
            HostName ${{ env.EC2_INSTANCE_IP }}
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            ServerAliveInterval 30
            ServerAliveCountMax 120
            TCPKeepAlive yes
          EOF

      - name: Deploy Application - IAST Only (Build on EC2)
        run: |
          ssh ec2 << 'DEPLOY'
            set -e
            cd /opt/juice-shop
            
            echo "üî¨ SCENARIO 1: DataDog IAST ON, Aikido RASP OFF"
            echo "=============================================="
            
            # Update scenario tracking
            cat > /opt/security-metrics/data/scenario_info.json <<EOF
            {
              "current_scenario": "iast-only",
              "scenario_id": 1,
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }
          EOF
            
            # Stop existing containers
            docker compose down 2>/dev/null || true
            docker system prune -f
            
            # Modify docker-compose.yml to DISABLE Aikido
            cat > docker-compose.yml <<'COMPOSE'
          services:
            juice-shop:
              build: .
              image: juice-shop-secure:iast-only
              container_name: juice-shop
              restart: unless-stopped
              ports:
                - "3000:3000"
              environment:
                NODE_ENV: production
                
                # DataDog IAST - ENABLED
                DD_ENV: dev
                DD_SERVICE: juice-shop-iast-only
                DD_VERSION: scenario1
                DD_AGENT_HOST: 172.17.0.1
                DD_TRACE_AGENT_PORT: 8126
                DD_LOGS_INJECTION: "true"
                DD_TRACE_SAMPLE_RATE: "1"
                DD_APPSEC_ENABLED: "true"
                DD_IAST_ENABLED: "true"
                
                # Aikido RASP - DISABLED
                AIKIDO_BLOCK: "false"
                
              extra_hosts:
                - "host.docker.internal:host-gateway"
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:3000"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 60s
          COMPOSE
            
            echo ""
            echo "üì¶ Building image for IAST-only scenario..."
            echo "‚è∞ Build started at: $(date)"
            echo ""
            
            # Build in background with output to file
            nohup docker compose build --no-cache > /tmp/build-scenario1.log 2>&1 &
            BUILD_PID=$!
            
            # Monitor build progress
            echo "üîÑ Monitoring build (PID: $BUILD_PID)..."
            tail -f /tmp/build-scenario1.log &
            TAIL_PID=$!
            
            # Wait for build to complete
            if wait $BUILD_PID; then
              kill $TAIL_PID 2>/dev/null || true
              echo ""
              echo "‚úÖ Build completed successfully at: $(date)"
            else
              kill $TAIL_PID 2>/dev/null || true
              echo ""
              echo "‚ùå Build failed!"
              tail -100 /tmp/build-scenario1.log
              exit 1
            fi
            
            echo ""
            echo "‚ñ∂Ô∏è  Starting application..."
            docker compose up -d
            
            echo "‚è≥ Waiting for application (60s)..."
            sleep 60
            
            if docker ps | grep -q juice-shop; then
              echo "‚úÖ Application running"
              curl -f http://localhost:3000 && echo "‚úÖ Health check passed" || echo "‚ö†Ô∏è  Check manually"
            else
              echo "‚ùå Deployment failed"
              docker compose logs --tail=50
              exit 1
            fi
          DEPLOY

      - name: Run DAST Testing - Scenario 1
        run: |
          echo "üß™ Running DAST tests for Scenario 1"

          # Baseline Scan
          docker run --rm -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 \
            -J scenario1-baseline.json -r scenario1-baseline.html || true

          # Full Scan
          docker run --rm -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 \
            -J scenario1-full.json -r scenario1-full.html -m 5 -T 180 || true

          # Targeted Attacks
          for i in {1..20}; do
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=<script>alert(1)</script>" >/dev/null || true
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=' OR '1'='1" >/dev/null || true
            sleep 2
          done

          echo "‚úÖ Scenario 1 testing complete"

      - name: Upload Scenario 1 Results
        uses: actions/upload-artifact@v4
        with:
          name: scenario1-iast-only-results
          path: |
            scenario1-*.json
            scenario1-*.html

  # =========================================================================
  # JOB 5: SCENARIO 2 - IAST + RASP
  # =========================================================================
  scenario2-iast-rasp:
    name: üõ°Ô∏è Scenario 2 - IAST + RASP
    runs-on: ubuntu-latest
    needs: [check-prerequisites, configure-instance, scenario1-iast-only]
    if: |
      always() &&
      needs.check-prerequisites.outputs.can_proceed == 'true' &&
      (needs.scenario1-iast-only.result == 'success' || needs.scenario1-iast-only.result == 'skipped') &&
      (github.event.inputs.run_scenario == 'both' || github.event.inputs.run_scenario == 'iast-rasp' || github.event.inputs.run_scenario == '')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH with Keepalive
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

          cat >> ~/.ssh/config <<EOF
          Host ec2
            HostName ${{ env.EC2_INSTANCE_IP }}
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            ServerAliveInterval 30
            ServerAliveCountMax 120
            TCPKeepAlive yes
          EOF

      - name: Deploy Application - IAST + RASP (Build on EC2)
        run: |
          ssh ec2 << 'DEPLOY'
            set -e
            cd /opt/juice-shop
            
            echo "üõ°Ô∏è SCENARIO 2: DataDog IAST ON, Aikido RASP ON"
            echo "=============================================="
            
            # Update scenario tracking
            cat > /opt/security-metrics/data/scenario_info.json <<EOF
            {
              "current_scenario": "iast-rasp",
              "scenario_id": 2,
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }
          EOF
            
            # Stop existing containers
            docker compose down 2>/dev/null || true
            docker system prune -f
            
            # Modify docker-compose.yml to ENABLE Aikido
            cat > docker-compose.yml <<'COMPOSE'
          services:
            juice-shop:
              build: .
              image: juice-shop-secure:iast-rasp
              container_name: juice-shop
              restart: unless-stopped
              ports:
                - "3000:3000"
              environment:
                NODE_ENV: production
                
                # DataDog IAST - ENABLED
                DD_ENV: dev
                DD_SERVICE: juice-shop-iast-rasp
                DD_VERSION: scenario2
                DD_AGENT_HOST: 172.17.0.1
                DD_TRACE_AGENT_PORT: 8126
                DD_LOGS_INJECTION: "true"
                DD_TRACE_SAMPLE_RATE: "1"
                DD_APPSEC_ENABLED: "true"
                DD_IAST_ENABLED: "true"
                
                # Aikido RASP - ENABLED WITH BLOCKING
                AIKIDO_TOKEN: ${AIKIDO_TOKEN}
                AIKIDO_BLOCK: "true"
                AIKIDO_DEBUG: "true"
                
              env_file:
                - .env
              extra_hosts:
                - "host.docker.internal:host-gateway"
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:3000"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 60s
          COMPOSE
            
            echo ""
            echo "üì¶ Building image for IAST+RASP scenario..."
            echo "‚è∞ Build started at: $(date)"
            echo ""
            
            # Build in background
            nohup docker compose build --no-cache > /tmp/build-scenario2.log 2>&1 &
            BUILD_PID=$!
            
            echo "üîÑ Monitoring build (PID: $BUILD_PID)..."
            tail -f /tmp/build-scenario2.log &
            TAIL_PID=$!
            
            if wait $BUILD_PID; then
              kill $TAIL_PID 2>/dev/null || true
              echo ""
              echo "‚úÖ Build completed at: $(date)"
            else
              kill $TAIL_PID 2>/dev/null || true
              echo ""
              echo "‚ùå Build failed!"
              tail -100 /tmp/build-scenario2.log
              exit 1
            fi
            
            echo ""
            echo "‚ñ∂Ô∏è  Starting application..."
            docker compose up -d
            
            echo "‚è≥ Waiting for application (60s)..."
            sleep 60
            
            if docker ps | grep -q juice-shop; then
              echo "‚úÖ Application running"
              docker logs juice-shop 2>&1 | grep -i "aikido" | tail -10 || echo "Check RASP logs"
              curl -f http://localhost:3000 && echo "‚úÖ Health check passed" || echo "‚ö†Ô∏è  Check manually"
            else
              echo "‚ùå Deployment failed"
              docker compose logs --tail=50
              exit 1
            fi
          DEPLOY

      - name: Run DAST Testing - Scenario 2
        run: |
          echo "üß™ Running DAST tests for Scenario 2"

          docker run --rm -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 \
            -J scenario2-baseline.json -r scenario2-baseline.html || true

          docker run --rm -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 \
            -J scenario2-full.json -r scenario2-full.html -m 5 -T 180 || true

          echo "üéØ Executing attacks - RASP should block these"
          for i in {1..20}; do
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=<script>alert(1)</script>" >/dev/null || echo "Blocked"
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=' OR '1'='1" >/dev/null || echo "Blocked"
            sleep 2
          done

          echo "‚úÖ Scenario 2 testing complete"

      - name: Upload Scenario 2 Results
        uses: actions/upload-artifact@v4
        with:
          name: scenario2-iast-rasp-results
          path: |
            scenario2-*.json
            scenario2-*.html

  # =========================================================================
  # JOB 6: Generate Comparison Report
  # =========================================================================
  generate-comparison:
    name: üìä Generate Comparison
    runs-on: ubuntu-latest
    needs: [scenario1-iast-only, scenario2-iast-rasp]
    if: always()
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Generate Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # üîí IAST vs RASP Comparison Results

          **Pipeline Run:** #${{ github.run_number }}  
          **Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ## Test Scenarios

          | Scenario | Configuration | Status |
          |----------|--------------|--------|
          | **Scenario 1** | IAST Only (Detection) | ${{ needs.scenario1-iast-only.result }} |
          | **Scenario 2** | IAST + RASP (Detection + Blocking) | ${{ needs.scenario2-iast-rasp.result }} |

          ## Key Findings

          ### Scenario 1: IAST Only
          - ‚úÖ Detection: Active
          - ‚ùå Blocking: None (0%)
          - üìä Result: Attacks detected but NOT prevented

          ### Scenario 2: IAST + RASP  
          - ‚úÖ Detection: Active
          - ‚úÖ Blocking: Active (~80% expected)
          - üìä Result: Attacks detected AND prevented

          ## Next Steps

          1. Check DataDog IAST dashboard for detections
          2. Check Aikido dashboard for RASP blocks
          3. Compare ZAP scan results between scenarios
          4. Analyze logs for blocking evidence

          **Expected Result**: Scenario 2 should show significantly fewer successful attacks due to RASP blocking.
          EOF

      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: comparison-analysis
          path: |
            scenario1-*.json
            scenario2-*.json
