name: Juice Shop DevSecOps Pipeline with Datadog Agent & IAST

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_KEY: ${{ secrets.SSH_KEY }}
  JUICE_SHOP_PORT: 3000
  DD_API_KEY: ${{ secrets.DD_API_KEY }}
  DD_SITE: us5.datadoghq.com
  PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

jobs:
  setup_datadog_agent:
    name: Install and Start Datadog Agent on EC2
    runs-on: ubuntu-latest
    steps:
      - name: Prepare SSH for EC2
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Install and start Datadog Agent on EC2 using official script
        run: ssh -i ~/.ssh/id_rsa ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << EOF
          DD_API_KEY=${{ secrets.DD_API_KEY }} DD_SITE=${{ env.DD_SITE }} bash -c "\$(curl -L https://install.datadoghq.com/scripts/install_script_agent7.sh)"
          systemctl enable datadog-agent
          systemctl start datadog-agent
          systemctl status datadog-agent
          EOF

  deploy_juice_shop:
    name: Run Official Juice Shop Container with Datadog IAST
    runs-on: ubuntu-latest
    needs: setup_datadog_agent
    steps:
      - name: Prepare SSH for EC2
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy Juice Shop with Datadog IAST environment variables
        run: ssh -i ~/.ssh/id_rsa ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << EOF
          docker stop juice-shop || true
          docker rm juice-shop || true
          docker run -d -p ${{ env.JUICE_SHOP_PORT }}:3000 --name juice-shop \\
          -e DD_IAST_ENABLED=true \\
          -e DD_AGENT_HOST=localhost \\
          -e DD_TRACE_AGENT_PORT=8126 \\
          -e DD_ENV=ci \\
          -e DD_SERVICE=juice-shop \\
          -e DD_VERSION=1.0 \\
          -e DD_LOGS_ENABLED=true \\
          -e DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true \\
          bkimminich/juice-shop
          EOF

  sast_semgrep:
    name: Run Semgrep Static Analysis
    runs-on: ubuntu-latest
    needs: deploy_juice_shop
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep container scan
        run: |
          docker run --rm -v ${{ github.workspace }}:/src returntocorp/semgrep semgrep --config=p/ci --json --output=/src/semgrep-results.json /src

      - name: Upload Semgrep report
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.json

  dast_owasp_zap:
    name: Run OWASP ZAP Dynamic Scan
    runs-on: ubuntu-latest
    needs: deploy_juice_shop
    steps:
      - uses: zaproxy/action-full-scan@v0.8.0
        with:
          target: http://${{ env.SSH_HOST }}:${{ env.JUICE_SHOP_PORT }}

      - uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: report.html

  monitor_iast:
    name: Datadog IAST Monitoring Reminder
    runs-on: ubuntu-latest
    needs: deploy_juice_shop
    steps:
      - name: Reminder to monitor Datadog IAST dashboard
        run: |
          echo "Datadog Runtime Code Analysis (IAST) enabled. View vulnerabilities on the Datadog Security platform dashboard."

  github_issue_search:
    name: Search GitHub Issues for ZAP Full Scan Reports
    runs-on: ubuntu-latest
    steps:
      - name: Search issues using PAT and new GitHub Search API
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          curl -H "Authorization: Bearer $PAT_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/search/issues?q=is:issue state:open repo:Mirzzie/juice ZAP Full Scan Report" \
            --fail

  summary:
    name: Summarize Reports
    runs-on: ubuntu-latest
    needs:
      - sast_semgrep
      - dast_owasp_zap
      - monitor_iast
      - github_issue_search
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: semgrep-results

      - uses: actions/download-artifact@v4
        with:
          name: zap-report

      - run: |
          echo "Static and dynamic analysis reports downloaded."
          echo "Review runtime vulnerability findings on Datadog dashboard."
