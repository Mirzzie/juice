name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Print current directory structure for debugging
      - name: Verify playbook presence
        run: |
          echo "Current working directory: $(pwd)"
          ls -R
          test -f ansible/playbook.yml && echo "✅ Found ansible/playbook.yml" || (echo "❌ Missing playbook" && exit 1)

      # 3️⃣ Run Ansible Playbook
      - name: Run Ansible playbook (deploy)
        env:
          DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}
          DATADOG_SITE: ${{ secrets.DATADOG_SITE }}
          AIKIDO_TOKEN: ${{ secrets.ZEN_FIREWALL_TOKEN }}
          EC2_USER: ${{ secrets.EC2_SSH_USER }}
          EC2_IP: ${{ secrets.EC2_INSTANCE_IP }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$EC2_IP" >> ~/.ssh/known_hosts || true

          if [ -z "$EC2_USER" ]; then
            EC2_USER=ubuntu
          fi

          echo "Using EC2_USER=$EC2_USER, EC2_IP=$EC2_IP"
          ansible-playbook -i "${EC2_IP}," -u "$EC2_USER" \
            --private-key ~/.ssh/id_rsa ansible/playbook.yml

      # 4️⃣ Run SAST Scan (Semgrep)
      - name: Run Semgrep SAST Scan
        uses: returntocorp/semgrep-action@v1
        with:
          publishToken: ${{ secrets.SEMGREP_APP_TOKEN }}
          config: "auto"

      # 5️⃣ Run DAST Scan (OWASP ZAP)
      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: "http://${{ secrets.EC2_INSTANCE_IP }}:3000"
