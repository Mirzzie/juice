name: DevSecOps-CI-CD

on:
  push:
    branches: [main]

env:
  JUICE_SHOP_VERSION: "latest"
  DATADOG_SITE: "us5.datadoghq.com"

jobs:
  semgrep:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Semgrep (SAST)
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/ci"
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

  deploy:
    needs: semgrep
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Install Ansible
        run: |
          sudo apt update
          sudo apt install -y python3-pip
          pip3 install ansible paramiko

      - name: Run Ansible playbook (deploy)
        env:
          DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}
          DATADOG_SITE: ${{ secrets.DATADOG_SITE }}
          AIKIDO_TOKEN: ${{ secrets.ZEN_FIREWALL_TOKEN }}
          EC2_USER: ${{ secrets.EC2_SSH_USER }} # ensure this secret exists; if empty, use "ubuntu" below
          EC2_IP: ${{ secrets.EC2_INSTANCE_IP }} # ensure this secret exists
        run: |
          # write private key
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # add github runner known_hosts entry to avoid interactive prompt
          ssh-keyscan -H "$EC2_IP" >> ~/.ssh/known_hosts || true

          # fallback to ubuntu if EC2_USER secret is empty
          if [ -z "$EC2_USER" ]; then
            EC2_USER=ubuntu
          fi

          # optionally disable host key checking for quicker runs (uncomment if you prefer)
          # export ANSIBLE_HOST_KEY_CHECKING=False

          # Run ansible-playbook with proper -i and -u arguments
          ansible-playbook -i "${EC2_IP}," -u "$EC2_USER" --private-key ~/.ssh/id_rsa ./ansible/playbook.yml

  zap_scan:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.4.0
        with:
          target: "http://${{ secrets.EC2_INSTANCE_IP }}:3000"
