name: DevSecOps Pipeline - IAST vs RASP Comparison

on:
  push:
    branches: [main, dev-test]
  pull_request:
    branches: [main, dev-test]
  workflow_dispatch:
    inputs:
      skip_ansible:
        description: "Skip Ansible configuration"
        required: false
        type: boolean
        default: true
      run_full_pipeline:
        description: "Run complete 4-phase DAST analysis"
        required: false
        type: boolean
        default: true

env:
  EC2_INSTANCE_IP: ${{ secrets.EC2_INSTANCE_IP }}
  SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
  EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
  ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

jobs:
  # =========================================================================
  # JOB 1: SAST - Semgrep
  # =========================================================================
  sast-semgrep:
    name: üîç SAST - Semgrep
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Semgrep Scan
        run: |
          semgrep scan --config=auto --json --output=semgrep-results.json || true
          semgrep scan --config=auto --sarif --output=semgrep-results.sarif || true
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Validate and Format Semgrep JSON
        run: |
          # Ensure JSON is valid
          if command -v jq &> /dev/null; then
            jq '.' semgrep-results.json > semgrep-results-formatted.json || cp semgrep-results.json semgrep-results-formatted.json
            mv semgrep-results-formatted.json semgrep-results.json
          fi

          # Show summary
          echo "üìä Semgrep Results Summary:"
          if command -v jq &> /dev/null; then
            echo "Total findings: $(jq '.results | length' semgrep-results.json)"
            echo "By severity:"
            jq -r '.results | group_by(.extra.severity) | map({severity: .[0].extra.severity, count: length}) | .[]' semgrep-results.json || true
          fi

      - name: Upload to Semgrep Dashboard
        if: always()
        run: semgrep ci
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        continue-on-error: true

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep
        continue-on-error: true

      - name: Upload Semgrep Results to EC2
        if: always()
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

          # Upload JSON results for metrics exporter
          scp -i ~/.ssh/id_rsa semgrep-results.json \
            ubuntu@${{ env.EC2_INSTANCE_IP }}:/opt/security-metrics/data/semgrep-results.json || echo "‚ö†Ô∏è  Could not upload Semgrep results"

          echo "‚úÖ Semgrep results uploaded to EC2 metrics directory"

      - name: Upload Semgrep Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: |
            semgrep-results.json
            semgrep-results.sarif

  # =========================================================================
  # JOB 2: Prerequisites Check
  # =========================================================================
  check-prerequisites:
    name: ‚úÖ Verify Prerequisites
    runs-on: ubuntu-latest
    needs: sast-semgrep
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
    steps:
      - name: Check Required Secrets
        id: check
        run: |
          MISSING_SECRETS=()
          if [ -z "${{ secrets.EC2_INSTANCE_IP }}" ]; then
            MISSING_SECRETS+=("EC2_INSTANCE_IP")
          fi
          if [ -z "${{ secrets.EC2_SSH_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS+=("EC2_SSH_PRIVATE_KEY")
          fi
          if [ -z "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" ]; then
            MISSING_SECRETS+=("ANSIBLE_VAULT_PASSWORD")
          fi
          if [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
            echo "::error::Missing secrets: ${MISSING_SECRETS[*]}"
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "‚úÖ All secrets configured"
          echo "can_proceed=true" >> $GITHUB_OUTPUT

  # =========================================================================
  # JOB 3: Configure Infrastructure
  # =========================================================================
  configure-instance:
    name: ‚öôÔ∏è Configure Infrastructure (Ansible)
    runs-on: ubuntu-latest
    needs: check-prerequisites
    if: |
      needs.check-prerequisites.outputs.can_proceed == 'true' &&
      (github.event.inputs.skip_ansible == 'false' || github.event.inputs.skip_ansible == '')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: pip install ansible boto3 botocore

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Wait for SSH
        run: |
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
               -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} \
               "echo 'SSH ready'" 2>/dev/null; then
              echo "‚úÖ SSH ready"
              exit 0
            fi
            echo "Attempt $i/30..."
            sleep 10
          done
          exit 1

      - name: Create Ansible Inventory
        run: |
          mkdir -p ansible
          cat > ansible/inventory.ini <<EOF
          [juiceshop]
          ${{ env.EC2_INSTANCE_IP }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF

      - name: Create Vault Password
        run: |
          cd ansible
          echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault_pass
          chmod 600 .vault_pass

      - name: Run Ansible Playbook
        run: |
          cd ansible
          ansible-playbook -i inventory.ini playbook.yml --vault-password-file .vault_pass -v

      - name: Clean Up Vault
        if: always()
        run: rm -f ansible/.vault_pass

      - name: Verify Configuration
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ubuntu@${{ env.EC2_INSTANCE_IP }} << 'VERIFY'
            echo "=== Service Status Verification ==="
            docker --version
            echo "Prometheus: $(systemctl is-active prometheus)"
            echo "Grafana: $(systemctl is-active grafana-server)"
            echo "Metrics Exporter: $(systemctl is-active security-metrics-exporter)"
            echo "DataDog Agent: $(systemctl is-active datadog-agent)"
            
            sleep 5
            
            echo ""
            echo "=== Health Checks ==="
            curl -s http://localhost:9090/-/healthy && echo "‚úÖ Prometheus healthy" || echo "‚ö†Ô∏è  Prometheus not ready"
            curl -s http://localhost:3001/api/health && echo "‚úÖ Grafana healthy" || echo "‚ö†Ô∏è  Grafana not ready"
            curl -s http://localhost:9999/metrics | head -5 && echo "‚úÖ Metrics exporter running" || echo "‚ö†Ô∏è  Metrics exporter not ready"
          VERIFY

  # =========================================================================
  # JOB 4: Deploy Application
  # =========================================================================
  build-and-deploy:
    name: üöÄ Build & Deploy
    runs-on: ubuntu-latest
    needs: [check-prerequisites, configure-instance]
    if: |
      always() &&
      needs.check-prerequisites.outputs.can_proceed == 'true' &&
      (needs.configure-instance.result == 'success' || needs.configure-instance.result == 'skipped')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Deploy Application (Build on EC2)
        run: |
          ssh -i ~/.ssh/id_rsa \
            -o ServerAliveInterval=60 \
            -o ServerAliveCountMax=120 \
            -o TCPKeepAlive=yes \
            ubuntu@${{ env.EC2_INSTANCE_IP }} << 'DEPLOY'
            set -e
            cd /opt/juice-shop
            
            echo "üõë Stopping existing containers..."
            docker compose down 2>/dev/null || true
            
            echo "üßπ Cleaning up Docker resources..."
            docker system prune -f
            
            echo ""
            echo "üì¶ Building Docker image directly on EC2..."
            echo "‚è∞ Build started at: $(date)"
            echo "‚ÑπÔ∏è  Building on EC2 (no timeout limits, better resources)"
            echo ""
            
            # Build on EC2 with full output (no background process needed)
            # EC2 has more resources and no GitHub Actions timeout
            if docker compose build --no-cache 2>&1 | tee /tmp/build.log; then
              echo ""
              echo "‚úÖ Build completed successfully at: $(date)"
            else
              echo ""
              echo "‚ùå Build failed!"
              echo "Last 100 lines:"
              tail -100 /tmp/build.log
              exit 1
            fi
            
            echo ""
            echo "‚ñ∂Ô∏è  Starting application..."
            docker compose up -d
            
            echo "‚è≥ Waiting for application to start (60s)..."
            sleep 60
            
            # Verify deployment
            echo ""
            if docker ps | grep -q juice-shop; then
              echo "‚úÖ Container is running"
              
              # Quick health check
              if curl -f -s http://localhost:3000 >/dev/null; then
                echo "‚úÖ Application is responding"
                echo ""
                echo "üìä Checking instrumentation..."
                docker logs juice-shop 2>&1 | grep -i -E "datadog|aikido" | head -5 || echo "‚ö†Ô∏è  Check logs manually"
              else
                echo "‚ö†Ô∏è  Application not responding yet (container may still be starting)"
                echo "    Check with: docker logs juice-shop"
              fi
            else
              echo "‚ùå Container failed to start"
              docker compose logs --tail=50
              exit 1
            fi
            
            echo ""
            echo "‚úÖ Deployment complete!"
            echo "   Application: http://$(curl -s ifconfig.me):3000"
          DEPLOY

      - name: Initialize Metrics Collection
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'METRICS'
            # Set initial scan phase
            mkdir -p /opt/security-metrics/data
            cat > /opt/security-metrics/data/manual_metrics.json <<EOF
            {
              "scan_phase": 0,
              "response_times": {
                "datadog_iast": 0,
                "aikido_rasp": 0
              }
            }
          EOF
            
            # Verify metrics exporter is running
            systemctl status security-metrics-exporter --no-pager || systemctl restart security-metrics-exporter
            
            # Wait for metrics endpoint
            sleep 10
            echo "üìä Metrics Exporter Status:"
            curl -s http://localhost:9999/metrics | head -20
          METRICS

  # =========================================================================
  # JOB 5: Phase 1 - DAST Baseline Scan
  # =========================================================================
  phase1-baseline-scan:
    name: üìä Phase 1 - DAST Baseline Scan
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: |
      needs.build-and-deploy.result == 'success' &&
      (github.event.inputs.run_full_pipeline == 'true' || github.event.inputs.run_full_pipeline == '')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Update Scan Phase
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'PHASE'
            jq '.scan_phase = 1' /opt/security-metrics/data/manual_metrics.json > /tmp/metrics.json
            mv /tmp/metrics.json /opt/security-metrics/data/manual_metrics.json
            echo "‚úÖ Set scan phase to 1 (Baseline)"
          PHASE

      - name: Generate Pre-Scan Traffic
        run: |
          echo "üöÄ Generating traffic before scan..."
          for i in {1..30}; do
            curl -s http://${{ env.EC2_INSTANCE_IP }}:3000 >/dev/null || true
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=juice" >/dev/null || true
            sleep 1
          done

      - name: Run ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: "http://${{ env.EC2_INSTANCE_IP }}:3000"
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-a -j -m 5 -T 60"
          allow_issue_writing: false
          fail_action: false
        continue-on-error: true

      - name: Verify and Upload Baseline Results to EC2
        run: |
          # Validate JSON
          if command -v jq &> /dev/null && [ -f report_json.json ]; then
            if jq empty report_json.json 2>/dev/null; then
              echo "‚úÖ Valid JSON format"
              jq '.' report_json.json > report_json_formatted.json
              mv report_json_formatted.json report_json.json
            else
              echo "‚ö†Ô∏è  JSON validation failed, uploading as-is"
            fi
            
            echo "üìä ZAP Baseline Summary:"
            jq '.site[0].alerts | length' report_json.json || echo "Could not parse alert count"
          fi

          # Upload with correct name for metrics exporter
          scp -i ~/.ssh/id_rsa report_json.json \
            ubuntu@${{ env.EC2_INSTANCE_IP }}:/opt/security-metrics/zap-results/baseline_report.json || true

          scp -i ~/.ssh/id_rsa report_html.html \
            ubuntu@${{ env.EC2_INSTANCE_IP }}:/opt/security-metrics/zap-results/baseline_report.html || true

          echo "‚úÖ Baseline results uploaded"

      - name: Upload Phase 1 Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase1-baseline-results
          path: |
            report_html.html
            report_json.json
            report_md.md

      - name: Wait for Metrics Processing
        run: sleep 30

  # =========================================================================
  # JOB 6: Phase 2 - DAST Full Scan
  # =========================================================================
  phase2-full-scan:
    name: üï∑Ô∏è Phase 2 - DAST Full Scan
    runs-on: ubuntu-latest
    needs: phase1-baseline-scan
    if: needs.phase1-baseline-scan.result == 'success'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Update Scan Phase
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'PHASE'
            jq '.scan_phase = 2' /opt/security-metrics/data/manual_metrics.json > /tmp/metrics.json
            mv /tmp/metrics.json /opt/security-metrics/data/manual_metrics.json
            echo "‚úÖ Set scan phase to 2 (Full Scan)"
          PHASE

      - name: Run ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.8.0
        with:
          target: "http://${{ env.EC2_INSTANCE_IP }}:3000"
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-a -j -m 5 -T 180"
          allow_issue_writing: false
          fail_action: false
        continue-on-error: true

      - name: Verify and Upload Full Scan Results to EC2
        run: |
          # Validate JSON
          if command -v jq &> /dev/null && [ -f report_json.json ]; then
            if jq empty report_json.json 2>/dev/null; then
              echo "‚úÖ Valid JSON format"
              jq '.' report_json.json > report_json_formatted.json
              mv report_json_formatted.json report_json.json
            fi
            
            echo "üìä ZAP Full Scan Summary:"
            jq '.site[0].alerts | length' report_json.json || echo "Could not parse"
          fi

          # Upload with correct name
          scp -i ~/.ssh/id_rsa report_json.json \
            ubuntu@${{ env.EC2_INSTANCE_IP }}:/opt/security-metrics/zap-results/full_report.json || true

          scp -i ~/.ssh/id_rsa report_html.html \
            ubuntu@${{ env.EC2_INSTANCE_IP }}:/opt/security-metrics/zap-results/full_report.html || true

          echo "‚úÖ Full scan results uploaded"

      - name: Upload Phase 2 Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase2-full-scan-results
          path: |
            report_html.html
            report_json.json
            report_md.md

      - name: Wait for Metrics Processing
        run: sleep 30

  # =========================================================================
  # JOB 7: Phase 3 - Targeted Attack Simulation
  # =========================================================================
  phase3-targeted-attacks:
    name: üéØ Phase 3 - Targeted Attacks
    runs-on: ubuntu-latest
    needs: phase2-full-scan
    if: needs.phase2-full-scan.result == 'success'
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Update Scan Phase
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'PHASE'
            jq '.scan_phase = 3' /opt/security-metrics/data/manual_metrics.json > /tmp/metrics.json
            mv /tmp/metrics.json /opt/security-metrics/data/manual_metrics.json
            echo "‚úÖ Set scan phase to 3 (Targeted Attacks)"
          PHASE

      - name: Execute Targeted Attack Vectors
        run: |
          echo "üéØ Executing targeted security tests..."

          # XSS Attacks
          echo "Testing XSS vulnerabilities..."
          for payload in "<script>alert(1)</script>" "<img src=x onerror=alert(1)>" "javascript:alert(1)"; do
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=${payload}" >/dev/null || true
            sleep 2
          done

          # SQL Injection Attacks
          echo "Testing SQL injection..."
          for payload in "' OR '1'='1" "1' UNION SELECT NULL--" "admin'--"; do
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=${payload}" >/dev/null || true
            sleep 2
          done

          # Path Traversal
          echo "Testing path traversal..."
          for payload in "../../../etc/passwd" "....//....//....//etc/passwd" "%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd"; do
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/ftp/${payload}" >/dev/null || true
            sleep 2
          done

          # Command Injection
          echo "Testing command injection..."
          for payload in "; ls -la" "| whoami" "\`id\`"; do
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=${payload}" >/dev/null || true
            sleep 2
          done

          # Authentication Bypass
          echo "Testing authentication bypass..."
          curl -X POST "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/user/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"admin@juice-sh.op","password":"admin123"}' >/dev/null || true
          curl -X POST "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/user/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"admin'\'' OR 1=1--","password":"anything"}' >/dev/null || true

          # LDAP Injection
          echo "Testing LDAP injection..."
          curl -X POST "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/user/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"*)(uid=*))(|(uid=*","password":"*"}' >/dev/null || true

          # XXE (XML External Entity)
          echo "Testing XXE..."
          curl -X POST "http://${{ env.EC2_INSTANCE_IP }}:3000/file-upload" \
            -H "Content-Type: application/xml" \
            -d '<?xml version="1.0"?><!DOCTYPE root [<!ENTITY test SYSTEM "file:///etc/passwd">]><root>&test;</root>' >/dev/null || true

          # NoSQL Injection
          echo "Testing NoSQL injection..."
          curl -X POST "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/user/login" \
            -H "Content-Type: application/json" \
            -d '{"email":{"$gt":""},"password":{"$gt":""}}' >/dev/null || true

          # SSRF (Server-Side Request Forgery)
          echo "Testing SSRF..."
          curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/redirect?to=http://169.254.169.254/latest/meta-data/" >/dev/null || true

          # Mass assignment
          echo "Testing mass assignment..."
          curl -X POST "http://${{ env.EC2_INSTANCE_IP }}:3000/api/Users" \
            -H "Content-Type: application/json" \
            -d '{"email":"hacker@test.com","password":"test123","role":"admin"}' >/dev/null || true

          # Rate limiting bypass
          echo "Testing rate limiting..."
          for i in {1..50}; do
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=test" >/dev/null || true
          done

          echo "‚úÖ Targeted attacks completed"

      - name: Wait for Detection Processing
        run: sleep 60

  # =========================================================================
  # JOB 8: Phase 4 - Comprehensive Metrics Collection
  # =========================================================================
  phase4-metrics-collection:
    name: üìà Phase 4 - Metrics Collection
    runs-on: ubuntu-latest
    needs: phase3-targeted-attacks
    if: needs.phase3-targeted-attacks.result == 'success'
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Update Scan Phase
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'PHASE'
            jq '.scan_phase = 4' /opt/security-metrics/data/manual_metrics.json > /tmp/metrics.json
            mv /tmp/metrics.json /opt/security-metrics/data/manual_metrics.json
            echo "‚úÖ Set scan phase to 4 (Final Analysis)"
          PHASE

      - name: Generate High-Volume Traffic for IAST Analysis
        run: |
          echo "üìä Generating traffic for IAST analysis..."
          for i in {1..100}; do
            curl -s http://${{ env.EC2_INSTANCE_IP }}:3000 >/dev/null || true
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=juice" >/dev/null || true
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/api/Challenges" >/dev/null || true
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/admin/application-version" >/dev/null || true
            [ $((i % 10)) -eq 0 ] && echo "Progress: $i/100"
          done
          echo "‚úÖ Traffic generation complete"

      - name: Wait for Final Metrics Collection
        run: |
          echo "‚è≥ Waiting for metrics to propagate (2 minutes)..."
          sleep 120

      - name: Collect and Verify All Metrics
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'COLLECT'
            echo "============================================"
            echo "COMPREHENSIVE METRICS VERIFICATION"
            echo "============================================"
            
            echo ""
            echo "=== 1. SAST (Semgrep) Metrics ==="
            curl -s http://localhost:9999/metrics | grep "sast_vulnerabilities_found" | head -10 || echo "‚ö†Ô∏è  No SAST metrics found"
            
            echo ""
            echo "=== 2. DAST (ZAP) Metrics ==="
            curl -s http://localhost:9999/metrics | grep "dast_vulnerabilities_found" | head -10 || echo "‚ö†Ô∏è  No DAST metrics found"
            
            echo ""
            echo "=== 3. IAST (DataDog) Metrics ==="
            curl -s http://localhost:9999/metrics | grep "security_detections_total.*datadog_iast" || echo "‚ö†Ô∏è  No IAST metrics found"
            
            echo ""
            echo "=== 4. RASP (Aikido) Metrics ==="
            curl -s http://localhost:9999/metrics | grep "security_detections_total.*aikido_rasp" || echo "‚ö†Ô∏è  No RASP detection metrics"
            curl -s http://localhost:9999/metrics | grep "security_blocks_total.*aikido_rasp" || echo "‚ö†Ô∏è  No RASP block metrics"
            
            echo ""
            echo "=== Scan Phase ==="
            curl -s http://localhost:9999/metrics | grep "current_scan_phase"
            
            echo ""
            echo "=== Metrics Exporter Logs (last 50 lines) ==="
            journalctl -u security-metrics-exporter -n 50 --no-pager
            
            echo ""
            echo "=== DataDog Application Logs ==="
            docker logs juice-shop 2>&1 | grep -i "datadog\|trace\|dd-trace" | tail -20 || echo "‚ö†Ô∏è  No DataDog traces found"
            
            echo ""
            echo "=== Aikido Application Logs ==="
            docker logs juice-shop 2>&1 | grep -i "aikido" | tail -20 || echo "‚ö†Ô∏è  No Aikido logs found"
            
            echo ""
            echo "=== Service Status ==="
            echo "Metrics Exporter: $(systemctl is-active security-metrics-exporter)"
            echo "Prometheus: $(systemctl is-active prometheus)"
            echo "Grafana: $(systemctl is-active grafana-server)"
            echo "DataDog Agent: $(systemctl is-active datadog-agent)"
            
            echo ""
            echo "============================================"
            echo "VERIFICATION COMPLETE"
            echo "============================================"
          COLLECT

  # =========================================================================
  # JOB 9: Generate Comparison Report
  # =========================================================================
  generate-report:
    name: üìã Generate Comparison Report
    runs-on: ubuntu-latest
    needs:
      [
        phase1-baseline-scan,
        phase2-full-scan,
        phase3-targeted-attacks,
        phase4-metrics-collection,
      ]
    if: always()
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Query Final Metrics from Prometheus
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'QUERY' > prometheus-metrics.txt
            echo "=== FINAL PROMETHEUS METRICS ==="
            echo ""
            echo "SAST Total:"
            curl -s 'http://localhost:9090/api/v1/query?query=sum(sast_vulnerabilities_found{rule_id="total"})' | jq -r '.data.result[0].value[1] // "0"'
            
            echo ""
            echo "DAST Total:"
            curl -s 'http://localhost:9090/api/v1/query?query=sum(dast_vulnerabilities_found{vuln_name="total"})' | jq -r '.data.result[0].value[1] // "0"'
            
            echo ""
            echo "IAST Detections:"
            curl -s 'http://localhost:9090/api/v1/query?query=sum(security_detections_total{tool="datadog_iast"})' | jq -r '.data.result[0].value[1] // "0"'
            
            echo ""
            echo "RASP Detections:"
            curl -s 'http://localhost:9090/api/v1/query?query=sum(security_detections_total{tool="aikido_rasp"})' | jq -r '.data.result[0].value[1] // "0"'
            
            echo ""
            echo "RASP Blocks:"
            curl -s 'http://localhost:9090/api/v1/query?query=sum(security_blocks_total{tool="aikido_rasp"})' | jq -r '.data.result[0].value[1] // "0"'
          QUERY

          cat prometheus-metrics.txt

      - name: Generate Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # üîí DevSecOps Security Analysis - SAST/DAST/IAST/RASP Comparison

          **Pipeline Run:** #${{ github.run_number }}  
          **Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
          **Instance:** ${{ env.EC2_INSTANCE_IP }}

          ---

          ## üìä Test Phases Completed

          | Phase | Type | Status |
          |-------|------|--------|
          | SAST | Semgrep Code Analysis | ‚úÖ Complete |
          | Phase 1 | DAST Baseline Scan | ${{ needs.phase1-baseline-scan.result }} |
          | Phase 2 | DAST Full Scan | ${{ needs.phase2-full-scan.result }} |
          | Phase 3 | Targeted Attacks | ${{ needs.phase3-targeted-attacks.result }} |
          | Phase 4 | Metrics Collection | ${{ needs.phase4-metrics-collection.result }} |

          ---

          ## üéØ Key Results Summary

          Based on collected metrics from all security tools:

          ### Tool Comparison

          | Tool | Type | Primary Function | Metrics Collected |
          |------|------|-----------------|-------------------|
          | **Semgrep** | SAST | Static Code Analysis | ‚úÖ Vulnerabilities by severity |
          | **OWASP ZAP** | DAST | Dynamic App Testing | ‚úÖ Runtime vulnerabilities |
          | **DataDog** | IAST | Interactive Analysis | ‚úÖ Detection metrics |
          | **Aikido Zen** | RASP | Runtime Protection | ‚úÖ Detection + Blocking |

          ---

          ## üîç Access Dashboards

          ### üìà Grafana Security Dashboard
          **URL:** http://${{ env.EC2_INSTANCE_IP }}:3001  
          **Credentials:** admin / admin  
          **Dashboard:** "DevSecOps Security Tools Comparison (SAST/DAST/IAST/RASP)"

          ### üìä Prometheus Metrics
          **URL:** http://${{ env.EC2_INSTANCE_IP }}:9090  

          **Key Queries:**
          ```promql
          # SAST findings
          sum(sast_vulnerabilities_found{rule_id="total"})

          # DAST vulnerabilities
          sum(dast_vulnerabilities_found{vuln_name="total"})

          # IAST detections
          sum(security_detections_total{tool="datadog_iast"})

          # RASP detections
          sum(security_detections_total{tool="aikido_rasp"})

          # RASP blocks
          sum(security_blocks_total{tool="aikido_rasp"})

          # RASP block rate
          (sum(security_blocks_total{tool="aikido_rasp"}) / sum(security_detections_total{tool="aikido_rasp"})) * 100
          ```

          ### üîó External Tool Dashboards
          - **DataDog IAST:** https://app.us5.datadoghq.com/security/appsec?service=juice-shop
          - **Aikido RASP:** https://app.aikido.dev
          - **Semgrep SAST:** https://semgrep.dev/orgs/-/findings

          ---

          ## üîß Verification Commands

          SSH into instance for detailed analysis:
          ```bash
          ssh -i your-key.pem ubuntu@${{ env.EC2_INSTANCE_IP }}

          # View all metrics
          curl http://localhost:9999/metrics

          # Check SAST metrics
          curl http://localhost:9999/metrics | grep sast_vulnerabilities

          # Check DAST metrics
          curl http://localhost:9999/metrics | grep dast_vulnerabilities

          # Check IAST/RASP metrics
          curl http://localhost:9999/metrics | grep security_detections
          curl http://localhost:9999/metrics | grep security_blocks

          # View application logs
          docker logs juice-shop -f

          # Check service status
          systemctl status security-metrics-exporter
          journalctl -u security-metrics-exporter -f
          ```

          ---

          ## üìä Thesis Hypothesis Validation

          Expected results based on tool characteristics:

          1. **SAST (Semgrep)**: Static code analysis findings
             - Pre-deployment vulnerability detection
             - Code-level security issues

          2. **DAST (ZAP)**: Dynamic runtime vulnerabilities
             - ~20-50 vulnerabilities in baseline scan
             - ~50-100 in full scan

          3. **IAST (DataDog)**: Runtime detection without blocking
             - Detects attacks during execution
             - Does NOT block malicious requests

          4. **RASP (Aikido)**: Runtime detection WITH blocking
             - Similar detection rate to IAST
             - **~80% blocking rate** of detected attacks
             - Active protection layer

          ### Key Differentiator
          **RASP provides both detection AND prevention, while IAST only provides detection.**

          EOF

      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: final-security-analysis
          path: |
            prometheus-metrics.txt
