name: DevSecOps Pipeline - Docker-Based (Your Workflow)

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [dev]
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        type: choice
        options:
          - "deploy_application"
          - "run_security_scans"
          - "full_pipeline"
        default: "deploy_application"

env:
  EC2_INSTANCE_IP: ${{ secrets.EC2_INSTANCE_IP }}
  DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}
  DATADOG_SITE: "us5.datadoghq.com"
  AIKIDO_TOKEN: ${{ secrets.ZEN_FIREWALL_TOKEN }}
  SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
  SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

jobs:
  # =========================================================================
  # JOB 1: SAST - Always Run First
  # =========================================================================
  sast-semgrep:
    name: ðŸ” SAST - Semgrep Security Scan
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Semgrep SAST Scan
        run: |
          semgrep scan --config=auto --json --output=semgrep-results.json || true
          semgrep scan --config=auto --sarif --output=semgrep-results.sarif || true
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload Results to Semgrep Dashboard
        if: always()
        run: semgrep ci
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload Semgrep Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: |
            semgrep-results.json
            semgrep-results.sarif

  # =========================================================================
  # JOB 2: Configure Instance (Ansible)
  # =========================================================================
  configure-instance:
    name: âš™ï¸ Configure Instance (Ansible)
    runs-on: ubuntu-latest
    needs: sast-semgrep
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: |
          pip install ansible boto3 botocore

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Create Ansible Inventory
        run: |
          mkdir -p ansible
          cat > ansible/inventory.ini <<EOF
          [juiceshop]
          ${{ secrets.EC2_INSTANCE_IP }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF

          echo "Inventory created:"
          cat ansible/inventory.ini

      - name: Create Ansible Vault Password File
        run: |
          cd ansible
          echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault_pass
          chmod 600 .vault_pass

      - name: Run Ansible Playbook with Vault
        run: |
          cd ansible
          ansible-playbook -i inventory.ini playbook.yml \
            --vault-password-file .vault_pass \
            -v

      - name: Clean up Vault Password
        if: always()
        run: |
          rm -f ansible/.vault_pass

  # =========================================================================
  # JOB 3: Build and Deploy Application (Docker)
  # =========================================================================
  build-and-deploy:
    name: ðŸš€ Build & Deploy Application
    runs-on: ubuntu-latest
    needs: [sast-semgrep, configure-instance]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Deploy Docker Container
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.EC2_INSTANCE_IP }} << 'ENDSSH'
            set -e
            cd /opt/juice-shop
            
            echo "======================================"
            echo "Deploying Juice Shop with Docker"
            echo "======================================"
            
            if [ ! -f .env ]; then
              echo "::error::.env file not found!"
              exit 1
            fi
            
            docker compose down 2>/dev/null || true
            docker image prune -f || true
            docker compose build --no-cache
            docker compose up -d
            
            sleep 45
            
            if docker ps | grep -q juice-shop; then
              echo "âœ… Container is running"
            else
              echo "âŒ Container failed to start"
              docker compose logs
              exit 1
            fi
            
            for i in {1..10}; do
              if curl -f -s http://localhost:3000 > /dev/null; then
                echo "âœ… Application is responding"
                break
              fi
              echo "Waiting for application... ($i/10)"
              sleep 5
            done
            
            docker compose logs --tail=30
          ENDSSH

  # =========================================================================
  # JOB 4: DAST - OWASP ZAP Scan
  # =========================================================================
  dast-owasp-zap:
    name: ðŸ•·ï¸ DAST - OWASP ZAP Scan
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create ZAP Directory
        run: mkdir -p .zap

      - name: Wait for Application Stability
        run: |
          echo "Waiting 30 seconds for application to stabilize..."
          sleep 30

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: "http://${{ secrets.EC2_INSTANCE_IP }}:3000"
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-a -j -m 5 -T 60"
          allow_issue_writing: false
          fail_action: false

      - name: Upload ZAP Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-results
          path: |
            report_html.html
            report_json.json
            report_md.md

  # =========================================================================
  # JOB 5: IAST - DataDog Verification
  # =========================================================================
  iast-datadog-verification:
    name: ðŸ“Š IAST - DataDog Verification
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    steps:
      - name: Generate Traffic for IAST Analysis
        run: |
          for i in {1..50}; do
            curl -s http://${{ secrets.EC2_INSTANCE_IP }}:3000 > /dev/null || true
            curl -s http://${{ secrets.EC2_INSTANCE_IP }}:3000/rest/products/search?q=juice > /dev/null || true
            curl -s http://${{ secrets.EC2_INSTANCE_IP }}:3000/api/Challenges > /dev/null || true
            sleep 1
          done

  # =========================================================================
  # JOB 6: Security Report
  # =========================================================================
  security-report:
    name: ðŸ“‹ Generate Security Report
    runs-on: ubuntu-latest
    needs: [sast-semgrep, dast-owasp-zap, iast-datadog-verification]
    if: always()
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Generate Comprehensive Report
        run: |
          cat > security-report.md << 'EOF'
          # DevSecOps Security Scan Report
          **Pipeline Run:** #${{ github.run_number }}
          **Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}

          ---
          ## Summary
          - âœ… SAST: Semgrep
          - âœ… RASP: Aikido Zen Firewall
          - âœ… IAST: DataDog
          - âœ… DAST: OWASP ZAP
          EOF

          cat security-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md
