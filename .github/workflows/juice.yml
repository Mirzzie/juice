name: IAST vs RASP Comparison

on:
  push:
    branches: [main, dev-test]
  workflow_dispatch:

env:
  EC2_IP: ${{ secrets.EC2_INSTANCE_IP }}

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key

      - name: Run Ansible
        run: |
          pip install ansible
          cd ansible
          echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault
          ansible-playbook -i "${{ env.EC2_IP }}," playbook.yml --vault-password-file .vault \
            -u ubuntu --private-key ~/.ssh/key -e "ansible_host=${{ env.EC2_IP }}"

  test-iast:
    name: Test IAST
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          ssh-keyscan ${{ env.EC2_IP }} >> ~/.ssh/known_hosts

      - name: Build and Start
        run: |
          AIKIDO_TOKEN="${{ secrets.ZEN_FIREWALL_TOKEN }}"
          ssh -i ~/.ssh/key ubuntu@${{ env.EC2_IP }} "bash -s $AIKIDO_TOKEN" << 'EOF'
            AIKIDO_TOKEN="$1"
            
            # Ensure directory exists
            mkdir -p /opt/app /var/lib/results/iast
            cd /opt/app
            
            # Create files if not exist
            if [ ! -f Dockerfile ]; then
              cat > Dockerfile << 'DOCKER'
          FROM node:22-slim AS builder
          RUN apt-get update && apt-get install -y git python3 make g++
          WORKDIR /app
          RUN git clone --depth 1 https://github.com/juice-shop/juice-shop.git .
          RUN npm install --legacy-peer-deps && npm install @aikidosec/firewall dd-trace

          FROM node:22-slim
          WORKDIR /app
          COPY --from=builder /app /app
          EXPOSE 3000
          CMD ["npm", "start"]
          DOCKER
              
              cat > docker-compose.yml << COMPOSE
          services:
            app:
              build: .
              ports: ["3000:3000"]
              environment:
                DD_AGENT_HOST: 172.17.0.1
                DD_APPSEC_ENABLED: "\${DD_APPSEC:-false}"
                DD_IAST_ENABLED: "\${DD_IAST:-false}"
                AIKIDO_TOKEN: "$AIKIDO_TOKEN"
                AIKIDO_BLOCK: "\${AIKIDO_BLOCK:-false}"
          COMPOSE
            fi
            
            export DD_APPSEC=true DD_IAST=true AIKIDO_BLOCK=false
            
            # Start build in background
            nohup docker compose up -d --build > /tmp/build.log 2>&1 &
            BUILD_PID=$!
            
            # Wait max 25 minutes
            for i in {1..300}; do
              if docker ps | grep -q app; then
                echo "App ready"
                exit 0
              fi
              sleep 5
            done
            
            echo "Timeout waiting for app"
            cat /tmp/build.log
            exit 1
          EOF
        timeout-minutes: 30

      - name: Run ZAP Scan
        run: |
          ssh -i ~/.ssh/key ubuntu@${{ env.EC2_IP }} 'bash -s' << 'EOF'
            mkdir -p /var/lib/results/iast
            docker run --rm --network host \
              -v /var/lib/results/iast:/zap/wrk \
              ghcr.io/zaproxy/zaproxy:stable \
              zap-baseline.py -t http://localhost:3000 -J report.json
          EOF

      - name: Extract and Push Metrics
        run: |
          ssh -i ~/.ssh/key ubuntu@${{ env.EC2_IP }} 'bash -s' << 'EOF'
            docker logs app > /tmp/logs.txt 2>&1
            
            DETECTED=$(grep -ci "detected\|vulnerability" /tmp/logs.txt || echo 0)
            BLOCKED=$(grep -ci "blocked" /tmp/logs.txt || echo 0)
            ALERTS=$(jq '.site[0].alerts | length' /var/lib/results/iast/report.json 2>/dev/null || echo 0)
            
            # Push to Pushgateway
            cat << METRICS | curl --data-binary @- http://localhost:9091/metrics/job/iast
            iast_detected $DETECTED
            iast_blocked $BLOCKED
            iast_zap_alerts $ALERTS
            METRICS
          EOF

  test-rasp:
    name: Test RASP
    needs: test-iast
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          ssh-keyscan ${{ env.EC2_IP }} >> ~/.ssh/known_hosts

      - name: Build and Start
        run: |
          ssh -i ~/.ssh/key ubuntu@${{ env.EC2_IP }} 'bash -s' << 'EOF'
            mkdir -p /var/lib/results/rasp
            cd /opt/app
            docker compose down
            export DD_APPSEC=false DD_IAST=false AIKIDO_BLOCK=true
            
            nohup docker compose up -d --build > /tmp/build.log 2>&1 &
            
            for i in {1..300}; do
              if docker ps | grep -q app; then
                echo "App ready"
                exit 0
              fi
              sleep 5
            done
            
            cat /tmp/build.log
            exit 1
          EOF
        timeout-minutes: 30

      - name: Run ZAP Scan
        run: |
          ssh -i ~/.ssh/key ubuntu@${{ env.EC2_IP }} 'bash -s' << 'EOF'
            mkdir -p /var/lib/results/rasp
            docker run --rm --network host \
              -v /var/lib/results/rasp:/zap/wrk \
              ghcr.io/zaproxy/zaproxy:stable \
              zap-baseline.py -t http://localhost:3000 -J report.json
          EOF

      - name: Extract and Push Metrics
        run: |
          ssh -i ~/.ssh/key ubuntu@${{ env.EC2_IP }} 'bash -s' << 'EOF'
            docker logs app > /tmp/logs.txt 2>&1
            
            DETECTED=$(grep -ci "detected\|vulnerability" /tmp/logs.txt || echo 0)
            BLOCKED=$(grep -ci "blocked" /tmp/logs.txt || echo 0)
            ALERTS=$(jq '.site[0].alerts | length' /var/lib/results/rasp/report.json 2>/dev/null || echo 0)
            
            cat << METRICS | curl --data-binary @- http://localhost:9091/metrics/job/rasp
            rasp_detected $DETECTED
            rasp_blocked $BLOCKED
            rasp_zap_alerts $ALERTS
            METRICS
          EOF

  report:
    name: Generate Report
    needs: [test-iast, test-rasp]
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          ssh-keyscan ${{ env.EC2_IP }} >> ~/.ssh/known_hosts

      - name: Create Summary
        run: |
          EC2_IP="${{ env.EC2_IP }}"
          ssh -i ~/.ssh/key ubuntu@$EC2_IP 'bash -s' << 'EOF'
            echo "# IAST vs RASP Comparison Results"
            echo ""
            echo "## Metrics"
            echo ""
            echo "### IAST (Detection Only)"
            curl -s http://localhost:9091/metrics | grep "^iast_"
            echo ""
            echo "### RASP (Detection + Blocking)"
            curl -s http://localhost:9091/metrics | grep "^rasp_"
          EOF | tee -a $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Grafana Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "Access: http://$EC2_IP:3001 (admin/admin)" >> $GITHUB_STEP_SUMMARY
