name: IAST vs RASP Benchmark

on:
  push:
    branches: [main, dev-test]
  workflow_dispatch:

env:
  EC2_IP: ${{ secrets.EC2_INSTANCE_IP }}

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          ssh-keyscan ${{ env.EC2_IP }} >> ~/.ssh/known_hosts

      - name: Run Ansible
        run: |
          pip install ansible
          cd ansible
          ansible-playbook -i "${{ env.EC2_IP }}," playbook.yml \
            -u ubuntu --private-key ~/.ssh/key
        env:
          DD_API_KEY: ${{ secrets.DATADOG_API_KEY }}
          DD_SITE: ${{ secrets.DATADOG_SITE }}
          AIKIDO_TOKEN: ${{ secrets.ZEN_FIREWALL_TOKEN }}
          ANSIBLE_HOST_KEY_CHECKING: "False"

  test-iast:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          ssh-keyscan ${{ env.EC2_IP }} >> ~/.ssh/known_hosts

      - name: Build and Run
        run: |
          ssh -i ~/.ssh/key ubuntu@${{ env.EC2_IP }} << 'EOF'
            cd /opt/app
            export DD_APPSEC=true DD_IAST=true AIKIDO_BLOCK=false
            
            nohup docker compose up -d --build > /tmp/build.log 2>&1 &
            
            for i in {1..300}; do
              if docker ps | grep -q app; then
                echo "Ready"
                exit 0
              fi
              sleep 5
            done
            cat /tmp/build.log
            exit 1
          EOF
        timeout-minutes: 30

      - name: ZAP Scan
        run: |
          ssh -i ~/.ssh/key ubuntu@${{ env.EC2_IP }} << 'EOF'
            mkdir -p /var/lib/results/iast
            docker run --rm --network host \
              -v /var/lib/results/iast:/zap/wrk \
              ghcr.io/zaproxy/zaproxy:stable \
              zap-baseline.py -t http://localhost:3000 -J report.json
          EOF

      - name: Push Metrics
        run: |
          ssh -i ~/.ssh/key ubuntu@${{ env.EC2_IP }} << 'EOF'
            docker logs app > /tmp/logs.txt 2>&1
            DETECTED=$(grep -ci "detected\|vulnerability" /tmp/logs.txt || echo 0)
            BLOCKED=$(grep -ci "blocked" /tmp/logs.txt || echo 0)
            ALERTS=$(jq '.site[0].alerts | length' /var/lib/results/iast/report.json 2>/dev/null || echo 0)
            
            cat << METRICS | curl --data-binary @- http://localhost:9091/metrics/job/iast
            iast_detected $DETECTED
            iast_blocked $BLOCKED
            iast_zap_alerts $ALERTS
            METRICS
          EOF

  test-rasp:
    needs: test-iast
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          ssh-keyscan ${{ env.EC2_IP }} >> ~/.ssh/known_hosts

      - name: Build and Run
        run: |
          ssh -i ~/.ssh/key ubuntu@${{ env.EC2_IP }} << 'EOF'
            cd /opt/app
            docker compose down
            export DD_APPSEC=false DD_IAST=false AIKIDO_BLOCK=true
            
            nohup docker compose up -d --build > /tmp/build.log 2>&1 &
            
            for i in {1..300}; do
              if docker ps | grep -q app; then
                echo "Ready"
                exit 0
              fi
              sleep 5
            done
            cat /tmp/build.log
            exit 1
          EOF
        timeout-minutes: 30

      - name: ZAP Scan
        run: |
          ssh -i ~/.ssh/key ubuntu@${{ env.EC2_IP }} << 'EOF'
            mkdir -p /var/lib/results/rasp
            docker run --rm --network host \
              -v /var/lib/results/rasp:/zap/wrk \
              ghcr.io/zaproxy/zaproxy:stable \
              zap-baseline.py -t http://localhost:3000 -J report.json
          EOF

      - name: Push Metrics
        run: |
          ssh -i ~/.ssh/key ubuntu@${{ env.EC2_IP }} << 'EOF'
            docker logs app > /tmp/logs.txt 2>&1
            DETECTED=$(grep -ci "detected\|vulnerability" /tmp/logs.txt || echo 0)
            BLOCKED=$(grep -ci "blocked" /tmp/logs.txt || echo 0)
            ALERTS=$(jq '.site[0].alerts | length' /var/lib/results/rasp/report.json 2>/dev/null || echo 0)
            
            cat << METRICS | curl --data-binary @- http://localhost:9091/metrics/job/rasp
            rasp_detected $DETECTED
            rasp_blocked $BLOCKED
            rasp_zap_alerts $ALERTS
            METRICS
          EOF

  report:
    needs: [test-iast, test-rasp]
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          ssh-keyscan ${{ env.EC2_IP }} >> ~/.ssh/known_hosts

      - name: Summary
        run: |
          ssh -i ~/.ssh/key ubuntu@${{ env.EC2_IP }} << 'EOF'
            echo "# Results"
            echo ""
            echo "## IAST"
            curl -s http://localhost:9091/metrics | grep "^iast_"
            echo ""
            echo "## RASP"
            curl -s http://localhost:9091/metrics | grep "^rasp_"
          EOF | tee -a $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Grafana: http://${{ env.EC2_IP }}:3001 (admin/admin)" >> $GITHUB_STEP_SUMMARY
