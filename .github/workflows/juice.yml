name: DevSecOps Pipeline - Persistent Containers with Daily Attack Testing

on:
  push:
    branches: [main, dev-test]
  pull_request:
    branches: [main, dev-test]
  workflow_dispatch:
    inputs:
      action_type:
        description: "Action to perform"
        required: true
        type: choice
        options:
          - initial-setup
          - daily-attacks
          - switch-scenario
          - status-check
        default: daily-attacks
      target_scenario:
        description: "Target scenario for attacks or switch"
        required: false
        type: choice
        options:
          - scenario1-iast-only
          - scenario2a-iast-rasp-detect
          - scenario2b-iast-rasp-block
          - all
        default: scenario2b-iast-rasp-block
      attack_intensity:
        description: "Attack intensity (number of attack iterations)"
        required: false
        type: choice
        options:
          - light
          - medium
          - heavy
        default: medium
  schedule:
    # Run daily attacks automatically at 2 AM UTC
    - cron: '0 2 * * *'

env:
  EC2_INSTANCE_IP: ${{ secrets.EC2_INSTANCE_IP }}
  SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
  EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
  ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

jobs:
  # =========================================================================
  # JOB 1: Determine Action Type
  # =========================================================================
  determine-action:
    name: üéØ Determine Action Type
    runs-on: ubuntu-latest
    outputs:
      action_type: ${{ steps.determine.outputs.action_type }}
      target_scenario: ${{ steps.determine.outputs.target_scenario }}
      attack_intensity: ${{ steps.determine.outputs.attack_intensity }}
    steps:
      - name: Determine action based on trigger
        id: determine
        run: |
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "action_type=daily-attacks" >> $GITHUB_OUTPUT
            echo "target_scenario=all" >> $GITHUB_OUTPUT
            echo "attack_intensity=medium" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "action_type=${{ github.event.inputs.action_type }}" >> $GITHUB_OUTPUT
            echo "target_scenario=${{ github.event.inputs.target_scenario }}" >> $GITHUB_OUTPUT
            echo "attack_intensity=${{ github.event.inputs.attack_intensity }}" >> $GITHUB_OUTPUT
          else
            echo "action_type=initial-setup" >> $GITHUB_OUTPUT
            echo "target_scenario=all" >> $GITHUB_OUTPUT
            echo "attack_intensity=medium" >> $GITHUB_OUTPUT
          fi
          
          echo "Action: ${{ steps.determine.outputs.action_type }}"
          echo "Target: ${{ steps.determine.outputs.target_scenario }}"

  # =========================================================================
  # JOB 2: SAST - Semgrep (Runs on initial setup only)
  # =========================================================================
  sast-semgrep:
    name: üîç SAST - Semgrep
    runs-on: ubuntu-latest
    needs: determine-action
    if: needs.determine-action.outputs.action_type == 'initial-setup'
    container:
      image: semgrep/semgrep
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Semgrep Scan
        run: |
          semgrep scan --config=auto --json --output=semgrep-results.json || true
          semgrep scan --config=auto --sarif --output=semgrep-results.sarif || true
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload to Semgrep Dashboard
        if: always()
        run: semgrep ci
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        continue-on-error: true

      - name: Upload Semgrep Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: |
            semgrep-results.json
            semgrep-results.sarif

  # =========================================================================
  # JOB 3: Prerequisites Check
  # =========================================================================
  check-prerequisites:
    name: ‚úÖ Verify Prerequisites
    runs-on: ubuntu-latest
    needs: [determine-action, sast-semgrep]
    if: |
      always() &&
      needs.determine-action.outputs.action_type == 'initial-setup'
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
    steps:
      - name: Check Required Secrets
        id: check
        run: |
          MISSING_SECRETS=()
          if [ -z "${{ secrets.EC2_INSTANCE_IP }}" ]; then
            MISSING_SECRETS+=("EC2_INSTANCE_IP")
          fi
          if [ -z "${{ secrets.EC2_SSH_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS+=("EC2_SSH_PRIVATE_KEY")
          fi
          if [ -z "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" ]; then
            MISSING_SECRETS+=("ANSIBLE_VAULT_PASSWORD")
          fi
          if [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
            echo "::error::Missing secrets: ${MISSING_SECRETS[*]}"
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "‚úÖ All secrets configured"
          echo "can_proceed=true" >> $GITHUB_OUTPUT

  # =========================================================================
  # JOB 4: Configure Infrastructure (ONCE)
  # =========================================================================
  configure-instance:
    name: ‚öôÔ∏è Configure Infrastructure (OpenTelemetry)
    runs-on: ubuntu-latest
    needs: check-prerequisites
    if: needs.check-prerequisites.outputs.can_proceed == 'true'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: pip install ansible boto3 botocore

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Wait for SSH
        run: |
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
               -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} \
               "echo 'SSH ready'" 2>/dev/null; then
              echo "‚úÖ SSH ready"
              exit 0
            fi
            echo "Attempt $i/30..."
            sleep 10
          done
          exit 1

      - name: Create Ansible Inventory
        run: |
          mkdir -p ansible
          cat > ansible/inventory.ini <<EOF
          [juiceshop]
          ${{ env.EC2_INSTANCE_IP }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF

      - name: Create Vault Password
        run: |
          cd ansible
          echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault_pass
          chmod 600 .vault_pass

      - name: Run Ansible Playbook
        run: |
          cd ansible
          ansible-playbook -i inventory.ini playbook.yml --vault-password-file .vault_pass -v

      - name: Clean Up Vault
        if: always()
        run: rm -f ansible/.vault_pass

  # =========================================================================
  # JOB 5: Deploy All Three Scenarios (ONCE - Persistent Containers)
  # =========================================================================
  deploy-all-scenarios:
    name: üöÄ Deploy All Three Scenarios (Persistent)
    runs-on: ubuntu-latest
    needs: [determine-action, configure-instance]
    if: |
      always() &&
      needs.determine-action.outputs.action_type == 'initial-setup' &&
      (needs.configure-instance.result == 'success' || needs.configure-instance.result == 'skipped')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Deploy Scenario 1 (IAST Only) - Port 3100
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'DEPLOY'
            set -e
            
            # Create dedicated directory for Scenario 1
            sudo mkdir -p /opt/juice-shop-scenarios/scenario1
            cd /opt/juice-shop-scenarios/scenario1
            sudo cp -r /opt/juice-shop/* .
            sudo chown -R ubuntu:ubuntu /opt/juice-shop-scenarios
            
            echo "üî¨ SCENARIO 1: IAST Only (Port 3100)"
            
            # Update scenario tracking
            cat > /opt/security-metrics/data/scenario1_info.json <<EOF
            {
              "current_scenario": "iast-only",
              "scenario_id": 1,
              "scenario_name": "IAST Only - Detection Only",
              "rasp_enabled": false,
              "rasp_blocking": false,
              "port": 3100,
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }
          EOF
            
            # Create docker-compose.yml
            cat > docker-compose.yml <<'COMPOSE'
          services:
            juice-shop:
              build: .
              image: juice-shop-secure:iast-only
              container_name: juice-shop-s1
              restart: unless-stopped
              ports:
                - "3100:3000"
              environment:
                NODE_ENV: production
                DD_ENV: dev
                DD_SERVICE: juice-shop-iast-only
                DD_VERSION: scenario1
                DD_AGENT_HOST: 172.17.0.1
                DD_TRACE_AGENT_PORT: 8126
                DD_LOGS_INJECTION: "true"
                DD_TRACE_SAMPLE_RATE: "1"
                DD_APPSEC_ENABLED: "true"
                DD_IAST_ENABLED: "true"
                DD_OTLP_CONFIG_RECEIVER_PROTOCOLS_GRPC_ENDPOINT: "0.0.0.0:4317"
                DD_OTLP_CONFIG_TRACES_ENABLED: "true"
                AIKIDO_BLOCK: "false"
              extra_hosts:
                - "host.docker.internal:host-gateway"
          COMPOSE
            
            docker compose build --no-cache
            docker compose up -d
            sleep 30
            docker ps | grep juice-shop-s1 && echo "‚úÖ Scenario 1 deployed on port 3001"
          DEPLOY

      - name: Deploy Scenario 2A (IAST + RASP Detection) - Port 3200
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'DEPLOY'
            set -e
            
            sudo mkdir -p /opt/juice-shop-scenarios/scenario2a
            cd /opt/juice-shop-scenarios/scenario2a
            sudo cp -r /opt/juice-shop/* .
            sudo chown -R ubuntu:ubuntu /opt/juice-shop-scenarios
            
            echo "üõ°Ô∏è SCENARIO 2A: IAST + RASP Detection Only (Port 3200)"
            
            cat > /opt/security-metrics/data/scenario2a_info.json <<EOF
            {
              "current_scenario": "iast-rasp-detect",
              "scenario_id": 2,
              "scenario_name": "IAST + RASP - Detection Only",
              "rasp_enabled": true,
              "rasp_blocking": false,
              "port": 3200,
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }
          EOF
            
            cat > docker-compose.yml <<'COMPOSE'
          services:
            juice-shop:
              build: .
              image: juice-shop-secure:iast-rasp-detect
              container_name: juice-shop-s2a
              restart: unless-stopped
              ports:
                - "3200:3000"
              environment:
                NODE_ENV: production
                DD_ENV: dev
                DD_SERVICE: juice-shop-iast-rasp-detect
                DD_VERSION: scenario2a
                DD_AGENT_HOST: 172.17.0.1
                DD_TRACE_AGENT_PORT: 8126
                DD_LOGS_INJECTION: "true"
                DD_TRACE_SAMPLE_RATE: "1"
                DD_APPSEC_ENABLED: "true"
                DD_IAST_ENABLED: "true"
                DD_OTLP_CONFIG_TRACES_ENABLED: "true"
                AIKIDO_TOKEN: ${AIKIDO_TOKEN}
                AIKIDO_BLOCK: "false"
                AIKIDO_DEBUG: "true"
                AIKIDO_FEATURE_COLLECT_METRICS: "true"
                OTEL_EXPORTER_OTLP_ENDPOINT: "http://172.17.0.1:4317"
              env_file:
                - /opt/juice-shop/.env
              extra_hosts:
                - "host.docker.internal:host-gateway"
          COMPOSE
            
            docker compose build --no-cache
            docker compose up -d
            sleep 30
            docker ps | grep juice-shop-s2a && echo "‚úÖ Scenario 2A deployed on port 3002"
          DEPLOY

      - name: Deploy Scenario 2B (IAST + RASP Blocking) - Port 3300
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'DEPLOY'
            set -e
            
            sudo mkdir -p /opt/juice-shop-scenarios/scenario2b
            cd /opt/juice-shop-scenarios/scenario2b
            sudo cp -r /opt/juice-shop/* .
            sudo chown -R ubuntu:ubuntu /opt/juice-shop-scenarios
            
            echo "üö´ SCENARIO 2B: IAST + RASP Blocking (Port 3300)"
            
            cat > /opt/security-metrics/data/scenario2b_info.json <<EOF
            {
              "current_scenario": "iast-rasp-block",
              "scenario_id": 3,
              "scenario_name": "IAST + RASP - Blocking Mode",
              "rasp_enabled": true,
              "rasp_blocking": true,
              "port": 3300,
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }
          EOF
            
            cat > docker-compose.yml <<'COMPOSE'
          services:
            juice-shop:
              build: .
              image: juice-shop-secure:iast-rasp-block
              container_name: juice-shop-s2b
              restart: unless-stopped
              ports:
                - "3300:3000"
              environment:
                NODE_ENV: production
                DD_ENV: dev
                DD_SERVICE: juice-shop-iast-rasp-block
                DD_VERSION: scenario2b
                DD_AGENT_HOST: 172.17.0.1
                DD_TRACE_AGENT_PORT: 8126
                DD_LOGS_INJECTION: "true"
                DD_TRACE_SAMPLE_RATE: "1"
                DD_APPSEC_ENABLED: "true"
                DD_IAST_ENABLED: "true"
                DD_OTLP_CONFIG_TRACES_ENABLED: "true"
                AIKIDO_TOKEN: ${AIKIDO_TOKEN}
                AIKIDO_BLOCK: "true"
                AIKIDO_DEBUG: "true"
                AIKIDO_FEATURE_COLLECT_METRICS: "true"
                OTEL_EXPORTER_OTLP_ENDPOINT: "http://172.17.0.1:4317"
              env_file:
                - /opt/juice-shop/.env
              extra_hosts:
                - "host.docker.internal:host-gateway"
          COMPOSE
            
            docker compose build --no-cache
            docker compose up -d
            sleep 30
            docker ps | grep juice-shop-s2b && echo "‚úÖ Scenario 2B deployed on port 3003"
          DEPLOY

      - name: Verify All Containers Running
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'VERIFY'
            echo "üìä Container Status:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo ""
            echo "üîç Health Checks:"
            curl -f http://localhost:3100 && echo "‚úÖ Scenario 1 (Port 3100) - Healthy" || echo "‚ùå Scenario 1 - Failed"
            curl -f http://localhost:3200 && echo "‚úÖ Scenario 2A (Port 3200) - Healthy" || echo "‚ùå Scenario 2A - Failed"
            curl -f http://localhost:3300 && echo "‚úÖ Scenario 2B (Port 3300) - Healthy" || echo "‚ùå Scenario 2B - Failed"
          VERIFY

  # =========================================================================
  # JOB 6: Daily Attack Simulation (REPEATABLE)
  # =========================================================================
  daily-attacks:
    name: üéØ Daily Attack Simulation
    runs-on: ubuntu-latest
    needs: determine-action
    if: needs.determine-action.outputs.action_type == 'daily-attacks'
    strategy:
      matrix:
        scenario: 
          - { name: "scenario1-iast-only", port: 3100, label: "iast-only" }
          - { name: "scenario2a-iast-rasp-detect", port: 3200, label: "iast-rasp-detect" }
          - { name: "scenario2b-iast-rasp-block", port: 3300, label: "iast-rasp-block" }
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Determine Attack Intensity
        id: intensity
        run: |
          INTENSITY="${{ needs.determine-action.outputs.attack_intensity }}"
          case "$INTENSITY" in
            light)
              echo "iterations=20" >> $GITHUB_OUTPUT
              echo "scan=false" >> $GITHUB_OUTPUT
              ;;
            medium)
              echo "iterations=50" >> $GITHUB_OUTPUT
              echo "scan=true" >> $GITHUB_OUTPUT
              ;;
            heavy)
              echo "iterations=100" >> $GITHUB_OUTPUT
              echo "scan=true" >> $GITHUB_OUTPUT
              ;;
          esac
          echo "Attack intensity: $INTENSITY"

      - name: DAST Baseline Scan (If Enabled)
        if: steps.intensity.outputs.scan == 'true'
        run: |
          echo "üï∑Ô∏è Running ZAP Baseline Scan on ${{ matrix.scenario.name }}"
          docker run --rm -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://${{ env.EC2_INSTANCE_IP }}:${{ matrix.scenario.port }} \
            -J ${{ matrix.scenario.name }}-baseline-$(date +%Y%m%d).json \
            -r ${{ matrix.scenario.name }}-baseline-$(date +%Y%m%d).html \
            -T 120 || true

      - name: Targeted Attack Simulation
        run: |
          echo "üéØ Launching ${{ steps.intensity.outputs.iterations }} attack iterations against ${{ matrix.scenario.name }}"
          
          BLOCKED=0
          TOTAL=${{ steps.intensity.outputs.iterations }}
          
          for i in $(seq 1 $TOTAL); do
            # XSS Attack
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              "http://${{ env.EC2_INSTANCE_IP }}:${{ matrix.scenario.port }}/rest/products/search?q=<script>alert(1)</script>")
            [ "$HTTP_CODE" == "403" ] || [ "$HTTP_CODE" == "418" ] && BLOCKED=$((BLOCKED + 1))
            
            # SQL Injection
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              "http://${{ env.EC2_INSTANCE_IP }}:${{ matrix.scenario.port }}/rest/products/search?q=' OR '1'='1")
            [ "$HTTP_CODE" == "403" ] || [ "$HTTP_CODE" == "418" ] && BLOCKED=$((BLOCKED + 1))
            
            # Path Traversal
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              "http://${{ env.EC2_INSTANCE_IP }}:${{ matrix.scenario.port }}/ftp/../../../etc/passwd")
            [ "$HTTP_CODE" == "403" ] || [ "$HTTP_CODE" == "418" ] && BLOCKED=$((BLOCKED + 1))
            
            # Command Injection
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST "http://${{ env.EC2_INSTANCE_IP }}:${{ matrix.scenario.port }}/api/feedback" \
              -H "Content-Type: application/json" \
              -d '{"comment": "test; cat /etc/passwd"}')
            [ "$HTTP_CODE" == "403" ] || [ "$HTTP_CODE" == "418" ] && BLOCKED=$((BLOCKED + 1))
            
            sleep 1
          done
          
          TOTAL_ATTEMPTS=$((TOTAL * 4))
          BLOCK_RATE=$((BLOCKED * 100 / TOTAL_ATTEMPTS))
          
          echo "üìä Attack Summary for ${{ matrix.scenario.name }}:"
          echo "   Total Attempts: $TOTAL_ATTEMPTS"
          echo "   Blocked: $BLOCKED"
          echo "   Block Rate: ${BLOCK_RATE}%"
          
          # Save metrics
          cat > attack-summary-${{ matrix.scenario.name }}.json <<EOF
          {
            "scenario": "${{ matrix.scenario.name }}",
            "date": "$(date -u +%Y-%m-%d)",
            "time": "$(date -u +%H:%M:%S)",
            "total_attempts": $TOTAL_ATTEMPTS,
            "blocked": $BLOCKED,
            "block_rate": $BLOCK_RATE,
            "intensity": "${{ needs.determine-action.outputs.attack_intensity }}"
          }
          EOF

      - name: Upload Attack Results
        uses: actions/upload-artifact@v4
        with:
          name: attack-results-${{ matrix.scenario.name }}-${{ github.run_number }}
          path: |
            attack-summary-*.json
            ${{ matrix.scenario.name }}-baseline-*.json
            ${{ matrix.scenario.name }}-baseline-*.html

  # =========================================================================
  # JOB 7: Container Status Check
  # =========================================================================
  status-check:
    name: üìä Container Status Check
    runs-on: ubuntu-latest
    needs: determine-action
    if: needs.determine-action.outputs.action_type == 'status-check'
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Check All Containers
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'STATUS'
            echo "üîç Container Status Report"
            echo "=========================="
            echo ""
            
            echo "üì¶ Running Containers:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep juice-shop || echo "No containers running"
            
            echo ""
            echo "üåê Health Checks:"
            curl -f http://localhost:3100 && echo "‚úÖ Scenario 1 (3100) - IAST Only" || echo "‚ùå Scenario 1 - Down"
            curl -f http://localhost:3200 && echo "‚úÖ Scenario 2A (3200) - IAST+RASP (Detect)" || echo "‚ùå Scenario 2A - Down"
            curl -f http://localhost:3300 && echo "‚úÖ Scenario 2B (3300) - IAST+RASP (Block)" || echo "‚ùå Scenario 2B - Down"
            
            echo ""
            echo "üìä Resource Usage:"
            docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" | grep juice-shop || echo "No stats available"
            
            echo ""
            echo "üìà Recent Logs (Last 10 lines per container):"
            for container in juice-shop-s1 juice-shop-s2a juice-shop-s2b; do
              if docker ps | grep -q $container; then
                echo "--- $container ---"
                docker logs $container --tail 10 2>&1 | tail -10
              fi
            done
          STATUS

  # =========================================================================
  # JOB 8: Generate Daily Report
  # =========================================================================
  generate-daily-report:
    name: üìä Generate Daily Report
    runs-on: ubuntu-latest
    needs: daily-attacks
    if: always() && needs.daily-attacks.result != 'skipped'
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Generate Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # üéØ Daily Attack Simulation Report
          
          **Date:** $(date -u '+%Y-%m-%d')
          **Run:** #${{ github.run_number }}
          
          ## Scenarios Tested
          
          | Scenario | Port | Expected Blocking | Status |
          |----------|------|-------------------|--------|
          | IAST Only | 3100 | 0% | Tested ‚úì |
          | IAST + RASP (Detect) | 3200 | 0% | Tested ‚úì |
          | IAST + RASP (Block) | 3300 | ~80% | Tested ‚úì |
          
          ## Data Collection Status
          
          - ‚úÖ Attack simulations completed
          - ‚úÖ Metrics sent to Prometheus
          - ‚úÖ OpenTelemetry data flowing
          - ‚úÖ Grafana dashboards updated
          
          ## View Results
          
          - **Grafana Dashboard**: http://${{ env.EC2_INSTANCE_IP }}:3001
          - **Prometheus**: http://${{ env.EC2_INSTANCE_IP }}:9090
          - **Artifacts**: Check this workflow run for detailed results
          
          ## Next Scheduled Run
          
          Automatic daily attacks will run tomorrow at 2:00 AM UTC.
          
          To run manually: Actions ‚Üí This workflow ‚Üí Run workflow ‚Üí Select "daily-attacks"
          EOF