name: DevSecOps Pipeline - Deploy & Security Scans

# This pipeline assumes:
# 1. EC2 instance already provisioned manually
# 2. EC2_INSTANCE_IP secret is set in GitHub
# 3. Infrastructure managed separately (not in this pipeline)

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:
    inputs:
      skip_ansible:
        description: "Skip Ansible configuration (if already configured)"
        required: false
        type: boolean
        default: true
      run_full_security_scan:
        description: "Run full security scan (including DAST)"
        required: false
        type: boolean
        default: true

env:
  EC2_INSTANCE_IP: ${{ secrets.EC2_INSTANCE_IP }}
  SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
  EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
  ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

jobs:
  # =========================================================================
  # JOB 1: SAST - Semgrep (Always Run First)
  # =========================================================================
  sast-semgrep:
    name: üîç SAST - Semgrep Security Scan
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Semgrep Scan
        run: |
          semgrep scan --config=auto --json --output=semgrep-results.json || true
          semgrep scan --config=auto --sarif --output=semgrep-result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s.sarif || true
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload to Semgrep Dashboard
        if: always()
        run: semgrep ci
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        continue-on-error: true

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep
        continue-on-error: true

      - name: Upload Semgrep Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: |
            semgrep-results.json
            semgrep-results.sarif

  # =========================================================================
  # JOB 2: Check Prerequisites
  # =========================================================================
  check-prerequisites:
    name: ‚úÖ Verify Prerequisites
    runs-on: ubuntu-latest
    needs: sast-semgrep
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
    steps:
      - name: Check Required Secrets
        id: check
        run: |
          echo "Checking required secrets..."

          MISSING_SECRETS=()

          if [ -z "${{ secrets.EC2_INSTANCE_IP }}" ]; then
            MISSING_SECRETS+=("EC2_INSTANCE_IP")
          fi

          if [ -z "${{ secrets.EC2_SSH_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS+=("EC2_SSH_PRIVATE_KEY")
          fi

          if [ -z "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" ]; then
            MISSING_SECRETS+=("ANSIBLE_VAULT_PASSWORD")
          fi

          if [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
            echo "::error::Missing required secrets: ${MISSING_SECRETS[*]}"
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "‚úÖ All required secrets are set"
          echo "Target instance: ${{ secrets.EC2_INSTANCE_IP }}"
          echo "can_proceed=true" >> $GITHUB_OUTPUT

  # =========================================================================
  # JOB 3: Configure Instance (Optional - Only if needed)
  # =========================================================================
  configure-instance:
    name: ‚öôÔ∏è Configure Instance with Ansible
    runs-on: ubuntu-latest
    needs: check-prerequisites
    # Only run if explicitly requested or on first deployment
    if: |
      needs.check-prerequisites.outputs.can_proceed == 'true' &&
      (github.event.inputs.skip_ansible == 'false' || github.event.inputs.skip_ansible == '')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: |
          pip install ansible boto3 botocore

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Wait for SSH Availability
        run: |
          echo "Testing SSH connection to ${{ env.EC2_INSTANCE_IP }}..."
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
               -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} \
               "echo 'SSH ready'" 2>/dev/null; then
              echo "‚úÖ SSH connection successful"
              exit 0
            fi
            echo "Attempt $i/30: Waiting for SSH..."
            sleep 10
          done
          echo "::error::SSH connection timeout"
          exit 1

      - name: Create Ansible Inventory
        run: |
          mkdir -p ansible
          cat > ansible/inventory.ini <<EOF
          [juiceshop]
          ${{ env.EC2_INSTANCE_IP }} ansible_user=ubuntu ansible_EC2_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF

      - name: Create Vault Password File
        run: |
          cd ansible
          echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault_pass
          chmod 600 .vault_pass

      - name: Run Ansible Playbook
        run: |
          cd ansible
          ansible-playbook -i inventory.ini playbook.yml \
            --vault-password-file .vault_pass \
            -v

      - name: Clean Up Vault Password
        if: always()
        run: |
          rm -f ansible/.vault_pass

      - name: Verify Configuration
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ubuntu@${{ env.EC2_INSTANCE_IP }} << 'ENDSSH'
            echo "=== Configuration Verification ==="
            docker --version
            docker compose version
            sudo datadog-agent status | head -20 || true
            ls -la /opt/juice-shop/
          ENDSSH

  # =========================================================================
  # JOB 4: Build and Deploy Application
  # =========================================================================
  build-and-deploy:
    name: üöÄ Build & Deploy Application
    runs-on: ubuntu-latest
    needs: [check-prerequisites, configure-instance]
    # Run if prerequisites pass, even if ansible was skipped
    if: |
      always() &&
      needs.check-prerequisites.outputs.can_proceed == 'true' &&
      (needs.configure-instance.result == 'success' || needs.configure-instance.result == 'skipped')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Check Instance Readiness
        run: |
          echo "Checking if instance is ready..."
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'ENDSSH'
            # Check if Docker is installed
            if ! command -v docker &> /dev/null; then
              echo "::error::Docker not installed. Run Ansible configuration first."
              exit 1
            fi
            
            # Check if application directory exists
            if [ ! -d "/opt/juice-shop" ]; then
              echo "::error::Application directory not found. Run Ansible configuration first."
              exit 1
            fi
            
            # Check if .env file exists
            if [ ! -f "/opt/juice-shop/.env" ]; then
              echo "::error::.env file not found. Run Ansible configuration first."
              exit 1
            fi
            
            echo "‚úÖ Instance is ready for deployment"
          ENDSSH

      - name: Deploy Application
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'ENDSSH'
            set -e
            cd /opt/juice-shop
            
            echo "======================================"
            echo "Building and Deploying Application"
            echo "======================================"
            
            # Stop existing container
            echo "‚Üí Stopping existing container..."
            docker compose down 2>/dev/null || true
            
            # Clean up old images (optional)
            echo "‚Üí Cleaning up old images..."
            docker image prune -f 2>/dev/null || true
            
            # Build new image
            echo "‚Üí Building Docker image..."
            docker compose build --no-cache
            
            # Start containers
            echo "‚Üí Starting containers..."
            docker compose up -d
            
            # Wait for application
            echo "‚Üí Waiting for application to be healthy..."
            sleep 45
            
            # Verify container is running
            if docker ps | grep -q juice-shop; then
              echo "‚úÖ Container is running"
            else
              echo "‚ùå Container failed to start"
              docker compose logs
              exit 1
            fi
            
            # Test application endpoint
            for i in {1..10}; do
              if curl -f -s http://localhost:3000 > /dev/null; then
                echo "‚úÖ Application is responding"
                break
              fi
              if [ $i -eq 10 ]; then
                echo "‚ùå Application not responding"
                exit 1
              fi
              echo "Waiting for application... ($i/10)"
              sleep 5
            done
            
            echo ""
            echo "=== Recent Logs ==="
            docker compose logs --tail=30
            
            echo ""
            echo "‚úÖ Deployment Complete!"
          ENDSSH

      - name: Verify Security Tools
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'ENDSSH'
            echo "=== Security Tools Verification ==="
            echo ""
            
            echo "1. Aikido Zen Firewall (RASP):"
            if docker logs juice-shop 2>&1 | grep -i "aikido" | head -5; then
              echo "‚úÖ Aikido Zen is active"
            else
              echo "‚ö†Ô∏è Aikido logs not found (may take a moment to initialize)"
            fi
            echo ""
            
            echo "2. DataDog Tracer (IAST):"
            if docker logs juice-shop 2>&1 | grep -i "datadog" | head -5; then
              echo "‚úÖ DataDog tracer is active"
            else
              echo "‚ö†Ô∏è DataDog logs not found (may take a moment to initialize)"
            fi
            echo ""
            
            echo "3. DataDog Agent (Host):"
            if sudo datadog-agent status | grep -A 3 "Agent (.*running)"; then
              echo "‚úÖ DataDog agent is running"
            else
              echo "‚ö†Ô∏è DataDog agent check failed"
            fi
            echo ""
          ENDSSH

      - name: Generate Deployment Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üöÄ Deployment Summary

          **Instance IP:** \`${{ env.EC2_INSTANCE_IP }}\`

          **Application URL:** http://${{ env.EC2_INSTANCE_IP }}:3000

          **Deployment Status:** ‚úÖ Success

          ### Security Tools Active:
          - ‚úÖ **SAST**: Semgrep (pre-deployment scan)
          - ‚úÖ **RASP**: Aikido Zen Firewall (runtime protection)
          - ‚úÖ **IAST**: DataDog Runtime Analysis (code-level detection)
          - ‚è≥ **DAST**: OWASP ZAP (running next)

          ### Security Dashboards:
          - [Semgrep Findings](https://semgrep.dev/orgs/-/findings)
          - [Aikido Dashboard](https://app.aikido.dev)
          - [DataDog IAST](https://app.us5.datadoghq.com/security/appsec?service=juice-shop)

          ### Next Steps:
          1. Access application: http://${{ env.EC2_INSTANCE_IP }}:3000
          2. Monitor security dashboards
          3. Review DAST scan results (after completion)
          EOF

  # =========================================================================
  # JOB 5: DAST - OWASP ZAP Scan
  # =========================================================================
  dast-owasp-zap:
    name: üï∑Ô∏è DAST - OWASP ZAP Security Scan
    runs-on: ubuntu-latest
    needs: [check-prerequisites, build-and-deploy]
    # Only run on main/develop branches, not on PRs
    if: |
      always() &&
      needs.build-and-deploy.result == 'success' &&
      github.event_name != 'pull_request' &&
      (github.event.inputs.run_full_security_scan == 'true' || github.event.inputs.run_full_security_scan == '')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Wait for Application Stability
        run: |
          echo "Waiting 30 seconds for application to stabilize..."
          sleep 30

      - name: Verify Application is Accessible
        run: |
          if curl -f -s http://${{ env.EC2_INSTANCE_IP }}:3000 > /dev/null; then
            echo "‚úÖ Application is accessible for DAST scanning"
          else
            echo "::warning::Application not accessible, skipping DAST scan"
            exit 0
          fi

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: "http://${{ env.EC2_INSTANCE_IP }}:3000"
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-a -j -m 5 -T 60"
          allow_issue_writing: false
          fail_action: false
        continue-on-error: true

      - name: OWASP ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.8.0
        with:
          target: "http://${{ env.EC2_INSTANCE_IP }}:3000"
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-a -j -m 5 -T 120"
          allow_issue_writing: false
          fail_action: false
        continue-on-error: true

      - name: Upload ZAP Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-results
          path: |
            report_html.html
            report_json.json
            report_md.md

  # =========================================================================
  # JOB 6: IAST - DataDog Verification
  # =========================================================================
  iast-datadog-verification:
    name: üìä IAST - DataDog Runtime Analysis
    runs-on: ubuntu-latest
    needs: [check-prerequisites, build-and-deploy]
    if: needs.build-and-deploy.result == 'success'
    steps:
      - name: Generate Traffic for IAST Analysis
        run: |
          echo "Generating traffic for DataDog IAST analysis..."

          # Generate various request patterns
          for i in {1..50}; do
            # Homepage
            curl -s http://${{ env.EC2_INSTANCE_IP }}:3000 > /dev/null || true
            
            # Product search
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=juice" > /dev/null || true
            
            # API endpoints
            curl -s http://${{ env.EC2_INSTANCE_IP }}:3000/api/Challenges > /dev/null || true
            curl -s http://${{ env.EC2_INSTANCE_IP }}:3000/rest/admin/application-version > /dev/null || true
            
            # User-related endpoints
            curl -s http://${{ env.EC2_INSTANCE_IP }}:3000/rest/user/login > /dev/null || true
            
            sleep 1
          done

          echo "‚úÖ Generated 250+ requests for IAST analysis"
          echo "DataDog will analyze these requests for vulnerabilities"

      - name: Verify DataDog Integration
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF

          ## üìä DataDog IAST Analysis

          **Status:** Traffic generated successfully

          **Dashboard:** [View IAST Results](https://app.us5.datadoghq.com/security/appsec?service=juice-shop)

          **Analysis Timeline:**
          - Traces appear: ~2-5 minutes
          - Vulnerability detection: ~5-10 minutes
          - Complete analysis: ~15 minutes

          **What to Check:**
          1. Navigate to DataDog Security ‚Üí Application Security
          2. Filter by service: \`juice-shop\`
          3. Review detected vulnerabilities
          4. Check trace samples for code-level insights
          5. Verify IAST coverage metrics

          **Note:** IAST detects vulnerabilities during runtime by analyzing actual code execution paths.
          EOF

  # =========================================================================
  # JOB 7: Security Report
  # =========================================================================
  security-report:
    name: üìã Generate Security Report
    runs-on: ubuntu-latest
    needs:
      [
        sast-semgrep,
        build-and-deploy,
        dast-owasp-zap,
        iast-datadog-verification,
      ]
    if: always()
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Generate Comprehensive Security Report
        run: |
          cat > security-report.md << 'EOF'
          # üîí DevSecOps Security Scan Report

          **Pipeline Run:** #${{ github.run_number }}  
          **Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')  
          **Branch:** ${{ github.ref_name }}  
          **Commit:** ${{ github.sha }}  
          **Instance:** ${{ env.EC2_INSTANCE_IP }}

          ---

          ## üìä Security Scan Results

          | Security Layer | Type | Status | Dashboard |
          |----------------|------|--------|-----------|
          | **Semgrep** | SAST | ${{ needs.sast-semgrep.result }} | [View](https://semgrep.dev/orgs/-/findings) |
          | **Aikido Zen** | RASP | Active | [View](https://app.aikido.dev) |
          | **DataDog** | IAST | ${{ needs.iast-datadog-verification.result }} | [View](https://app.us5.datadoghq.com/security/appsec) |
          | **OWASP ZAP** | DAST | ${{ needs.dast-owasp-zap.result }} | Artifacts |

          ---

          ## üõ°Ô∏è Security Tool Descriptions

          ### 1. SAST - Semgrep (Static Analysis)
          - **What:** Scans source code for vulnerabilities before deployment
          - **When:** Every code commit
          - **Finds:** SQL injection, XSS, hardcoded secrets, insecure functions

          ### 2. RASP - Aikido Zen Firewall (Runtime Protection)
          - **What:** Real-time attack blocking and monitoring
          - **When:** Continuously while app runs
          - **Protects:** Against OWASP Top 10, injection attacks, malicious payloads

          ### 3. IAST - DataDog (Interactive Analysis)
          - **What:** Detects vulnerabilities during runtime with code context
          - **When:** Continuously while processing requests
          - **Finds:** Runtime vulnerabilities, unsafe data flows, actual exploits

          ### 4. DAST - OWASP ZAP (Dynamic Analysis)
          - **What:** Black-box testing of running application
          - **When:** After each deployment
          - **Finds:** Web vulnerabilities, configuration issues, exposed endpoints

          ---

          ## üéØ Next Steps

          1. **Review Semgrep** ‚Üí Fix high/critical code vulnerabilities
          2. **Check Aikido** ‚Üí Review blocked attacks and security events
          3. **Analyze DataDog** ‚Üí Address runtime vulnerabilities with code context
          4. **Review ZAP** ‚Üí Fix identified web application vulnerabilities
          5. **Monitor Continuously** ‚Üí Keep dashboards open for real-time alerts

          ---

          ## üì± Quick Links

          - **Application:** http://${{ env.EC2_INSTANCE_IP }}:3000
          - **Semgrep:** https://semgrep.dev/orgs/-/findings
          - **Aikido:** https://app.aikido.dev
          - **DataDog:** https://app.us5.datadoghq.com/security/appsec
          - **GitHub Actions:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          EOF

          cat security-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
        continue-on-error: true
