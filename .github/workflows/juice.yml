name: DevSecOps Pipeline - IAST vs RASP (Container Reuse Strategy)

on:
  push:
    branches: [main, dev-test]
  workflow_dispatch:
    inputs:
      run_scenario:
        description: "Which scenario to run"
        required: false
        type: choice
        options:
          - both
          - iast-only
          - iast-rasp
        default: both

env:
  EC2_INSTANCE_IP: ${{ secrets.EC2_INSTANCE_IP }}
  SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

jobs:
  # =========================================================================
  # JOB 1: SAST - Semgrep
  # =========================================================================
  sast-semgrep:
    name: üîç SAST - Semgrep
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Semgrep Scan
        run: |
          semgrep scan --config=auto --json --output=semgrep-results.json || true
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload Semgrep Results
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.json

  # =========================================================================
  # JOB 2: Build Application ONCE
  # =========================================================================
  build-application:
    name: üì¶ Build Application (One-Time)
    runs-on: ubuntu-latest
    needs: sast-semgrep
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Build Docker Image (One Time Only)
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'BUILD'
            set -e
            cd /opt/juice-shop
            
            echo "üßπ CLEANUP: Removing old containers and images..."
            docker compose down -v 2>/dev/null || true
            docker rm -f juice-shop 2>/dev/null || true
            docker rmi juice-shop-secure:latest 2>/dev/null || true
            docker system prune -f
            
            echo ""
            echo "üì¶ BUILDING IMAGE (this takes 5-10 minutes)..."
            docker compose build --no-cache --progress=plain
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ Image built successfully"
              docker images | grep juice-shop-secure
            else
              echo "‚ùå Build failed"
              exit 1
            fi
          BUILD

      - name: Start Application with Default Config
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'START'
            cd /opt/juice-shop
            
            # Start with IAST+RASP config
            docker compose up -d
            
            echo "‚è≥ Waiting for application (60s)..."
            sleep 60
            
            if docker ps | grep -q juice-shop; then
              echo "‚úÖ Application running"
              curl -f http://localhost:3000 && echo "‚úÖ Health check passed"
            else
              echo "‚ùå Failed to start"
              docker compose logs
              exit 1
            fi
          START

  # =========================================================================
  # JOB 3: SCENARIO 1 - IAST Only (Switch env, no rebuild!)
  # =========================================================================
  scenario1-iast-only:
    name: üî¨ Scenario 1 - IAST Only
    runs-on: ubuntu-latest
    needs: build-application
    if: |
      github.event.inputs.run_scenario == 'both' || 
      github.event.inputs.run_scenario == 'iast-only' || 
      github.event.inputs.run_scenario == ''
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Switch to IAST-Only Configuration (No Rebuild!)
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'SWITCH'
            cd /opt/juice-shop
            
            echo "üîÑ SWITCHING TO SCENARIO 1: IAST Only"
            
            # Update metrics
            jq '.scan_phase = 0 | .scenario = "iast-only" | .scenario_id = 1' \
              /opt/security-metrics/data/manual_metrics.json > /tmp/m.json
            mv /tmp/m.json /opt/security-metrics/data/manual_metrics.json
            
            # Run switch script (instant - no rebuild!)
            ./switch-scenario.sh iast-only
            
            echo "‚úÖ Switched to IAST-only mode"
            
            # Verify
            docker exec juice-shop env | grep "AIKIDO_BLOCK=false" || echo "‚ö†Ô∏è Check config"
          SWITCH

      - name: Run DAST Testing - Scenario 1
        run: |
          # Baseline scan
          docker run --rm -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 \
            -J scenario1-baseline.json || true

          # Full scan
          docker run --rm -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 \
            -J scenario1-full.json -m 5 -T 180 || true

          # Upload results
          scp -i ~/.ssh/id_rsa scenario1-*.json \
            ubuntu@${{ env.EC2_INSTANCE_IP }}:/opt/security-metrics/zap-results/ || true

          # Targeted attacks
          echo "üéØ Executing targeted attacks (20 iterations)..."
          for i in {1..20}; do
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=<script>alert(1)</script>" >/dev/null || true
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=' OR '1'='1" >/dev/null || true
            sleep 2
          done

          echo "‚úÖ Scenario 1 complete - attacks detected but NOT blocked"

      - name: Upload Scenario 1 Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scenario1-results
          path: |
            scenario1-*.json
            scenario1-*.html

  # =========================================================================
  # JOB 4: SCENARIO 2 - IAST + RASP (Switch env, no rebuild!)
  # =========================================================================
  scenario2-iast-rasp:
    name: üõ°Ô∏è Scenario 2 - IAST + RASP
    runs-on: ubuntu-latest
    needs: [build-application, scenario1-iast-only]
    if: |
      always() &&
      needs.build-application.result == 'success' &&
      (github.event.inputs.run_scenario == 'both' || 
       github.event.inputs.run_scenario == 'iast-rasp' || 
       github.event.inputs.run_scenario == '')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Switch to IAST+RASP Configuration (No Rebuild!)
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'SWITCH'
            cd /opt/juice-shop
            
            echo "üîÑ SWITCHING TO SCENARIO 2: IAST + RASP"
            
            # Update metrics
            jq '.scan_phase = 0 | .scenario = "iast-rasp" | .scenario_id = 2' \
              /opt/security-metrics/data/manual_metrics.json > /tmp/m.json
            mv /tmp/m.json /opt/security-metrics/data/manual_metrics.json
            
            # Run switch script (instant - no rebuild!)
            ./switch-scenario.sh iast-rasp
            
            echo "‚úÖ Switched to IAST+RASP mode"
            
            # Verify RASP is active
            docker exec juice-shop env | grep "AIKIDO_BLOCK=true" || echo "‚ö†Ô∏è Check config"
            docker logs juice-shop 2>&1 | grep -i "aikido" | tail -10
          SWITCH

      - name: Run DAST Testing - Scenario 2
        run: |
          # Same tests as scenario 1
          docker run --rm -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 \
            -J scenario2-baseline.json || true

          docker run --rm -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 \
            -J scenario2-full.json -m 5 -T 180 || true

          scp -i ~/.ssh/id_rsa scenario2-*.json \
            ubuntu@${{ env.EC2_INSTANCE_IP }}:/opt/security-metrics/zap-results/ || true

          # Targeted attacks (should be blocked by RASP!)
          echo "üéØ Executing attacks - RASP should block these"
          for i in {1..20}; do
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=<script>alert(1)</script>" >/dev/null || echo "Blocked by RASP"
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=' OR '1'='1" >/dev/null || echo "Blocked by RASP"
            sleep 2
          done

          echo "‚úÖ Scenario 2 complete - attacks detected AND blocked"

      - name: Verify RASP Blocking
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'VERIFY'
            echo "üõ°Ô∏è RASP Blocking Evidence:"
            docker logs juice-shop 2>&1 | grep -i "blocked\|aikido" | tail -30
          VERIFY

      - name: Upload Scenario 2 Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scenario2-results
          path: |
            scenario2-*.json
            scenario2-*.html

  # =========================================================================
  # JOB 5: Generate Comparison Report
  # =========================================================================
  generate-comparison:
    name: üìä Generate Comparison Report
    runs-on: ubuntu-latest
    needs: [scenario1-iast-only, scenario2-iast-rasp]
    if: always()
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Query Metrics
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'METRICS'
            echo "üìä COMPARATIVE ANALYSIS"
            echo "======================"
            
            echo "Scenario 1 - IAST Only:"
            curl -s http://localhost:9999/metrics | grep 'scenario="iast-only"' | head -10 || echo "No metrics yet"
            
            echo ""
            echo "Scenario 2 - IAST + RASP:"
            curl -s http://localhost:9999/metrics | grep 'scenario="iast-rasp"' | head -10 || echo "No metrics yet"
            
            echo ""
            echo "RASP Blocks (should only be in Scenario 2):"
            curl -s http://localhost:9999/metrics | grep 'security_blocks_total' || echo "No blocks recorded"
          METRICS
