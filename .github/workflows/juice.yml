name: DevSecOps Pipeline - IAST vs RASP Comparison (Dual Scenario)

on:
  push:
    branches: [main, dev-test]
  pull_request:
    branches: [main, dev-test]
  workflow_dispatch:
    inputs:
      skip_ansible:
        description: "Skip Ansible configuration"
        required: false
        type: boolean
        default: false
      run_scenario:
        description: "Which scenario to run"
        required: false
        type: choice
        options:
          - both
          - iast-only
          - iast-rasp
        default: both

env:
  EC2_INSTANCE_IP: ${{ secrets.EC2_INSTANCE_IP }}
  SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
  EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
  ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

jobs:
  sast-semgrep:
    name: ðŸ” SAST - Semgrep
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Semgrep Scan
        run: |
          semgrep scan --config=auto --json --output=semgrep-results.json || true
          semgrep scan --config=auto --sarif --output=semgrep-results.sarif || true
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Validate and Format Semgrep JSON
        run: |
          if command -v jq &> /dev/null; then
            jq '.' semgrep-results.json > semgrep-results-formatted.json || cp semgrep-results.json semgrep-results-formatted.json
            mv semgrep-results-formatted.json semgrep-results.json
          fi

      - name: Upload to Semgrep Dashboard
        if: always()
        run: semgrep ci
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        continue-on-error: true

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep
        continue-on-error: true

      - name: Upload Semgrep Results to EC2
        if: always()
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

          scp -i ~/.ssh/id_rsa semgrep-results.json \
            ubuntu@${{ env.EC2_INSTANCE_IP }}:/opt/security-metrics/data/semgrep-results.json || echo "âš ï¸  Could not upload Semgrep results"

      - name: Upload Semgrep Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: |
            semgrep-results.json
            semgrep-results.sarif

  check-prerequisites:
    name: âœ… Verify Prerequisites
    runs-on: ubuntu-latest
    needs: sast-semgrep
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
    steps:
      - name: Check Required Secrets
        id: check
        run: |
          MISSING_SECRETS=()
          if [ -z "${{ secrets.EC2_INSTANCE_IP }}" ]; then
            MISSING_SECRETS+=("EC2_INSTANCE_IP")
          fi
          if [ -z "${{ secrets.EC2_SSH_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS+=("EC2_SSH_PRIVATE_KEY")
          fi
          if [ -z "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" ]; then
            MISSING_SECRETS+=("ANSIBLE_VAULT_PASSWORD")
          fi
          if [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
            echo "::error::Missing secrets: ${MISSING_SECRETS[*]}"
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "âœ… All secrets configured"
          echo "can_proceed=true" >> $GITHUB_OUTPUT

  configure-instance:
    name: âš™ï¸ Configure Infrastructure (Ansible)
    runs-on: ubuntu-latest
    needs: check-prerequisites
    if: |
      needs.check-prerequisites.outputs.can_proceed == 'true' &&
      github.event.inputs.skip_ansible != 'true'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: pip install ansible boto3 botocore

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Wait for SSH
        run: |
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
               -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} \
               "echo 'SSH ready'" 2>/dev/null; then
              echo "âœ… SSH ready"
              exit 0
            fi
            echo "Attempt $i/30..."
            sleep 10
          done
          exit 1

      - name: Create Ansible Inventory
        run: |
          mkdir -p ansible
          cat > ansible/inventory.ini <<EOF
          [juiceshop]
          ${{ env.EC2_INSTANCE_IP }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10'
          EOF

      - name: Create Vault Password
        run: |
          cd ansible
          echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault_pass
          chmod 600 .vault_pass

      - name: Run Ansible Playbook
        run: |
          cd ansible
          ansible-playbook -i inventory.ini playbook.yml --vault-password-file .vault_pass -v

      - name: Clean Up Vault
        if: always()
        run: rm -f ansible/.vault_pass

  # Helper job to build single image and upload to host (reused for both scenarios)
  build-and-upload-image:
    name: ðŸ“¦ Build & Push Image (local then load on remote)
    runs-on: ubuntu-latest
    needs: configure-instance
    if: needs.check-prerequisites.outputs.can_proceed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (local)
        run: |
          docker build -t juice-shop:ci-latest .

      - name: Save image to tar (so we can SCP it to host)
        run: |
          docker save juice-shop:ci-latest -o juice-shop-image.tar

      - name: Upload image to EC2
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          scp -o ServerAliveInterval=60 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa juice-shop-image.tar ubuntu@${{ env.EC2_INSTANCE_IP }}:/tmp/juice-shop-image.tar

      - name: Load image on remote host
        run: |
          ssh -o ServerAliveInterval=60 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} <<'SSH'
            set -e
            sudo docker load -i /tmp/juice-shop-image.tar || true
            sudo rm -f /tmp/juice-shop-image.tar
          SSH

  scenario1-iast-only:
    name: ðŸ”¬ Scenario 1 - IAST Only (Detection)
    runs-on: ubuntu-latest
    needs: [check-prerequisites, configure-instance, build-and-upload-image]
    if: |
      always() &&
      needs.check-prerequisites.outputs.can_proceed == 'true' &&
      (github.event.inputs.run_scenario == 'both' || github.event.inputs.run_scenario == 'iast-only' || github.event.inputs.run_scenario == '')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Copy IAST config to host and prepare clean state
        run: |
          scp -o ServerAliveInterval=60 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ansible/files/../playbook.yml /dev/null || true
          # copy the config to host
          scp -o ServerAliveInterval=60 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ansible/../{{' '}} || true
          # Use repo config file that playbook created earlier
          scp -o ServerAliveInterval=60 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ansible/../playbook.yml ubuntu@${{ env.EC2_INSTANCE_IP }}:/tmp/playbook.yml || true

      - name: Deploy IAST config and run deploy.sh (reuses same image)
        run: |
          ssh -o ServerAliveInterval=60 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} bash -s << 'DEPLOY'
            set -e
            # Ensure a clean Docker state
            docker ps -q --filter "name=juice-shop" | xargs -r docker stop || true
            docker ps -a -q --filter "name=juice-shop" | xargs -r docker rm -f || true
            docker images -q "juice-shop*" | xargs -r docker rmi -f || true
            docker system prune -af || true

            # Copy IAST config into active config.json (playbook created file under /opt/juice-shop/config)
            if [ -f /opt/juice-shop/config/config-iast.json ]; then
              cp /opt/juice-shop/config/config-iast.json /opt/juice-shop/config/config.json
            else
              echo '{"mode":"iast","aikido_enabled":false,"datadog":{"apm":true,"iast":true},"rasp":{"block":false}}' > /opt/juice-shop/config/config.json
            fi
            chown ubuntu:ubuntu /opt/juice-shop/config/config.json || true

            # Run deploy script (build uses local image if present)
            cd /opt/juice-shop
            ./deploy.sh
          DEPLOY

      - name: Run DAST & attack phases for Scenario 1 (local runner)
        run: |
          echo "Running ZAP baseline and full scan (IAST only)"
          # Baseline
          docker run --rm -v $(pwd):/zap/wrk:rw ghcr.io/zaproxy/zaproxy:stable zap-baseline.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 -J scenario1-baseline.json -r scenario1-baseline.html || true
          scp -o ServerAliveInterval=60 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa scenario1-baseline.json ubuntu@${{ env.EC2_INSTANCE_IP }}:/opt/security-metrics/zap-results/scenario1_baseline.json || true

          # Full
          docker run --rm -v $(pwd):/zap/wrk:rw ghcr.io/zaproxy/zaproxy:stable zap-full-scan.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 -J scenario1-full.json -r scenario1-full.html -m 5 -T 180 || true
          scp -o ServerAliveInterval=60 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa scenario1-full.json ubuntu@${{ env.EC2_INSTANCE_IP }}:/opt/security-metrics/zap-results/scenario1_full.json || true

      - name: Collect Scenario 1 Metrics
        run: |
          ssh -o ServerAliveInterval=60 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'COLLECT'
            echo "SCENARIO 1 METRICS"
            curl -s http://localhost:9999/metrics | grep 'scenario="iast"' || true
            curl -s http://localhost:9999/metrics | grep 'security_detections_total' || true
          COLLECT

      - name: Upload Scenario 1 Results
        uses: actions/upload-artifact@v4
        with:
          name: scenario1-iast-only-results
          path: |
            scenario1-*.json
            scenario1-*.html

  scenario2-iast-rasp:
    name: ðŸ›¡ï¸ Scenario 2 - IAST + RASP (Detection + Blocking)
    runs-on: ubuntu-latest
    needs:
      [
        check-prerequisites,
        configure-instance,
        build-and-upload-image,
        scenario1-iast-only,
      ]
    if: |
      always() &&
      needs.check-prerequisites.outputs.can_proceed == 'true' &&
      (github.event.inputs.run_scenario == 'both' || github.event.inputs.run_scenario == 'iast-rasp' || github.event.inputs.run_scenario == '')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Deploy RASP config and run deploy.sh (reuses same image)
        run: |
          ssh -o ServerAliveInterval=60 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} bash -s << 'DEPLOY'
            set -e
            # Clean docker
            docker ps -q --filter "name=juice-shop" | xargs -r docker stop || true
            docker ps -a -q --filter "name=juice-shop" | xargs -r docker rm -f || true
            docker images -q "juice-shop*" | xargs -r docker rmi -f || true
            docker system prune -af || true

            # Copy rasp config into active config.json
            if [ -f /opt/juice-shop/config/config-rasp.json ]; then
              cp /opt/juice-shop/config/config-rasp.json /opt/juice-shop/config/config.json
            else
              echo '{"mode":"rasp","aikido_enabled":true,"datadog":{"apm":true,"iast":true},"rasp":{"block":true,"debug":true}}' > /opt/juice-shop/config/config.json
            fi
            chown ubuntu:ubuntu /opt/juice-shop/config/config.json || true

            cd /opt/juice-shop
            ./deploy.sh
          DEPLOY

      - name: Run DAST & attack phases for Scenario 2 (local runner)
        run: |
          echo "Running ZAP baseline and full scan (IAST + RASP)"
          # Baseline
          docker run --rm -v $(pwd):/zap/wrk:rw ghcr.io/zaproxy/zaproxy:stable zap-baseline.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 -J scenario2-baseline.json -r scenario2-baseline.html || true
          scp -o ServerAliveInterval=60 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa scenario2-baseline.json ubuntu@${{ env.EC2_INSTANCE_IP }}:/opt/security-metrics/zap-results/scenario2_baseline.json || true

          # Full
          docker run --rm -v $(pwd):/zap/wrk:rw ghcr.io/zaproxy/zaproxy:stable zap-full-scan.py -t http://${{ env.EC2_INSTANCE_IP }}:3000 -J scenario2-full.json -r scenario2-full.html -m 5 -T 180 || true
          scp -o ServerAliveInterval=60 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa scenario2-full.json ubuntu@${{ env.EC2_INSTANCE_IP }}:/opt/security-metrics/zap-results/scenario2_full.json || true

          # Simulated attacks to observe RASP blocking (the host should log blocks)
          for i in {1..20}; do
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=<script>alert(1)</script>" >/dev/null || echo "Blocked?"
            curl -s "http://${{ env.EC2_INSTANCE_IP }}:3000/rest/products/search?q=' OR '1'='1" >/dev/null || echo "Blocked?"
            sleep 2
          done

      - name: Collect Scenario 2 Metrics
        run: |
          ssh -o ServerAliveInterval=60 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'COLLECT'
            echo "SCENARIO 2 METRICS"
            curl -s http://localhost:9999/metrics | grep 'scenario="rasp"' || true
            curl -s http://localhost:9999/metrics | grep 'security_detections_total' || true
            docker logs juice-shop --tail 50 | grep -i "aikido\|blocked\|rasp" || true
          COLLECT

      - name: Upload Scenario 2 Results
        uses: actions/upload-artifact@v4
        with:
          name: scenario2-iast-rasp-results
          path: |
            scenario2-*.json
            scenario2-*.html

  generate-comparison-report:
    name: ðŸ“Š Generate Comparison Report
    runs-on: ubuntu-latest
    needs: [scenario1-iast-only, scenario2-iast-rasp]
    if: always()
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Query Prometheus for Comparative Metrics
        run: |
          ssh -o ServerAliveInterval=60 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_INSTANCE_IP }} << 'QUERY' > comparison-metrics.txt
            echo "COMPARATIVE ANALYSIS: IAST vs IAST+RASP"
            echo ""
            curl -s 'http://localhost:9090/api/v1/query?query=sum(security_detections_total{tool="datadog_iast"})' | jq -r '.data.result[0].value[1] // "0"' | xargs echo "IAST Total Detections:"
            curl -s 'http://localhost:9090/api/v1/query?query=sum(security_blocks_total{tool="aikido_rasp"})' | jq -r '.data.result[0].value[1] // "0"' | xargs echo "RASP Total Blocks:"
            echo ""
            echo "Full metrics exported to file."
          QUERY
          cat comparison-metrics.txt

      - name: Generate Summary Report
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ”’ IAST vs RASP Comparison Analysis
          **Pipeline Run:** #${{ github.run_number }}
          **Instance:** ${{ env.EC2_INSTANCE_IP }}

          - Scenario 1: IAST Only -> artifact: scenario1-iast-only-results
          - Scenario 2: IAST + RASP -> artifact: scenario2-iast-rasp-results

          EOF

      - name: Upload Final Comparison Report
        uses: actions/upload-artifact@v4
        with:
          name: comparison-analysis-report
          path: |
            comparison-metrics.txt
