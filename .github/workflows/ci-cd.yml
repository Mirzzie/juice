name: DevSecOps CI/CD Pipeline

on:
    push:
        branches: ["main", "dev-test"]
    workflow_dispatch: {}
    schedule:
        - cron: "0 4 * * *"

env:
    EC2_INSTANCE_IP: ${{ secrets.EC2_INSTANCE_IP }}
    EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

jobs:
    # 1. SAST
    sast:
        name: SAST - Semgrep Analysis
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: Run Semgrep
              run: |
                  pip install semgrep
                  semgrep scan --config=auto --json --output=semgrep-results.json || true
            - uses: actions/upload-artifact@v4
              with:
                  name: semgrep-results
                  path: semgrep-results.json

    # 2. DEPLOY
    deploy:
        name: Deploy and Config
        runs-on: ubuntu-latest
        needs: sast
        steps:
            - uses: actions/checkout@v3

            - name: Setup SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan -H "$EC2_INSTANCE_IP" >> ~/.ssh/known_hosts

            - name: Install Ansible
              run: sudo apt-get install -y ansible sshpass

            - name: Create Inventory
              run: |
                  echo "[juiceshop]" > inventory.ini
                  echo "$EC2_INSTANCE_IP ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa" >> inventory.ini

            - name: Run Ansible Playbook
              run: |
                  ansible-playbook -i inventory.ini ansible/playbook.yml \
                  -e "datadog_api_key=${{ secrets.DATADOG_API_KEY }}" \
                  -e "datadog_app_key=${{ secrets.DATADOG_APP_KEY }}" \
                  -e "datadog_site='us5.datadoghq.com'" \
                  -e "aikido_token=${{ secrets.ZEN_FIREWALL_TOKEN }}"

    # 3. VERIFY
    verify-security:
        name: Verify - DAST and RASP Experiment
        runs-on: ubuntu-latest
        needs: deploy
        steps:
            - name: Setup Tools
              run: |
                  sudo apt-get update && sudo apt-get install -y apache2-utils
                  mkdir -p ~/.ssh
                  echo "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan -H "$EC2_INSTANCE_IP" >> ~/.ssh/known_hosts

            # Health Check
            - name: Wait for Juice Shop to Start
              run: |
                  echo "Waiting for application to listen on port 3000..."
                  timeout=300
                  elapsed=0
                  interval=10

                  while ! curl -s --head "http://${EC2_INSTANCE_IP}:3000" > /dev/null; do
                    echo "App not ready yet... waiting (${elapsed}s)"
                    sleep $interval
                    elapsed=$((elapsed + interval))
                    if [ $elapsed -ge $timeout ]; then
                      echo "Timed out waiting for Juice Shop!"
                      exit 1
                    fi
                  done
                  echo "Application is UP! Starting Security Tests."

            # Standard DAST
            - name: Run ZAP Baseline Scan
              run: |
                  docker run --network=host ghcr.io/zaproxy/zaproxy:stable \
                  zap-baseline.py -t "http://${EC2_INSTANCE_IP}:3000" -m 5 -a -j || true

            # Scenario 1
            - name: Scenario 1 - Baseline (IAST Only)
              run: |
                  echo "Switching to Baseline Mode..."
                  ssh ubuntu@$EC2_INSTANCE_IP "/home/ubuntu/run_scenario.sh baseline"

                  echo "Generating Traffic..."
                  ab -n 100 -c 5 "http://${EC2_INSTANCE_IP}:3000/rest/products/search?q=apple"

                  echo "Injecting SQLi (Should PASS - 200 OK)..."
                  for i in {1..20}; do curl -s -o /dev/null "http://${EC2_INSTANCE_IP}:3000/rest/products/search?q='%20OR%201=1--"; done

            # Scenario 2
            - name: Scenario 2 - RASP Detection
              run: |
                  echo "Switching to Detection Mode..."
                  ssh ubuntu@$EC2_INSTANCE_IP "/home/ubuntu/run_scenario.sh detection"

                  echo "Generating Traffic..."
                  ab -n 100 -c 5 "http://${EC2_INSTANCE_IP}:3000/rest/products/search?q=banana"

                  echo "Injecting XSS (Should PASS but Log)..."
                  for i in {1..20}; do curl -s -o /dev/null "http://${EC2_INSTANCE_IP}:3000/rest/products/search?q=<script>alert(1)</script>"; done

            # Scenario 3
            - name: Scenario 3 - RASP Blocking
              run: |
                  echo "Switching to Blocking Mode..."
                  ssh ubuntu@$EC2_INSTANCE_IP "/home/ubuntu/run_scenario.sh blocking"

                  echo "Generating Load (Measuring Latency Overhead)..."
                  ab -n 200 -c 10 "http://${EC2_INSTANCE_IP}:3000/rest/products/search?q=orange"

                  echo "Injecting SQLi (Should FAIL - 403 Forbidden)..."
                  BLOCKED_COUNT=0
                  for i in {1..20}; do
                     CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://${EC2_INSTANCE_IP}:3000/rest/products/search?q='%20OR%201=1--")
                     if [ "$CODE" == "403" ]; then ((BLOCKED_COUNT++)); fi
                  done

                  echo "Attacks Blocked: $BLOCKED_COUNT / 20"

                  if [ "$BLOCKED_COUNT" -lt 5 ]; then
                    echo "FAILED: RASP did not block enough attacks!"
                    exit 1
                  fi

            - name: Pipeline Complete
              run: echo "Thesis Data Generated. View Dashboard at http://${EC2_INSTANCE_IP}:3001"
